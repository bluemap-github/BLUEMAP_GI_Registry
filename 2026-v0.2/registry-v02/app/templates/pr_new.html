{% extends "base.html" %}

{% block title %}New PR Item{% endblock %}

{% block extra_styles %}
<style>
    *{margin:0;padding:0;box-sizing:border-box}
    :root{--primary:#2563eb;--primary-hover:#1d4ed8;--bg:#f8fafc;--card:#fff;--text:#1e293b;--muted:#64748b;--border:#e2e8f0;--radius:12px;--danger:#ef4444;--success:#10b981}
    body{font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,Arial,sans-serif;background:var(--bg);color:var(--text);line-height:1.6}
    .container{max-width:1100px;margin:0 auto;padding:24px}
    .breadcrumb{display:flex;align-items:center;gap:8px;font-size:14px;color:var(--muted);margin-bottom:14px}
    .breadcrumb a{color:var(--muted);text-decoration:none}
    .breadcrumb a:hover{color:var(--primary)}
    .top{display:flex;justify-content:space-between;align-items:flex-start;gap:12px;flex-wrap:wrap;margin-bottom:16px}
    .title h1{font-size:28px;font-weight:900}
    .title .sub{font-size:14px;color:var(--muted)}
    .banner{border:1px solid rgba(37,99,235,.25);background:rgba(37,99,235,.08);color:#1e40af;border-radius:12px;padding:10px 12px;margin-bottom:12px;font-weight:700}
    .card{background:var(--card);border:1px solid var(--border);border-radius:var(--radius);overflow:hidden;margin-bottom:12px}
    .card-h{padding:12px 16px;border-bottom:1px solid var(--border);background:#fafbff;font-weight:900;display:flex;justify-content:space-between;align-items:center;gap:10px}
    .card-b{padding:14px 16px}
    .grid{display:grid;grid-template-columns:1fr 1fr;gap:12px}
    @media(max-width:900px){.grid{grid-template-columns:1fr}}
    label{font-size:13px;color:var(--muted);font-weight:800;display:block;margin-bottom:4px}
    .req{color:var(--danger)}
    input,select,textarea{width:100%;padding:10px 12px;border:1px solid var(--border);border-radius:10px;font-size:14px;background:#fff;color:var(--text)}
    textarea{min-height:96px;resize:vertical}
    input:focus,select:focus,textarea:focus{outline:none;border-color:rgba(37,99,235,.7);box-shadow:0 0 0 3px rgba(37,99,235,.12)}
    .hint{font-size:12px;color:var(--muted);margin-top:6px}
    .actions{display:flex;gap:10px;flex-wrap:wrap;justify-content:flex-end;margin-top:10px}
    .btn{display:inline-flex;align-items:center;justify-content:center;gap:8px;padding:10px 14px;border-radius:10px;border:1px solid var(--border);background:#fff;color:var(--text);font-weight:900;cursor:pointer;text-decoration:none}
    .btn.primary{background:var(--primary);border-color:var(--primary);color:#fff}
    .btn.primary:hover{background:var(--primary-hover)}
    .btn.ghost:hover{border-color:rgba(37,99,235,.35);color:var(--primary)}

    /* Dynamic list sections */
    .dyn{border:1px solid var(--border);border-radius:12px;overflow:hidden}
    .dyn-h{display:flex;justify-content:space-between;align-items:center;padding:10px 12px;background:var(--bg);border-bottom:1px solid var(--border)}
    .dyn-title{font-size:12px;color:var(--muted);font-weight:900;text-transform:uppercase;letter-spacing:.4px}
    .dyn-b{max-height:320px;overflow:auto}
    .dyn-empty{padding:16px 12px;color:var(--muted);font-size:13px;text-align:center}

    /* Toast notification */
    .toast{position:fixed;bottom:22px;right:22px;background:#0f172a;color:#fff;padding:12px 14px;border-radius:12px;opacity:0;transform:translateY(12px);transition:.2s;z-index:9999;font-weight:800}
    .toast.show{opacity:1;transform:translateY(0)}
    .toast.success{background:var(--success)}
    .toast.error{background:var(--danger)}

    /* Relations styling */
    .rel-section{display:none;grid-column:1/-1;}
    .rel-section.active{display:block}
    /* Kind body sections (separate from relations) */
    .kb-section{display:none;grid-column:1/-1;}
    .kb-section.active{display:block}

    /* Multi-select chips UI */
    .multi-select-container{position:relative;z-index:10}
    .multi-select-container:focus-within{z-index:1000}
    .multi-select-chips{display:flex;flex-wrap:wrap;gap:6px;min-height:44px;padding:8px 10px;border:1px solid var(--border);border-radius:10px;background:#fff;cursor:pointer;transition:all .15s}
    .multi-select-chips:hover{border-color:rgba(37,99,235,.4)}
    .multi-select-chips:focus-within{border-color:rgba(37,99,235,.7);box-shadow:0 0 0 3px rgba(37,99,235,.12)}
    .multi-select-chips.empty::after{content:'Click to select...';color:var(--muted);font-size:13px;padding:2px 0}
    .chip{display:inline-flex;align-items:center;gap:4px;padding:4px 8px 4px 10px;background:rgba(37,99,235,.1);color:var(--primary);border-radius:6px;font-size:13px;font-weight:600;animation:chipIn .15s ease}
    @keyframes chipIn{from{opacity:0;transform:scale(.9)}to{opacity:1;transform:scale(1)}}
    .chip-remove{display:flex;align-items:center;justify-content:center;width:18px;height:18px;border-radius:50%;background:transparent;border:none;color:var(--primary);cursor:pointer;font-size:14px;line-height:1;transition:all .15s}
    .chip-remove:hover{background:rgba(37,99,235,.2);color:var(--primary-hover)}
    .multi-select-dropdown{position:fixed;background:#fff;border:1px solid var(--border);border-radius:10px;box-shadow:0 10px 40px rgba(0,0,0,.12);z-index:9999;max-height:240px;overflow:hidden;display:none}
    .multi-select-dropdown.open{display:block;animation:dropIn .15s ease}
    @keyframes dropIn{from{opacity:0;transform:translateY(-8px)}to{opacity:1;transform:translateY(0)}}
    .multi-select-search{padding:10px 12px;border-bottom:1px solid var(--border)}
    .multi-select-search input{width:100%;padding:8px 10px;border:1px solid var(--border);border-radius:8px;font-size:13px}
    .multi-select-search input:focus{outline:none;border-color:var(--primary)}
    .multi-select-options{max-height:180px;overflow-y:auto}
    .multi-select-option{display:flex;align-items:center;gap:10px;padding:10px 12px;cursor:pointer;transition:background .1s;font-size:13px}
    .multi-select-option:hover{background:rgba(37,99,235,.06)}
    .multi-select-option.selected{background:rgba(37,99,235,.1);color:var(--primary);font-weight:600}
    .multi-select-option-check{width:18px;height:18px;border:2px solid var(--border);border-radius:4px;display:flex;align-items:center;justify-content:center;transition:all .15s;flex-shrink:0}
    .multi-select-option.selected .multi-select-option-check{background:var(--primary);border-color:var(--primary);color:#fff}
    .multi-select-empty{padding:16px 12px;text-align:center;color:var(--muted);font-size:13px}

    /* File upload styling */
    .file-upload-section{display:none;grid-column:1/-1;}
    .file-upload-section.active{display:block}
    .file-drop{border:2px dashed var(--border);border-radius:12px;padding:24px;text-align:center;cursor:pointer;transition:all .2s;background:#fafbff}
    .file-drop:hover,.file-drop.dragover{border-color:var(--primary);background:rgba(37,99,235,.04)}
    .file-drop-icon{font-size:32px;color:var(--muted);margin-bottom:8px}
    .file-drop-text{font-size:14px;color:var(--muted)}
    .file-drop-text strong{color:var(--primary);cursor:pointer}
    .file-list{margin-top:12px}
    .file-item{display:flex;align-items:center;justify-content:space-between;padding:10px 12px;background:#fff;border:1px solid var(--border);border-radius:8px;margin-bottom:8px}
    .file-item-info{display:flex;align-items:center;gap:10px}
    .file-item-icon{width:36px;height:36px;background:var(--bg);border-radius:8px;display:flex;align-items:center;justify-content:center;color:var(--primary);font-size:16px}
    .file-item-details{font-size:13px}
    .file-item-name{font-weight:700;color:var(--text)}
    .file-item-size{color:var(--muted);font-size:12px}
    .file-item-status{font-size:12px;padding:4px 8px;border-radius:6px;font-weight:700}
    .file-item-status.pending{background:#fef3c7;color:#92400e}
    .file-item-status.uploading{background:#dbeafe;color:#1d4ed8}
    .file-item-status.done{background:#d1fae5;color:#065f46}
    .file-item-status.error{background:#fee2e2;color:#991b1b}
    .file-item-remove{background:none;border:none;color:var(--muted);cursor:pointer;padding:4px 8px;font-size:18px}
    .file-item-remove:hover{color:var(--danger)}

    /* Step Wizard Styles */
    .step-wizard {
      display: flex;
      justify-content: center;
      align-items: center;
      margin-bottom: 24px;
      gap: 0;
    }
    .step-item {
      display: flex;
      align-items: center;
      gap: 8px;
    }
    .step-circle {
      width: 36px;
      height: 36px;
      border-radius: 50%;
      background: var(--border);
      color: var(--muted);
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: 900;
      font-size: 14px;
      transition: all 0.3s ease;
    }
    .step-item.active .step-circle {
      background: var(--primary);
      color: #fff;
    }
    .step-item.completed .step-circle {
      background: var(--success);
      color: #fff;
    }
    .step-label {
      font-size: 13px;
      font-weight: 700;
      color: var(--muted);
      transition: color 0.3s ease;
    }
    .step-item.active .step-label {
      color: var(--primary);
    }
    .step-item.completed .step-label {
      color: var(--success);
    }
    .step-connector {
      width: 60px;
      height: 3px;
      background: var(--border);
      margin: 0 12px;
      transition: background 0.3s ease;
    }
    .step-connector.completed {
      background: var(--success);
    }

    /* Step Content */
    .step-content {
      display: none;
    }
    .step-content.active {
      display: block;
    }

    /* Step Navigation Buttons */
    .step-nav {
      display: flex;
      justify-content: space-between;
      margin-top: 20px;
      padding-top: 16px;
      border-top: 1px solid var(--border);
    }
    .step-nav .btn {
      min-width: 120px;
    }

    /* refs */
    .dyn-item{display:flex;gap:10px;align-items:flex-start;padding:10px 12px;border-bottom:1px solid var(--border)}
    .dyn-item:last-child{border-bottom:none}
    .num{width:22px;height:22px;border-radius:999px;background:var(--primary);color:#fff;display:flex;align-items:center;justify-content:center;font-weight:900;font-size:12px;flex:0 0 auto;margin-top:2px}
    .remove{border:none;background:transparent;color:var(--danger);font-weight:900;cursor:pointer;padding:6px 8px;border-radius:8px}
    .remove:hover{background:rgba(239,68,68,.08)}

    /* New Source Fields (hidden by default) */
    .new-source-fields {
      display: none;
      grid-column: 1 / -1;
    }
    .new-source-fields.show {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 12px;
    }
</style>
{% endblock %}

{% block content %}
<div class="container">
    <nav class="breadcrumb">
      <a href="/">Home</a><span>/</span>
      <a href="/ui/pr">Portrayal Register</a><span>/</span>
      <span>New</span>
    </nav>

    <div class="top">
      <div class="title">
        <h1>Create Portrayal Item</h1>
        <div class="sub">S-100 Portrayal Register item creation</div>
      </div>
      <div class="actions">
        <a class="btn ghost" href="/ui/pr">Back</a>
      </div>
    </div>

    <div class="banner" id="sampleMsg" style="display:none;"></div>

    <!-- Step Wizard -->
    <div class="step-wizard">
      <div class="step-item active" data-step="1">
        <div class="step-circle">1</div>
        <span class="step-label">Basic Info</span>
      </div>
      <div class="step-connector"></div>
      <div class="step-item" data-step="2">
        <div class="step-circle">2</div>
        <span class="step-label">PR Item & Kind</span>
      </div>
      <div class="step-connector"></div>
      <div class="step-item" data-step="3">
        <div class="step-circle">3</div>
        <span class="step-label">References</span>
      </div>
    </div>

    <form id="form">
      <!-- Step 1: Management Information + Basic -->
      <div class="step-content active" data-step="1">
        <div class="card">
          <div class="card-h">Management Information</div>
          <div class="card-b">
            <div class="grid">
              <div>
                <label>Proposal Type</label>
                <input id="mi_proposalType" value="Addition" />
              </div>
              <div>
                <label>Submitting Organisation</label>
                <input id="mi_submittingOrganisation" placeholder="Organisation" />
              </div>
              <div style="grid-column:1/-1;">
                <label>Proposed Change</label>
                <textarea id="mi_proposedChange" placeholder="What changed / why"></textarea>
              </div>
              <div>
                <label>Proposal Status</label>
                <input id="mi_proposalStatus" value="Draft" />
              </div>
              <div style="grid-column:1/-1;">
                <label>Control Body Notes (one per line)</label>
                <textarea id="mi_controlBodyNotesText" rows="2" placeholder="note1&#10;note2"></textarea>
              </div>
            </div>
          </div>
        </div>

        <div class="card">
          <div class="card-h">Basic</div>
          <div class="card-b">
            <div class="grid">
              <div>
                <label>Register <span class="req">*</span></label>
                <select id="registerId" required>
                  <option value="">(select)</option>
                </select>
              </div>
              <div>
                <label>Kind <span class="req">*</span></label>
                <select id="kind" required>
                  <option value="S100_PR_Symbol">S100_PR_Symbol</option>
                  <option value="S100_PR_LineStyle">S100_PR_LineStyle</option>
                  <option value="S100_PR_AreaFill">S100_PR_AreaFill</option>
                  <option value="S100_PR_Pixmap">S100_PR_Pixmap</option>
                  <option value="S100_PR_ItemSchema">S100_PR_ItemSchema</option>
                  <option value="S100_PR_DisplayMode">S100_PR_DisplayMode</option>
                  <option value="S100_PR_ViewingGroupLayer">S100_PR_ViewingGroupLayer</option>
                  <option value="S100_PR_ViewingGroup">S100_PR_ViewingGroup</option>
                  <option value="S100_PR_AlertHighlight">S100_PR_AlertHighlight</option>
                  <option value="S100_PR_AlertMessage">S100_PR_AlertMessage</option>
                  <option value="S100_PR_ColourToken">S100_PR_ColourToken</option>
                  <option value="S100_PR_ColourPalette">S100_PR_ColourPalette</option>
                  <option value="S100_PR_Alert">S100_PR_Alert</option>
                  <option value="S100_PR_PaletteItem">S100_PR_PaletteItem</option>
                  <option value="S100_PR_Font">S100_PR_Font</option>
                  <option value="S100_PR_ContextParameter">S100_PR_ContextParameter</option>
                  <option value="S100_PR_DrawingPriority">S100_PR_DrawingPriority</option>
                  <option value="S100_PR_DisplayPlane">S100_PR_DisplayPlane</option>
                </select>
              </div>
            </div>
          </div>
        </div>

        <!-- Step Navigation -->
        <div class="step-nav">
          <div></div>
          <button type="button" class="btn primary" onclick="goToStep(2)">Next &rarr;</button>
        </div>
      </div>

      <!-- Step 2: PR Item (Common), Top-level PR Fields, Kind Body, Relations -->
      <div class="step-content" data-step="2">
        <button type="button" class="btn ghost" id="fillSample" style="margin-bottom:12px;">Fill Sample</button>

        <!-- PR Item (Common) Card -->
      <div class="card">
        <div class="card-h">PR Item (Common)</div>
        <div class="card-b">
          <div class="grid">
            <div style="grid-column:1/-1;">
              <label>Name <span class="req">*</span></label>
              <input id="name" required placeholder="Enter name" />
            </div>
            <div style="grid-column:1/-1;">
              <label>Definition</label>
              <textarea id="definition" placeholder="Definition (optional)"></textarea>
            </div>
            <div style="grid-column:1/-1;">
              <label>Remarks</label>
              <textarea id="remarks" placeholder="Remarks (optional)"></textarea>
            </div>
            <div>
              <label>Item Status</label>
              <input id="itemStatus" value="Draft" />
            </div>
            <div>
              <label>Alias (comma separated)</label>
              <input id="alias" placeholder="e.g., alias1, alias2" />
            </div>
            <div>
              <label>CamelCase</label>
              <input id="camelCase" placeholder="camelCase" />
            </div>
            <div>
              <label>Definition Source</label>
              <input id="definitionSource" placeholder="e.g., S-101" />
            </div>
            <div>
              <label>Reference</label>
              <input id="reference" placeholder="optional" />
            </div>
            <div>
              <label>Similarity To Source</label>
              <input id="similarityToSource" placeholder="optional" />
            </div>
            <div style="grid-column:1/-1;">
              <label>Justification</label>
              <textarea id="justification" placeholder="optional"></textarea>
            </div>
            <div style="grid-column:1/-1;">
              <label>Proposed Change</label>
              <textarea id="proposedChange" placeholder="optional"></textarea>
            </div>
          </div>
        </div>
      </div>

      <!-- Top-level PR Fields Card -->
      <div class="card">
        <div class="card-h">Top-level PR Fields</div>
        <div class="card-b">
          <div class="grid">
            <div>
              <label>XML ID</label>
              <input id="xmlID" placeholder="e.g., S100_PR_Symbol_SAMPLE" />
            </div>
            <div style="grid-column:1/-1;">
              <label>Description</label>
              <div class="dyn" id="descDyn">
                <div class="dyn-h">
                  <div class="dyn-title">description items</div>
                  <button class="btn ghost" type="button" id="descAdd">+ Add</button>
                </div>
                <div class="dyn-b" id="descList">
                  <div class="dyn-empty">No description items</div>
                </div>
              </div>
              <div class="hint">Each item is {text, language}</div>
            </div>
          </div>
        </div>
      </div>

      <!-- Optional Links (Visual Kinds) Card -->
      <div class="card" id="optionalLinksCard" style="display:none;">
        <div class="card-h">Optional Links (Visual Kinds)</div>
        <div class="card-b">
          <div class="grid">
            <div>
              <label>Item Schema (0..1)</label>
              <div class="multi-select-container" data-target="itemSchemaSel" data-single="true">
                <div class="multi-select-chips empty" tabindex="0"></div>
                <div class="multi-select-dropdown">
                  <div class="multi-select-search"><input type="text" placeholder="Search..." /></div>
                  <div class="multi-select-options"></div>
                </div>
              </div>
              <select id="itemSchemaSel" style="display:none"></select>
            </div>
            <div>
              <label>Colour Token (multi)</label>
              <div class="multi-select-container" data-target="colourTokenSel">
                <div class="multi-select-chips empty" tabindex="0"></div>
                <div class="multi-select-dropdown">
                  <div class="multi-select-search"><input type="text" placeholder="Search..." /></div>
                  <div class="multi-select-options"></div>
                </div>
              </div>
              <select id="colourTokenSel" multiple style="display:none"></select>
            </div>
          </div>
          <div class="hint">Visual kinds: Symbol / LineStyle / AreaFill / Pixmap</div>
        </div>
      </div>

      <!-- File Upload Card (for file-based kinds) -->
      <div class="card" id="fileUploadCard" style="display:none;">
        <div class="card-h">
          <span>File Upload</span>
          <span class="hint" style="margin:0;font-weight:500;">Required for this kind</span>
        </div>
        <div class="card-b">
          <div class="grid">
            <!-- itemDetail file -->
            <div id="fileUpload_itemDetail" class="file-upload-section">
              <label>Item Detail File <span class="req">*</span></label>
              <div class="file-drop" data-target="itemDetail">
                <div class="file-drop-icon">üìÅ</div>
                <div class="file-drop-text">Drag & drop file here or <strong>browse</strong></div>
              </div>
              <input type="file" id="file_itemDetail" style="display:none" />
              <div class="file-list" id="fileList_itemDetail"></div>
              <div class="hint">SVG, XML, or binary file for the item detail</div>
            </div>

            <!-- previewImage file -->
            <div id="fileUpload_previewImage" class="file-upload-section">
              <label>Preview Image</label>
              <div class="file-drop" data-target="previewImage">
                <div class="file-drop-icon">üñºÔ∏è</div>
                <div class="file-drop-text">Drag & drop image or <strong>browse</strong></div>
              </div>
              <input type="file" id="file_previewImage" accept="image/*" style="display:none" />
              <div class="file-list" id="fileList_previewImage"></div>
              <div class="hint">PNG, JPG, or TIF preview image</div>
            </div>

            <!-- engineeringImage file -->
            <div id="fileUpload_engineeringImage" class="file-upload-section">
              <label>Engineering Image</label>
              <div class="file-drop" data-target="engineeringImage">
                <div class="file-drop-icon">üñºÔ∏è</div>
                <div class="file-drop-text">Drag & drop image or <strong>browse</strong></div>
              </div>
              <input type="file" id="file_engineeringImage" accept="image/*" style="display:none" />
              <div class="file-list" id="fileList_engineeringImage"></div>
              <div class="hint">PNG, JPG, or TIF engineering image</div>
            </div>

            <!-- xmlSchema file (for ItemSchema) -->
            <div id="fileUpload_xmlSchema" class="file-upload-section">
              <label>XML Schema File <span class="req">*</span></label>
              <div class="file-drop" data-target="xmlSchema">
                <div class="file-drop-icon">üìÑ</div>
                <div class="file-drop-text">Drag & drop XSD file or <strong>browse</strong></div>
              </div>
              <input type="file" id="file_xmlSchema" accept=".xsd,.xml" style="display:none" />
              <div class="file-list" id="fileList_xmlSchema"></div>
              <div class="hint">XSD schema file</div>
            </div>

            <!-- fontFile (for Font) -->
            <div id="fileUpload_fontFile" class="file-upload-section">
              <label>Font File <span class="req">*</span></label>
              <div class="file-drop" data-target="fontFile">
                <div class="file-drop-icon">üî§</div>
                <div class="file-drop-text">Drag & drop font file or <strong>browse</strong></div>
              </div>
              <input type="file" id="file_fontFile" accept=".ttf,.otf,.woff,.woff2" style="display:none" />
              <div class="file-list" id="fileList_fontFile"></div>
              <div class="hint">TTF, OTF, WOFF, or WOFF2 font file</div>
            </div>
          </div>
        </div>
      </div>

      <!-- Relations Card -->
      <div class="card">
        <div class="card-h">Relations (ObjId / ObjId[] fields)</div>
        <div class="card-b">
          <div class="grid">
            <!-- LineStyle / AreaFill: symbol [0..1] -->
            <div id="relLineArea" class="rel-section">
              <label>Symbol (0..1) - For LineStyle / AreaFill</label>
              <div class="multi-select-container" data-target="symbolSel" data-single="true">
                <div class="multi-select-chips empty" tabindex="0"></div>
                <div class="multi-select-dropdown">
                  <div class="multi-select-search"><input type="text" placeholder="Search..." /></div>
                  <div class="multi-select-options"></div>
                </div>
              </div>
              <select id="symbolSel" style="display:none"></select>
            </div>

            <!-- ViewingGroupLayer: displayMode[] -->
            <div id="relViewingGroupLayer" class="rel-section">
              <label>Display Mode (multi) - For ViewingGroupLayer</label>
              <div class="multi-select-container" data-target="displayModeSel">
                <div class="multi-select-chips empty" tabindex="0"></div>
                <div class="multi-select-dropdown">
                  <div class="multi-select-search"><input type="text" placeholder="Search..." /></div>
                  <div class="multi-select-options"></div>
                </div>
              </div>
              <select id="displayModeSel" multiple style="display:none"></select>
            </div>

            <!-- ViewingGroup: foundationMode + viewingGroup[] -->
            <div id="relViewingGroup" class="rel-section">
              <label style="display:flex;align-items:center;gap:8px;">
                <input id="foundationMode" type="checkbox" style="width:auto;" />
                <span>Foundation Mode</span>
              </label>
              <div style="margin-top:12px;">
                <label>Viewing Group Layer (multi)</label>
                <div class="multi-select-container" data-target="viewingGroupLayerSel">
                  <div class="multi-select-chips empty" tabindex="0"></div>
                  <div class="multi-select-dropdown">
                    <div class="multi-select-search"><input type="text" placeholder="Search..." /></div>
                    <div class="multi-select-options"></div>
                  </div>
                </div>
                <select id="viewingGroupLayerSel" multiple style="display:none"></select>
              </div>
            </div>

            <!-- AlertHighlight -->
            <div id="relAlertHighlight" class="rel-section">
              <label style="display:flex;align-items:center;gap:8px;">
                <input id="ah_optional" type="checkbox" style="width:auto;" />
                <span>Optional</span>
              </label>
              <div class="grid" style="margin-top:12px;">
                <div>
                  <label>Style</label>
                  <select id="ah_style">
                    <option value="AlarmHighlight">AlarmHighlight</option>
                    <option value="CautionHighlight">CautionHighlight</option>
                  </select>
                </div>
              </div>
              <div style="margin-top:12px;">
                <label>Viewing Group (multi)</label>
                <div class="multi-select-container" data-target="ah_viewingGroupSel">
                  <div class="multi-select-chips empty" tabindex="0"></div>
                  <div class="multi-select-dropdown">
                    <div class="multi-select-search"><input type="text" placeholder="Search..." /></div>
                    <div class="multi-select-options"></div>
                  </div>
                </div>
                <select id="ah_viewingGroupSel" multiple style="display:none"></select>
              </div>
              <div style="margin-top:12px;">
                <label>Alert Message (0..1)</label>
                <div class="multi-select-container" data-target="ah_msgSel" data-single="true">
                  <div class="multi-select-chips empty" tabindex="0"></div>
                  <div class="multi-select-dropdown">
                    <div class="multi-select-search"><input type="text" placeholder="Search..." /></div>
                    <div class="multi-select-options"></div>
                  </div>
                </div>
                <select id="ah_msgSel" style="display:none"></select>
              </div>
            </div>

            <!-- AlertMessage: icon -->
            <div id="relAlertMessage" class="rel-section">
              <label>Icon (Symbol) (0..1)</label>
              <div class="multi-select-container" data-target="iconSel" data-single="true">
                <div class="multi-select-chips empty" tabindex="0"></div>
                <div class="multi-select-dropdown">
                  <div class="multi-select-search"><input type="text" placeholder="Search..." /></div>
                  <div class="multi-select-options"></div>
                </div>
              </div>
              <select id="iconSel" style="display:none"></select>
            </div>

            <!-- ColourToken -->
            <div id="relColourToken" class="rel-section">
              <div>
                <label>Token</label>
                <input id="ct_token" placeholder="e.g., SAMPLE_TOKEN" />
              </div>
              <div style="margin-top:12px;">
                <label>Value (PaletteItem) (0..1)</label>
                <div class="multi-select-container" data-target="ct_valueSel" data-single="true">
                  <div class="multi-select-chips empty" tabindex="0"></div>
                  <div class="multi-select-dropdown">
                    <div class="multi-select-search"><input type="text" placeholder="Search..." /></div>
                    <div class="multi-select-options"></div>
                  </div>
                </div>
                <select id="ct_valueSel" style="display:none"></select>
              </div>
            </div>

            <!-- PaletteItem -->
            <div id="relPaletteItem" class="rel-section">
              <label>Palette (ColourPalette) (multi)</label>
              <div class="multi-select-container" data-target="pi_paletteSel">
                <div class="multi-select-chips empty" tabindex="0"></div>
                <div class="multi-select-dropdown">
                  <div class="multi-select-search"><input type="text" placeholder="Search..." /></div>
                  <div class="multi-select-options"></div>
                </div>
              </div>
              <select id="pi_paletteSel" multiple style="display:none"></select>
            </div>

            <div class="hint" style="grid-column:1/-1;">Relations are shown based on selected Kind.</div>
          </div>
        </div>
      </div>

      <!-- Kind Body Card -->
      <div class="card">
        <div class="card-h">Kind Body</div>
        <div class="card-b">
          <div class="hint" style="margin-bottom:8px;">Kind-specific fields (auto builds kindBody). Relations above will be auto-injected.</div>

          <!-- Visual common (Symbol/LineStyle/AreaFill/Pixmap) -->
          <div id="kb_visual" class="kb-section">
            <div class="grid">
              <div>
                <label>itemDetail (path)</label>
                <input id="kb_itemDetail" placeholder="s3://... or file path" />
              </div>
              <div>
                <label>previewImage (path)</label>
                <input id="kb_previewImage" placeholder="s3://... or file path" />
              </div>
              <div>
                <label>engineeringImage (path)</label>
                <input id="kb_engineeringImage" placeholder="s3://... or file path" />
              </div>
              <div>
                <label>previewType</label>
                <select id="kb_previewType">
                  <option value="">(none)</option>
                  <option value="jpg">jpg</option>
                  <option value="png">png</option>
                  <option value="tif">tif</option>
                </select>
              </div>
              <div>
                <label>engineeringImageType</label>
                <select id="kb_engineeringImageType">
                  <option value="">(none)</option>
                  <option value="jpg">jpg</option>
                  <option value="png">png</option>
                  <option value="tif">tif</option>
                </select>
              </div>
            </div>
          </div>

          <!-- ItemSchema -->
          <div id="kb_itemSchema" class="kb-section">
            <div class="grid">
              <div>
                <label>schemaKind</label>
                <select id="kb_schemaKind">
                  <option value="S100_PR_SymbolSchema">S100_PR_SymbolSchema</option>
                  <option value="S100_PR_LineStyleSchema">S100_PR_LineStyleSchema</option>
                  <option value="S100_PR_AreaFillSchema">S100_PR_AreaFillSchema</option>
                  <option value="S100_PR_PixmapSchema">S100_PR_PixmapSchema</option>
                  <option value="S100_PR_ColourProfileSchema">S100_PR_ColourProfileSchema</option>
                </select>
              </div>
              <div>
                <label>xmlSchema (path)</label>
                <input id="kb_xmlSchema" placeholder="s3://... or file path" />
              </div>
            </div>
          </div>

          <!-- ViewingGroup -->
          <div id="kb_viewingGroup" class="kb-section">
            <div class="grid">
              <div>
                <label style="display:flex;align-items:center;gap:8px;">
                  <input id="kb_foundationMode" type="checkbox" style="width:auto;" />
                  <span>foundationMode</span>
                </label>
              </div>
            </div>
          </div>

          <!-- AlertMessage -->
          <div id="kb_alertMessage" class="kb-section">
            <label>text (NationalLanguageString list)</label>
            <div class="dyn" id="amTextDyn">
              <div class="dyn-h">
                <div class="dyn-title">alert text items</div>
                <button class="btn ghost" type="button" id="amTextAdd">+ Add</button>
              </div>
              <div class="dyn-b" id="amTextList">
                <div class="dyn-empty">No text items</div>
              </div>
            </div>
            <div class="hint">Each item is {text, language}</div>
          </div>

          <!-- ColourToken -->
          <div id="kb_colourToken" class="kb-section">
            <div class="grid">
              <div>
                <label>token</label>
                <input id="kb_ct_token" placeholder="e.g., DAYWHITE" />
              </div>
            </div>
          </div>

          <!-- PaletteItem -->
          <div id="kb_paletteItem" class="kb-section">
            <div class="grid">
              <div>
                <label>transparency</label>
                <input id="kb_pi_transparency" placeholder="0.0" />
              </div>
              <div>
                <label>sRGB red</label>
                <input id="kb_pi_red" placeholder="0" />
              </div>
              <div>
                <label>sRGB green</label>
                <input id="kb_pi_green" placeholder="0" />
              </div>
              <div>
                <label>sRGB blue</label>
                <input id="kb_pi_blue" placeholder="0" />
              </div>
              <div>
                <label>CIE x</label>
                <input id="kb_pi_x" placeholder="0" />
              </div>
              <div>
                <label>CIE y</label>
                <input id="kb_pi_y" placeholder="0" />
              </div>
              <div>
                <label>CIE z</label>
                <input id="kb_pi_z" placeholder="0" />
              </div>
            </div>
          </div>

          <!-- ContextParameter -->
          <div id="kb_contextParameter" class="kb-section">
            <div class="grid">
              <div>
                <label>parameterType</label>
                <select id="kb_cp_type">
                  <option value="boolean">boolean</option>
                  <option value="integer">integer</option>
                  <option value="double">double</option>
                  <option value="string">string</option>
                  <option value="date">date</option>
                </select>
              </div>
              <div>
                <label>defaultValue</label>
                <input id="kb_cp_default" placeholder="sample" />
              </div>
            </div>
          </div>

          <!-- DrawingPriority -->
          <div id="kb_drawingPriority" class="kb-section">
            <div class="grid">
              <div>
                <label>priority</label>
                <input id="kb_dp_priority" placeholder="1" />
              </div>
            </div>
          </div>

          <!-- DisplayPlane -->
          <div id="kb_displayPlane" class="kb-section">
            <div class="grid">
              <div>
                <label>order</label>
                <input id="kb_plane_order" placeholder="1" />
              </div>
            </div>
          </div>

          <!-- Alert -->
          <div id="kb_alert" class="kb-section">
            <label>routeMonitor priorities</label>
            <div class="dyn" id="rmDyn">
              <div class="dyn-h">
                <div class="dyn-title">routeMonitor</div>
                <button class="btn ghost" type="button" id="rmAdd">+ Add</button>
              </div>
              <div class="dyn-b" id="rmList">
                <div class="dyn-empty">No routeMonitor items</div>
              </div>
            </div>

            <div style="height:12px;"></div>

            <label>routePlan priorities</label>
            <div class="dyn" id="rpDyn">
              <div class="dyn-h">
                <div class="dyn-title">routePlan</div>
                <button class="btn ghost" type="button" id="rpAdd">+ Add</button>
              </div>
              <div class="dyn-b" id="rpList">
                <div class="dyn-empty">No routePlan items</div>
              </div>
            </div>

            <div class="hint">Each item has priority{priority, default, optional}</div>
          </div>

          <!-- Font -->
          <div id="kb_font" class="kb-section">
            <div class="grid">
              <div>
                <label>fontFile (path)</label>
                <input id="kb_font_file" placeholder="s3://.../font.ttf" />
              </div>
              <div>
                <label>fontType</label>
                <input id="kb_font_type" value="ttf" />
              </div>
            </div>
          </div>
        </div>
      </div>

        <!-- Step 2 Navigation -->
        <div class="step-nav">
          <button type="button" class="btn ghost" onclick="goToStep(1)">&larr; Back</button>
          <button type="button" class="btn primary" onclick="goToStep(3)">Next &rarr;</button>
        </div>
      </div>

      <!-- Step 3: References -->
      <div class="step-content" data-step="3">
        <div class="card" id="refsCard">
          <div class="card-h">References</div>
          <div class="card-b">
            <div class="grid">
              <div style="grid-column:1/-1;">
                <label>Reference Source (0..1)</label>
                <select id="refSourceSelect">
                  <option value="">(none)</option>
                  <option value="__new__">+ Create new...</option>
                </select>
                <div class="hint" id="currentRefSourceHint"></div>
              </div>

              <!-- New Source Fields - only shown when "+ Create new‚Ä¶" is selected -->
              <div id="newSourceFields" class="new-source-fields">
                <div>
                  <label>New Source Name <span class="req">*</span></label>
                  <input id="newRefSourceName" placeholder="e.g., S-101 Ed. X.Y" />
                </div>
                <div>
                  <label>New Source Description</label>
                  <input id="newRefSourceDesc" placeholder="optional" />
                </div>
              </div>

              <div style="grid-column:1/-1;">
                <label>References (0..*)</label>
                <div class="dyn">
                  <div class="dyn-h">
                    <div class="dyn-title">REFERENCES</div>
                    <button type="button" class="btn ghost" id="addRefBtn">+ Add</button>
                  </div>
                  <div class="dyn-b" id="refsBody">
                    <div class="dyn-empty">No references</div>
                  </div>
                </div>
                <div class="hint">Í∞Å RowÎäî Ï†ÄÏû• Ïãú Reference Î¨∏ÏÑúÎ°ú ÏÉùÏÑ±ÎêòÍ≥†, Í∑∏ IDÎì§Ïù¥ ItemÏóê Ïó∞Í≤∞Îê©ÎãàÎã§.</div>
              </div>
            </div>
          </div>
        </div>

        <!-- Step 3 Navigation -->
        <div class="step-nav">
          <button type="button" class="btn ghost" onclick="goToStep(2)">&larr; Back</button>
          <button type="submit" class="btn primary" id="submitBtn">Create</button>
        </div>
      </div>

    </form>
  </div>

  <div class="toast" id="toast"></div>
  <div class="toast" id="msg"></div>
{% endblock %}

{% block extra_scripts %}
<script>
  // Step Wizard Variables
  let currentStep = 1;
  const totalSteps = 3;

  function showToast(msg, type='success'){
    const t = document.getElementById('toast');
    t.className = 'toast ' + type;
    t.textContent = msg;
    t.classList.add('show');
    setTimeout(()=>t.classList.remove('show'), 2200);
  }

  // Step Wizard Functions
  function updateStepUI() {
    // Update step indicators
    document.querySelectorAll('.step-item').forEach(item => {
      const step = parseInt(item.dataset.step);
      item.classList.remove('active', 'completed');
      if (step === currentStep) {
        item.classList.add('active');
      } else if (step < currentStep) {
        item.classList.add('completed');
      }
    });

    // Update connectors
    document.querySelectorAll('.step-connector').forEach((connector, idx) => {
      connector.classList.toggle('completed', idx < currentStep - 1);
    });

    // Show/hide step content
    document.querySelectorAll('.step-content').forEach(content => {
      const step = parseInt(content.dataset.step);
      content.classList.toggle('active', step === currentStep);
    });

    // Scroll to top
    window.scrollTo({ top: 0, behavior: 'smooth' });
  }

  function validateStep(step) {
    if (step === 1) {
      const registerId = document.getElementById('registerId').value;
      const kind = document.getElementById('kind').value;
      if (!registerId) {
        showToast('RegisterÎ•º ÏÑ†ÌÉùÌïòÏÑ∏Ïöî.', 'error');
        return false;
      }
      if (!kind) {
        showToast('KindÎ•º ÏÑ†ÌÉùÌïòÏÑ∏Ïöî.', 'error');
        return false;
      }
    }
    if (step === 2) {
      const name = document.getElementById('name').value.trim();
      if (!name) {
        showToast('NameÏùÄ ÌïÑÏàòÏûÖÎãàÎã§.', 'error');
        return false;
      }
    }
    return true;
  }

  function goToStep(step) {
    if (step < 1 || step > totalSteps) return;

    // Validate current step before moving forward
    if (step > currentStep && !validateStep(currentStep)) {
      return;
    }

    currentStep = step;
    updateStepUI();
  }

  // APIÎ°ú Reference Source Ï°∞Ìöå
  async function fetchSourceById(id) {
    if (!id) return null;
    try {
      const res = await fetch(`/api/reference-sources/${id}`);
      if (!res.ok) return null;
      return await res.json();
    } catch (e) {
      console.error('fetchSourceById error:', e);
      return null;
    }
  }

  // APIÎ°ú Reference Ï°∞Ìöå
  async function fetchRefById(id) {
    try {
      const res = await fetch(`/api/references/${id}`);
      if (!res.ok) return { _id: id, title: '(missing)', locator: '' };
      return await res.json();
    } catch (e) {
      return { _id: id, title: '(error)', locator: '' };
    }
  }

  // Add new reference row
  function addRefRow(title = '', locator = '', existingId = null) {
    const body = document.getElementById('refsBody');
    const empty = body.querySelector('.dyn-empty');
    if (empty) empty.remove();

    const idx = body.querySelectorAll('.dyn-item').length + 1;
    const row = document.createElement('div');
    row.className = 'dyn-item';
    if (existingId) row.setAttribute('data-existing-id', existingId);

    row.innerHTML = `
      <div class="num">${idx}</div>
      <div style="flex:1;display:grid;grid-template-columns:1fr 1fr;gap:10px;">
        <div>
          <label style="display:block;margin-bottom:6px;">title <span class="req">*</span></label>
          <input data-title placeholder="title" value="${(title || '').replaceAll('"', '&quot;')}" ${existingId ? 'disabled' : ''} />
        </div>
        <div>
          <label style="display:block;margin-bottom:6px;">locator</label>
          <input data-locator placeholder="locator" value="${(locator || '').replaceAll('"', '&quot;')}" ${existingId ? 'disabled' : ''} />
        </div>
      </div>
      <button type="button" class="remove" title="remove">‚úï</button>
    `;
    row.querySelector('.remove').addEventListener('click', () => {
      row.remove();
      body.querySelectorAll('.dyn-item').forEach((el, i) => { el.querySelector('.num').textContent = i + 1; });
      if (body.querySelectorAll('.dyn-item').length === 0) {
        body.innerHTML = '<div class="dyn-empty">No references</div>';
      }
    });
    body.appendChild(row);
  }

  function clearReferencesForm() {
    // Reference Source Ï¥àÍ∏∞Ìôî
    const refSourceSelect = document.getElementById('refSourceSelect');
    if (refSourceSelect) {
      refSourceSelect.value = '';
    }
    // New Source Fields Ïà®Í∏∞Í∏∞
    const newSourceFields = document.getElementById('newSourceFields');
    if (newSourceFields) {
      newSourceFields.classList.remove('show');
    }
    const newRefSourceName = document.getElementById('newRefSourceName');
    const newRefSourceDesc = document.getElementById('newRefSourceDesc');
    if (newRefSourceName) newRefSourceName.value = '';
    if (newRefSourceDesc) newRefSourceDesc.value = '';

    // References Ï¥àÍ∏∞Ìôî
    const body = document.getElementById('refsBody');
    body.innerHTML = '<div class="dyn-empty">No references</div>';

    // Hint Ï¥àÍ∏∞Ìôî
    const hint = document.getElementById('currentRefSourceHint');
    if (hint) hint.textContent = '';
  }

  // Load reference sources
  async function loadReferenceSources() {
    try {
      const res = await fetch('/api/reference-sources?limit=200');
      const j = await res.json();
      const sel = document.getElementById('refSourceSelect');
      (j.items || []).forEach(src => {
        const opt = document.createElement('option');
        opt.value = src._id;
        opt.textContent = src.name || src._id;
        sel.appendChild(opt);
      });
    } catch (e) {
      console.error('Failed to load reference sources:', e);
    }
  }

  // Collect references from form
  function collectReferences() {
    const refs = [];
    document.querySelectorAll('#refsBody .dyn-item').forEach(row => {
      const existingId = row.getAttribute('data-existing-id');
      const title = row.querySelector('[data-title]')?.value?.trim() || '';
      const locator = row.querySelector('[data-locator]')?.value?.trim() || '';
      if (existingId) {
        refs.push({ _id: existingId, title, locator, isExisting: true });
      } else if (title) {
        refs.push({ title, locator, isExisting: false });
      }
    });
    return refs;
  }

  // Dynamic list helpers for language/text rows
  function readLangTextList(listEl){
    const items = [];
    listEl.querySelectorAll('[data-row="langtext"]').forEach(r => {
      const t = r.querySelector('input[data-field="text"]').value.trim();
      const l = r.querySelector('input[data-field="lang"]').value.trim();
      if (t || l) items.push({ text: t, language: l });
    });
    return items;
  }

  function addLangTextItem(listEl, textVal='', langVal=''){
    const empty = listEl.querySelector('.dyn-empty');
    if (empty) empty.remove();

    const row = document.createElement('div');
    row.dataset.row = 'langtext';
    row.style.display = 'grid';
    row.style.gridTemplateColumns = '2fr 1fr auto';
    row.style.gap = '8px';
    row.style.padding = '10px 12px';
    row.style.borderBottom = '1px solid var(--border)';

    const t = document.createElement('input');
    t.dataset.field = 'text';
    t.placeholder = 'text';
    t.value = textVal;

    const l = document.createElement('input');
    l.dataset.field = 'lang';
    l.placeholder = 'language (e.g., en)';
    l.value = langVal;

    const rm = document.createElement('button');
    rm.type = 'button';
    rm.className = 'btn ghost';
    rm.textContent = 'Remove';
    rm.addEventListener('click', () => {
      row.remove();
      if (listEl.children.length === 0) {
        const e = document.createElement('div');
        e.className = 'dyn-empty';
        e.textContent = 'No items';
        listEl.appendChild(e);
      }
    });

    row.appendChild(t);
    row.appendChild(l);
    row.appendChild(rm);
    listEl.appendChild(row);
  }

  // Alert priority list helpers
  function addAlertPriorityItem(listEl, init){
    const empty = listEl.querySelector('.dyn-empty');
    if (empty) empty.remove();

    const row = document.createElement('div');
    row.style.display = 'grid';
    row.style.gridTemplateColumns = '1fr 1fr 1fr auto';
    row.style.gap = '8px';
    row.style.padding = '10px 12px';
    row.style.borderBottom = '1px solid var(--border)';

    const pr = document.createElement('select');
    ['alarm','warning','caution','indication'].forEach(v=>{
      const o=document.createElement('option');o.value=v;o.textContent=v;pr.appendChild(o);
    });
    pr.value = (init && init.priority) || 'warning';

    const def = document.createElement('select');
    [{v:'false',t:'default=false'},{v:'true',t:'default=true'}].forEach(x=>{
      const o=document.createElement('option');o.value=x.v;o.textContent=x.t;def.appendChild(o);
    });
    def.value = String((init && init.default) || false);

    const opt = document.createElement('select');
    [{v:'false',t:'optional=false'},{v:'true',t:'optional=true'}].forEach(x=>{
      const o=document.createElement('option');o.value=x.v;o.textContent=x.t;opt.appendChild(o);
    });
    opt.value = String((init && init.optional) || false);

    const rm = document.createElement('button');
    rm.type='button';
    rm.className='btn ghost';
    rm.textContent='Remove';
    rm.addEventListener('click', ()=>{
      row.remove();
      if (listEl.children.length === 0) {
        const e=document.createElement('div'); e.className='dyn-empty'; e.textContent='No items';
        listEl.appendChild(e);
      }
    });

    row.appendChild(pr);
    row.appendChild(def);
    row.appendChild(opt);
    row.appendChild(rm);
    listEl.appendChild(row);
  }

  function readAlertPriorityList(listEl){
    const items = [];
    listEl.querySelectorAll('div').forEach(row=>{
      const sel = row.querySelectorAll('select');
      if (sel.length !== 3) return;
      const priority = sel[0].value;
      const def = (sel[1].value === 'true');
      const opt = (sel[2].value === 'true');
      items.push({ priority: { priority, default: def, optional: opt } });
    });
    return items;
  }

  function splitCsv(s) {
    const v = (s || '').trim();
    if (!v) return [];
    return v.split(',').map(x => x.trim()).filter(Boolean);
  }

  function selectedValues(sel) {
    return Array.from(sel.selectedOptions || []).map(o => o.value).filter(Boolean);
  }

  function parseJsonField(id, fallback) {
    const raw = document.getElementById(id).value.trim();
    if (!raw) return fallback;
    try {
      return JSON.parse(raw);
    } catch (e) {
      throw new Error(`${id} is not valid JSON`);
    }
  }

  function setJsonField(id, obj) {
    document.getElementById(id).value = JSON.stringify(obj, null, 2);
  }

  async function fetchJson(url) {
    const res = await fetch(url);
    const j = await res.json();
    if (!res.ok) throw new Error(j.detail || JSON.stringify(j));
    return j;
  }

  function clearSelect(sel, keepFirstOption) {
    if (keepFirstOption) {
      while (sel.options.length > 1) sel.remove(1);
    } else {
      while (sel.options.length > 0) sel.remove(0);
    }
  }

  function optionLabel(item) {
    const nm = (item.prItem && item.prItem.name) ? item.prItem.name : '(no name)';
    const idn = (item.prItem && item.prItem.itemIdentifier) ? item.prItem.itemIdentifier : '';
    const k = item.kind || '';
    return `${nm}${idn ? ' #' + idn : ''} [${k}] (${item._id})`;
  }

  async function loadRegisters() {
    const sel = document.getElementById('registerId');
    const j = await fetchJson('/api/registers?limit=200');
    (j.items || []).forEach(r => {
      const opt = document.createElement('option');
      opt.value = r._id;
      opt.textContent = `${r.name} (${r._id})`;
      sel.appendChild(opt);
    });
  }

  // loadReferences Ìï®ÏàòÎäî Step 3ÏóêÏÑú ÏßÅÏ†ë ReferenceÎ•º Ï∂îÍ∞ÄÌïòÎäî Î∞©ÏãùÏúºÎ°ú ÎåÄÏ≤¥Îê®

  async function loadPrItemsToSelect(sel, kind, registerId, opts) {
    const { keepFirstOption=false } = (opts || {});
    if (!registerId) {
      clearSelect(sel, keepFirstOption);
      return;
    }
    const url = `/api/pr/items?limit=200&kind=${encodeURIComponent(kind)}&registerId=${encodeURIComponent(registerId)}`;
    const j = await fetchJson(url);
    clearSelect(sel, keepFirstOption);
    (j.items || []).forEach(it => {
      const opt = document.createElement('option');
      opt.value = it._id;
      opt.textContent = optionLabel(it);
      opt.selected = false;  // Explicitly set to false when creating
      sel.appendChild(opt);
    });
    // Deselect all options after loading (prevent auto-select of first option)
    sel.selectedIndex = -1;
    Array.from(sel.options).forEach(o => o.selected = false);
  }

  const visualKinds = new Set([
    'S100_PR_Symbol','S100_PR_LineStyle','S100_PR_AreaFill','S100_PR_Pixmap'
  ]);

  // Kinds that require file uploads
  const fileBasedKinds = new Set([
    'S100_PR_Symbol','S100_PR_LineStyle','S100_PR_AreaFill','S100_PR_Pixmap',
    'S100_PR_ItemSchema','S100_PR_Font'
  ]);

  // Store uploaded file data
  const uploadedFiles = {
    itemDetail: null,
    previewImage: null,
    engineeringImage: null,
    xmlSchema: null,
    fontFile: null
  };

  // File upload visibility based on kind
  function setFileUploadVisibility(kind) {
    const card = document.getElementById('fileUploadCard');
    const sections = ['itemDetail', 'previewImage', 'engineeringImage', 'xmlSchema', 'fontFile'];
    
    // Hide all file upload sections first
    sections.forEach(s => {
      const el = document.getElementById('fileUpload_' + s);
      if (el) el.classList.remove('active');
    });

    if (!fileBasedKinds.has(kind)) {
      card.style.display = 'none';
      return;
    }

    card.style.display = 'block';

    // Visual kinds: Symbol, LineStyle, AreaFill, Pixmap
    if (visualKinds.has(kind)) {
      document.getElementById('fileUpload_itemDetail')?.classList.add('active');
      document.getElementById('fileUpload_previewImage')?.classList.add('active');
      document.getElementById('fileUpload_engineeringImage')?.classList.add('active');
    }

    // ItemSchema
    if (kind === 'S100_PR_ItemSchema') {
      document.getElementById('fileUpload_xmlSchema')?.classList.add('active');
    }

    // Font
    if (kind === 'S100_PR_Font') {
      document.getElementById('fileUpload_fontFile')?.classList.add('active');
    }
  }

  // Format file size
  function formatFileSize(bytes) {
    if (bytes === 0) return '0 Bytes';
    const k = 1024;
    const sizes = ['Bytes', 'KB', 'MB', 'GB'];
    const i = Math.floor(Math.log(bytes) / Math.log(k));
    return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
  }

  // Render file item in list
  function renderFileItem(target, file, status='pending') {
    const listEl = document.getElementById('fileList_' + target);
    listEl.innerHTML = '';

    const item = document.createElement('div');
    item.className = 'file-item';
    item.innerHTML = `
      <div class="file-item-info">
        <div class="file-item-icon">üìé</div>
        <div class="file-item-details">
          <div class="file-item-name">${file.name}</div>
          <div class="file-item-size">${formatFileSize(file.size)}</div>
        </div>
      </div>
      <div style="display:flex;align-items:center;gap:8px;">
        <span class="file-item-status ${status}">${status === 'pending' ? 'Ready' : status === 'uploading' ? 'Uploading...' : status === 'done' ? 'Uploaded' : 'Error'}</span>
        <button type="button" class="file-item-remove" data-target="${target}">&times;</button>
      </div>
    `;
    listEl.appendChild(item);

    // Remove button handler
    item.querySelector('.file-item-remove').addEventListener('click', () => {
      uploadedFiles[target] = null;
      listEl.innerHTML = '';
      document.getElementById('file_' + target).value = '';
    });
  }

  // Handle file selection
  function handleFileSelect(target, file) {
    if (!file) return;
    uploadedFiles[target] = file;
    renderFileItem(target, file, 'pending');
  }

  // Initialize file upload handlers
  function initFileUpload() {
    const targets = ['itemDetail', 'previewImage', 'engineeringImage', 'xmlSchema', 'fontFile'];

    targets.forEach(target => {
      const dropZone = document.querySelector(`.file-drop[data-target="${target}"]`);
      const fileInput = document.getElementById('file_' + target);

      if (!dropZone || !fileInput) return;

      // Click to browse
      dropZone.addEventListener('click', () => fileInput.click());

      // Drag events
      dropZone.addEventListener('dragover', (e) => {
        e.preventDefault();
        dropZone.classList.add('dragover');
      });

      dropZone.addEventListener('dragleave', () => {
        dropZone.classList.remove('dragover');
      });

      dropZone.addEventListener('drop', (e) => {
        e.preventDefault();
        dropZone.classList.remove('dragover');
        const files = e.dataTransfer.files;
        if (files.length > 0) {
          handleFileSelect(target, files[0]);
        }
      });

      // File input change
      fileInput.addEventListener('change', (e) => {
        if (e.target.files.length > 0) {
          handleFileSelect(target, e.target.files[0]);
        }
      });
    });
  }

  // Upload file to server (returns the path)
  async function uploadFile(target) {
    const file = uploadedFiles[target];
    if (!file) return null;

    const listEl = document.getElementById('fileList_' + target);
    const statusEl = listEl.querySelector('.file-item-status');
    if (statusEl) {
      statusEl.className = 'file-item-status uploading';
      statusEl.textContent = 'Uploading...';
    }

    try {
      const formData = new FormData();
      formData.append('file', file);

      const res = await fetch('/api/files/upload', {
        method: 'POST',
        body: formData
      });

      const result = await res.json();
      if (!res.ok) throw new Error(result.detail || 'Upload failed');

      if (statusEl) {
        statusEl.className = 'file-item-status done';
        statusEl.textContent = 'Uploaded';
      }

      return result.path || result.url || result.file_path;
    } catch (err) {
      if (statusEl) {
        statusEl.className = 'file-item-status error';
        statusEl.textContent = 'Error';
      }
      throw err;
    }
  }

  // Upload all pending files for the current kind
  async function uploadAllFiles(kind) {
    const paths = {};

    if (visualKinds.has(kind)) {
      if (uploadedFiles.itemDetail) {
        paths.itemDetail = await uploadFile('itemDetail');
      }
      if (uploadedFiles.previewImage) {
        paths.previewImage = await uploadFile('previewImage');
      }
      if (uploadedFiles.engineeringImage) {
        paths.engineeringImage = await uploadFile('engineeringImage');
      }
    }

    if (kind === 'S100_PR_ItemSchema' && uploadedFiles.xmlSchema) {
      paths.xmlSchema = await uploadFile('xmlSchema');
    }

    if (kind === 'S100_PR_Font' && uploadedFiles.fontFile) {
      paths.fontFile = await uploadFile('fontFile');
    }

    return paths;
  }

  // ========== Multi-Select Chips UI ==========
  function initMultiSelect(container) {
    const targetId = container.dataset.target;
    const hiddenSelect = document.getElementById(targetId);
    if (!hiddenSelect) return;

    const chipsEl = container.querySelector('.multi-select-chips');
    const dropdownEl = container.querySelector('.multi-select-dropdown');
    const searchInput = container.querySelector('.multi-select-search input');
    const optionsEl = container.querySelector('.multi-select-options');

    if (!chipsEl || !dropdownEl || !searchInput || !optionsEl) return;

    // Check if single select mode (0..1)
    const isSingle = container.dataset.single === 'true';

    // Remove existing event listeners by cloning
    const newChipsEl = chipsEl.cloneNode(true);
    chipsEl.parentNode.replaceChild(newChipsEl, chipsEl);
    const chipsElement = newChipsEl;

    // Build options from hidden select
    function buildOptions(filter = '') {
      optionsEl.innerHTML = '';
      const opts = Array.from(hiddenSelect.options);
      const filtered = opts.filter(o => o.value && o.text.toLowerCase().includes(filter.toLowerCase()));
      
      if (filtered.length === 0) {
        optionsEl.innerHTML = '<div class="multi-select-empty">No options found</div>';
        return;
      }

      filtered.forEach(opt => {
        const div = document.createElement('div');
        div.className = 'multi-select-option' + (opt.selected ? ' selected' : '');
        div.dataset.value = opt.value;
        div.innerHTML = `
          <span class="multi-select-option-check">${opt.selected ? '&#10003;' : ''}</span>
          <span>${opt.text}</span>
        `;
        div.addEventListener('click', (e) => {
          e.stopPropagation();
          if (isSingle) {
            // Single mode: deselect all first, then select this one (or deselect if already selected)
            const wasSelected = opt.selected;
            Array.from(hiddenSelect.options).forEach(o => o.selected = false);
            if (!wasSelected) {
              opt.selected = true;
            }
            // Auto close dropdown after selection in single mode
            closeAllDropdowns();
          } else {
            // Multi mode: toggle
            opt.selected = !opt.selected;
          }
          updateChips();
          buildOptions(searchInput.value);
        });
        optionsEl.appendChild(div);
      });
    }

    // Update chips display
    function updateChips() {
      const selected = Array.from(hiddenSelect.selectedOptions);
      chipsElement.innerHTML = '';
      
      if (selected.length === 0) {
        chipsElement.classList.add('empty');
      } else {
        chipsElement.classList.remove('empty');
        selected.forEach(opt => {
          const chip = document.createElement('span');
          chip.className = 'chip';
          chip.innerHTML = `
            <span class="chip-text">${opt.text}</span>
            <button type="button" class="chip-remove" data-value="${opt.value}">&times;</button>
          `;
          chip.querySelector('.chip-remove').addEventListener('click', (e) => {
            e.stopPropagation();
            opt.selected = false;
            updateChips();
            buildOptions(searchInput.value);
          });
          chipsElement.appendChild(chip);
        });
      }
    }

    // Toggle dropdown
    chipsElement.addEventListener('click', (e) => {
      e.stopPropagation();
      const isOpen = dropdownEl.classList.contains('open');
      closeAllDropdowns();
      if (!isOpen) {
        // Position dropdown below chips (fixed positioning)
        const rect = chipsElement.getBoundingClientRect();
        dropdownEl.style.top = (rect.bottom + 4) + 'px';
        dropdownEl.style.left = rect.left + 'px';
        dropdownEl.style.width = rect.width + 'px';
        dropdownEl.classList.add('open');
        searchInput.value = '';
        buildOptions();
        searchInput.focus();
      }
    });

    // Search filter
    searchInput.addEventListener('input', () => {
      buildOptions(searchInput.value);
    });

    // Prevent dropdown close when clicking inside
    dropdownEl.addEventListener('click', (e) => {
      e.stopPropagation();
    });

    // Initial render - ensure nothing is pre-selected for new forms
    // (Only deselect if this is initial load, not refresh after user selection)
    if (!container._initialized) {
      hiddenSelect.selectedIndex = -1;
      Array.from(hiddenSelect.options).forEach(o => o.selected = false);
      container._initialized = true;
    }
    updateChips();
    
    // Store refresh function for later use
    container._refresh = () => {
      buildOptions(searchInput.value);
      updateChips();
    };
  }

  function closeAllDropdowns() {
    document.querySelectorAll('.multi-select-dropdown.open').forEach(d => d.classList.remove('open'));
  }

  // Close dropdowns when clicking outside
  document.addEventListener('click', closeAllDropdowns);

  // Refresh all multi-select UIs after loading options
  function refreshAllMultiSelects() {
    document.querySelectorAll('.multi-select-container').forEach(container => {
      initMultiSelect(container);
    });
  }

  // Initialize all multi-selects immediately (script runs after DOM is parsed)
  (function initAllMultiSelects() {
    document.querySelectorAll('.multi-select-container').forEach(container => {
      initMultiSelect(container);
    });
  })();

  function setRelVisibility(kind) {
    document.querySelectorAll('.rel-section').forEach(el => el.classList.remove('active'));
    
    // Optional Links (Visual Kinds) Ïπ¥Îìú: S100_PR_Symbol, S100_PR_LineStyle, S100_PR_AreaFill, S100_PR_Pixmap Ïùº ÎïåÎßå ÌëúÏãú
    const optionalLinksCard = document.getElementById('optionalLinksCard');
    const visualKinds = ['S100_PR_Symbol', 'S100_PR_LineStyle', 'S100_PR_AreaFill', 'S100_PR_Pixmap'];
    if (visualKinds.includes(kind)) {
      optionalLinksCard.style.display = 'block';
    } else {
      optionalLinksCard.style.display = 'none';
    }

    if (kind === 'S100_PR_LineStyle' || kind === 'S100_PR_AreaFill') {
      document.getElementById('relLineArea').classList.add('active');
    }
    if (kind === 'S100_PR_ViewingGroupLayer') {
      document.getElementById('relViewingGroupLayer').classList.add('active');
    }
    if (kind === 'S100_PR_ViewingGroup') {
      document.getElementById('relViewingGroup').classList.add('active');
    }
    if (kind === 'S100_PR_AlertHighlight') {
      document.getElementById('relAlertHighlight').classList.add('active');
    }
    if (kind === 'S100_PR_AlertMessage') {
      document.getElementById('relAlertMessage').classList.add('active');
    }
    if (kind === 'S100_PR_ColourToken') {
      document.getElementById('relColourToken').classList.add('active');
    }
    if (kind === 'S100_PR_PaletteItem') {
      document.getElementById('relPaletteItem').classList.add('active');
    }
  }

function setKindBodyVisibility(kind){
  // hide all kb-sections
  document.querySelectorAll('.kb-section').forEach(el => el.classList.remove('active'));

    // show by kind
    if (['S100_PR_Symbol','S100_PR_LineStyle','S100_PR_AreaFill','S100_PR_Pixmap'].includes(kind)) {
      document.getElementById('kb_visual')?.classList.add('active');
    }
    if (kind === 'S100_PR_ItemSchema') document.getElementById('kb_itemSchema')?.classList.add('active');
    if (kind === 'S100_PR_ViewingGroup') document.getElementById('kb_viewingGroup')?.classList.add('active');
    if (kind === 'S100_PR_AlertMessage') document.getElementById('kb_alertMessage')?.classList.add('active');
    if (kind === 'S100_PR_ColourToken') document.getElementById('kb_colourToken')?.classList.add('active');
    if (kind === 'S100_PR_PaletteItem') document.getElementById('kb_paletteItem')?.classList.add('active');
    if (kind === 'S100_PR_ContextParameter') document.getElementById('kb_contextParameter')?.classList.add('active');
    if (kind === 'S100_PR_DrawingPriority') document.getElementById('kb_drawingPriority')?.classList.add('active');
    if (kind === 'S100_PR_DisplayPlane') document.getElementById('kb_displayPlane')?.classList.add('active');
    if (kind === 'S100_PR_Alert') document.getElementById('kb_alert')?.classList.add('active');
    if (kind === 'S100_PR_Font') document.getElementById('kb_font')?.classList.add('active');
  }

  async function refreshAllOptionLists() {
    const registerId = document.getElementById('registerId').value.trim();
    const kind = document.getElementById('kind').value.trim();

    // Visual link selects
    await loadPrItemsToSelect(document.getElementById('itemSchemaSel'), 'S100_PR_ItemSchema', registerId);
    await loadPrItemsToSelect(document.getElementById('colourTokenSel'), 'S100_PR_ColourToken', registerId);

    // Kind relations
    if (kind === 'S100_PR_LineStyle' || kind === 'S100_PR_AreaFill') {
      await loadPrItemsToSelect(document.getElementById('symbolSel'), 'S100_PR_Symbol', registerId);
    }
    if (kind === 'S100_PR_ViewingGroupLayer') {
      await loadPrItemsToSelect(document.getElementById('displayModeSel'), 'S100_PR_DisplayMode', registerId);
    }
    if (kind === 'S100_PR_ViewingGroup') {
      await loadPrItemsToSelect(document.getElementById('viewingGroupLayerSel'), 'S100_PR_ViewingGroupLayer', registerId);
    }
    if (kind === 'S100_PR_AlertHighlight') {
      await loadPrItemsToSelect(document.getElementById('ah_viewingGroupSel'), 'S100_PR_ViewingGroup', registerId);
      await loadPrItemsToSelect(document.getElementById('ah_msgSel'), 'S100_PR_AlertMessage', registerId);
    }
    if (kind === 'S100_PR_AlertMessage') {
      await loadPrItemsToSelect(document.getElementById('iconSel'), 'S100_PR_Symbol', registerId);
    }
    if (kind === 'S100_PR_ColourToken') {
      await loadPrItemsToSelect(document.getElementById('ct_valueSel'), 'S100_PR_PaletteItem', registerId);
    }
    if (kind === 'S100_PR_PaletteItem') {
      await loadPrItemsToSelect(document.getElementById('pi_paletteSel'), 'S100_PR_ColourPalette', registerId);
    }

    // Refresh multi-select chips UI after loading options
    refreshAllMultiSelects();
  }

  function buildDescription(){
    const list = document.getElementById('descList');
    return readLangTextList(list);
  }

  function buildControlBodyNotes(){
    const raw = document.getElementById('mi_controlBodyNotesText').value || '';
    return raw.split('\n').map(x=>x.trim()).filter(Boolean);
  }

  function numOrNull(v){
    const s = (v||'').trim();
    if (!s) return null;
    const n = Number(s);
    return Number.isFinite(n) ? n : null;
  }

  function buildKindBody(kind){
    const out = {};

    // visual common
    if (['S100_PR_Symbol','S100_PR_LineStyle','S100_PR_AreaFill','S100_PR_Pixmap'].includes(kind)) {
      out.itemDetail = document.getElementById('kb_itemDetail').value.trim() || null;
      out.previewImage = document.getElementById('kb_previewImage').value.trim() || null;
      out.engineeringImage = document.getElementById('kb_engineeringImage').value.trim() || null;
      out.previewType = document.getElementById('kb_previewType').value || null;
      out.engineeringImageType = document.getElementById('kb_engineeringImageType').value || null;
    }

    if (kind === 'S100_PR_ItemSchema') {
      out.schemaKind = document.getElementById('kb_schemaKind').value;
      out.xmlSchema = document.getElementById('kb_xmlSchema').value.trim() || null;
    }

    if (kind === 'S100_PR_ViewingGroup') {
      out.foundationMode = !!document.getElementById('kb_foundationMode').checked;
    }

    if (kind === 'S100_PR_AlertMessage') {
      const list = document.getElementById('amTextList');
      out.text = readLangTextList(list);
    }

    if (kind === 'S100_PR_ColourToken') {
      out.token = document.getElementById('kb_ct_token').value.trim() || '';
    }

    if (kind === 'S100_PR_PaletteItem') {
      out.transparency = numOrNull(document.getElementById('kb_pi_transparency').value) ?? 0.0;
      out.colour = {
        cieValue: {
          x: numOrNull(document.getElementById('kb_pi_x').value) ?? 0,
          y: numOrNull(document.getElementById('kb_pi_y').value) ?? 0,
          z: numOrNull(document.getElementById('kb_pi_z').value) ?? 0,
        },
        sRGBValue: {
          red: (numOrNull(document.getElementById('kb_pi_red').value) ?? 0),
          green: (numOrNull(document.getElementById('kb_pi_green').value) ?? 0),
          blue: (numOrNull(document.getElementById('kb_pi_blue').value) ?? 0),
        }
      };
    }

    if (kind === 'S100_PR_ContextParameter') {
      out.parameterType = document.getElementById('kb_cp_type').value;
      out.defaultValue = document.getElementById('kb_cp_default').value.trim() || '';
    }

    if (kind === 'S100_PR_DrawingPriority') {
      out.priority = numOrNull(document.getElementById('kb_dp_priority').value) ?? 1;
    }

    if (kind === 'S100_PR_DisplayPlane') {
      out.order = numOrNull(document.getElementById('kb_plane_order').value) ?? 1;
    }

    if (kind === 'S100_PR_Alert') {
      out.routeMonitor = readAlertPriorityList(document.getElementById('rmList'));
      out.routePlan = readAlertPriorityList(document.getElementById('rpList'));
    }

    if (kind === 'S100_PR_Font') {
      out.fontFile = document.getElementById('kb_font_file').value.trim() || null;
      out.fontType = document.getElementById('kb_font_type').value.trim() || 'ttf';
    }

    return out;
  }

  // KindÎ≥Ñ Ïó∞Í¥ÄÍ¥ÄÍ≥Ñ ÌïÑÎìúÎ•º top-levelÎ°ú ÏàòÏßëÌïòÎäî Ìï®Ïàò
  // Helper: 0..1 ÌïÑÎìúÏóêÏÑú Ï≤´ Î≤àÏß∏ ÏÑ†ÌÉùÍ∞íÎßå Í∞ÄÏ†∏Ïò§Í∏∞
  function singleSelectedValue(selectEl) {
    const vals = selectedValues(selectEl);
    return vals.length > 0 ? vals[0] : null;
  }

  function collectRelations(kind) {
    const rel = {};

    // S100_PR_LineStyle, S100_PR_AreaFill: symbol [0..1]
    if (kind === 'S100_PR_LineStyle' || kind === 'S100_PR_AreaFill') {
      rel.symbol = singleSelectedValue(document.getElementById('symbolSel'));
    }

    // S100_PR_ViewingGroupLayer: displayMode [0..*]
    if (kind === 'S100_PR_ViewingGroupLayer') {
      rel.displayMode = selectedValues(document.getElementById('displayModeSel'));
    }

    // S100_PR_ViewingGroup: viewingGroup (ViewingGroupLayer) [0..*]
    if (kind === 'S100_PR_ViewingGroup') {
      rel.viewingGroup = selectedValues(document.getElementById('viewingGroupLayerSel'));
    }

    // S100_PR_AlertHighlight: viewingGroup [0..*], msg [0..1]
    if (kind === 'S100_PR_AlertHighlight') {
      rel.viewingGroup = selectedValues(document.getElementById('ah_viewingGroupSel'));
      rel.msg = singleSelectedValue(document.getElementById('ah_msgSel'));
    }

    // S100_PR_AlertMessage: icon (Symbol) [0..1]
    if (kind === 'S100_PR_AlertMessage') {
      rel.icon = singleSelectedValue(document.getElementById('iconSel'));
    }

    // S100_PR_ColourToken: value (PaletteItem) [0..1]
    if (kind === 'S100_PR_ColourToken') {
      rel.value = singleSelectedValue(document.getElementById('ct_valueSel'));
    }

    // S100_PR_PaletteItem: palette (ColourPalette) [0..*]
    if (kind === 'S100_PR_PaletteItem') {
      rel.palette = selectedValues(document.getElementById('pi_paletteSel'));
    }

    return rel;
  }

  function injectRelationsIntoKindBody(kind, obj) {
    const out = (obj && typeof obj === 'object') ? JSON.parse(JSON.stringify(obj)) : {};

    // kindBodyÏóêÎäî Ïó∞Í¥ÄÍ¥ÄÍ≥Ñ Ïô∏Ïùò kind-specific ÌïÑÎìúÎßå Ïú†ÏßÄ
    // Ïó∞Í¥ÄÍ¥ÄÍ≥Ñ ÌïÑÎìúÎäî Ïù¥Ï†ú top-levelÎ°ú Ï†ÄÏû•ÎêòÎØÄÎ°ú kindBodyÏóêÏÑú Ï†úÍ±∞

    if (kind === 'S100_PR_ViewingGroup') {
      out.foundationMode = !!document.getElementById('foundationMode').checked;
    }
    if (kind === 'S100_PR_AlertHighlight') {
      out.optional = !!document.getElementById('ah_optional').checked;
      out.style = document.getElementById('ah_style').value;
    }
    if (kind === 'S100_PR_ColourToken') {
      out.token = document.getElementById('ct_token').value.trim() || out.token || '';
    }

    return out;
  }

  function sampleKindBody(kind) {
    const commonVisual = {
      itemDetail: "s3://bucket/path/itemDetail.bin",
      previewImage: "s3://bucket/path/preview.png",
      engineeringImage: "s3://bucket/path/engineering.png",
      previewType: "png",
      engineeringImageType: "png"
    };

    switch (kind) {
      case 'S100_PR_Symbol':
      case 'S100_PR_Pixmap':
        return { ...commonVisual };
      case 'S100_PR_LineStyle':
      case 'S100_PR_AreaFill':
        return { ...commonVisual, symbol: [] };
      case 'S100_PR_ItemSchema':
        return { schemaKind: "S100_PR_SymbolSchema", xmlSchema: "s3://bucket/path/schema.xsd" };
      case 'S100_PR_DisplayMode':
        return {};
      case 'S100_PR_ViewingGroupLayer':
        return { displayMode: [] };
      case 'S100_PR_ViewingGroup':
        return { foundationMode: false, viewingGroup: [] };
      case 'S100_PR_AlertHighlight':
        return { optional: false, style: "AlarmHighlight", viewingGroup: [], msg: [] };
      case 'S100_PR_AlertMessage':
        return { text: [{ text: "Sample message", language: "en" }], icon: null };
      case 'S100_PR_ColourToken':
        return { token: "SAMPLE_TOKEN", value: [] };
      case 'S100_PR_ColourPalette':
        return {};
      case 'S100_PR_Alert':
        return {
          routeMonitor: [{ priority: { priority: "warning", default: true, optional: false } }],
          routePlan: [{ priority: { priority: "caution", default: false, optional: true } }]
        };
      case 'S100_PR_PaletteItem':
        return {
          transparency: 0.0,
          colour: {
            cieValue: { x: 0, y: 0, z: 0 },
            sRGBValue: { red: 0, green: 0, blue: 0 }
          },
          palette: []
        };
      case 'S100_PR_Font':
        return { fontFile: "s3://bucket/path/font.ttf", fontType: "ttf" };
      case 'S100_PR_ContextParameter':
        return { parameterType: "string", defaultValue: "sample" };
      case 'S100_PR_DrawingPriority':
        return { priority: 1 };
      case 'S100_PR_DisplayPlane':
        return { order: 1 };
      default:
        return {};
    }
  }

  async function onFillSample() {
    const banner = document.getElementById('sampleMsg');
    banner.style.display = 'none';

    const kind = document.getElementById('kind').value.trim();

    // common
    document.getElementById('name').value = `${kind} Sample`;
    document.getElementById('definition').value = `Sample definition for ${kind}`;
    document.getElementById('remarks').value = `[domain=Prototype]`;
    document.getElementById('itemStatus').value = 'Draft';
    document.getElementById('alias').value = `sample,${kind}`;
    document.getElementById('camelCase').value = 'sampleItem';
    document.getElementById('definitionSource').value = 'Prototype';
    document.getElementById('reference').value = 'N/A';
    document.getElementById('similarityToSource').value = '';
    document.getElementById('justification').value = 'MVP sample';
    document.getElementById('proposedChange').value = 'initial creation';

    document.getElementById('xmlID').value = `${kind}_SAMPLE`;

    // description UI
    const descList = document.getElementById('descList');
    descList.innerHTML = '';
    addLangTextItem(descList, `Sample description for ${kind}`, 'en');

    // Kind body UI fields
    if (['S100_PR_Symbol','S100_PR_LineStyle','S100_PR_AreaFill','S100_PR_Pixmap'].includes(kind)) {
      document.getElementById('kb_itemDetail').value = 's3://bucket/path/itemDetail.bin';
      document.getElementById('kb_previewImage').value = 's3://bucket/path/preview.png';
      document.getElementById('kb_engineeringImage').value = 's3://bucket/path/engineering.png';
      document.getElementById('kb_previewType').value = 'png';
      document.getElementById('kb_engineeringImageType').value = 'png';
    }
    if (kind === 'S100_PR_ItemSchema') {
      document.getElementById('kb_schemaKind').value = 'S100_PR_SymbolSchema';
      document.getElementById('kb_xmlSchema').value = 's3://bucket/path/schema.xsd';
    }
    if (kind === 'S100_PR_ViewingGroup') {
      document.getElementById('kb_foundationMode').checked = false;
    }
    if (kind === 'S100_PR_AlertMessage') {
      const amList = document.getElementById('amTextList');
      amList.innerHTML = '';
      addLangTextItem(amList, 'Sample message', 'en');
    }
    if (kind === 'S100_PR_ColourToken') {
      document.getElementById('kb_ct_token').value = 'SAMPLE_TOKEN';
    }
    if (kind === 'S100_PR_PaletteItem') {
      document.getElementById('kb_pi_transparency').value = '0.0';
      document.getElementById('kb_pi_red').value = '255';
      document.getElementById('kb_pi_green').value = '255';
      document.getElementById('kb_pi_blue').value = '255';
      document.getElementById('kb_pi_x').value = '0';
      document.getElementById('kb_pi_y').value = '0';
      document.getElementById('kb_pi_z').value = '0';
    }
    if (kind === 'S100_PR_ContextParameter') {
      document.getElementById('kb_cp_type').value = 'string';
      document.getElementById('kb_cp_default').value = 'sample';
    }
    if (kind === 'S100_PR_DrawingPriority') {
      document.getElementById('kb_dp_priority').value = '1';
    }
    if (kind === 'S100_PR_DisplayPlane') {
      document.getElementById('kb_plane_order').value = '1';
    }
    if (kind === 'S100_PR_Alert') {
      const rm = document.getElementById('rmList');
      const rp = document.getElementById('rpList');
      rm.innerHTML = '';
      rp.innerHTML = '';
      addAlertPriorityItem(rm, {priority:'warning', default:true, optional:false});
      addAlertPriorityItem(rp, {priority:'caution', default:false, optional:true});
    }
    if (kind === 'S100_PR_Font') {
      document.getElementById('kb_font_file').value = 's3://bucket/path/font.ttf';
      document.getElementById('kb_font_type').value = 'ttf';
    }

    try {
      await refreshAllOptionLists();

      const registerId = document.getElementById('registerId').value.trim();
      if (!registerId) {
        banner.textContent = 'Sample filled. (Select a register to load options.)';
        banner.style.display = 'block';
        return;
      }

      const itemSchemaSel = document.getElementById('itemSchemaSel');
      if (visualKinds.has(kind) && itemSchemaSel.options.length > 1 && !itemSchemaSel.value) {
        itemSchemaSel.value = itemSchemaSel.options[1].value;
      }

      const colourTokenSel = document.getElementById('colourTokenSel');
      if (visualKinds.has(kind) && colourTokenSel.options.length > 0) {
        colourTokenSel.options[0].selected = true;
      }

      if (kind === 'S100_PR_ColourToken') {
        document.getElementById('ct_token').value = 'SAMPLE_TOKEN';
      }
      if (kind === 'S100_PR_AlertHighlight') {
        document.getElementById('ah_optional').checked = false;
        document.getElementById('ah_style').value = 'AlarmHighlight';
      }
      if (kind === 'S100_PR_ViewingGroup') {
        document.getElementById('foundationMode').checked = false;
      }

      showToast('Sample filled successfully!', 'success');
    } catch (e) {
      banner.textContent = 'Sample filled, but failed to load options: ' + String(e.message || e);
      banner.style.display = 'block';
    }
  }

  document.addEventListener('DOMContentLoaded', async () => {
    await loadRegisters();
    await loadReferenceSources();
  
    const kind = document.getElementById('kind').value;
    setRelVisibility(kind);
    setKindBodyVisibility(kind);
    setFileUploadVisibility(kind);
    initFileUpload();
  
    document.getElementById('fillSample').addEventListener('click', onFillSample);

    // Add Reference button
    document.getElementById('addRefBtn').addEventListener('click', () => {
      addRefRow('', '');
    });

    // Toggle New Source Fields visibility
    const refSourceSelect = document.getElementById('refSourceSelect');
    if (refSourceSelect) {
      refSourceSelect.addEventListener('change', function() {
        const newSourceFields = document.getElementById('newSourceFields');
        if (this.value === '__new__') {
          newSourceFields.classList.add('show');
        } else {
          newSourceFields.classList.remove('show');
        }
      });
    }

    // description list
    document.getElementById('descAdd').addEventListener('click', () => {
      addLangTextItem(document.getElementById('descList'), '', 'en');
    });

    // alertMessage text list
    document.getElementById('amTextAdd').addEventListener('click', () => {
      addLangTextItem(document.getElementById('amTextList'), '', 'en');
    });

    // alert routeMonitor / routePlan
    document.getElementById('rmAdd').addEventListener('click', () => addAlertPriorityItem(document.getElementById('rmList'), {priority:'warning', default:true, optional:false}));
    document.getElementById('rpAdd').addEventListener('click', () => addAlertPriorityItem(document.getElementById('rpList'), {priority:'caution', default:false, optional:true}));

    document.getElementById('registerId').addEventListener('change', async () => {
      try {
        await refreshAllOptionLists();
      } catch (e) {
        // ignore
      }
    });

document.getElementById('kind').addEventListener('change', async () => {
  const k = document.getElementById('kind').value;
  setRelVisibility(k);
  setKindBodyVisibility(k);
  setFileUploadVisibility(k);
      try {
        await refreshAllOptionLists();
      } finally {
        // noop
      }
    });

  });

  document.getElementById('form').addEventListener('submit', async (e) => {
    e.preventDefault();

    try {
      const registerId = document.getElementById('registerId').value.trim();
      const kind = document.getElementById('kind').value.trim();

  if (!registerId) {
  showToast('Register is required.', 'error');
  return;
  }

  // Upload files if needed for file-based kinds
  let uploadedPaths = {};
  if (fileBasedKinds.has(kind)) {
    try {
      uploadedPaths = await uploadAllFiles(kind);
    } catch (uploadErr) {
      showToast('File upload failed: ' + String(uploadErr.message || uploadErr), 'error');
      return;
    }
  }
  
  const uiKindBody = buildKindBody(kind);

  // Inject uploaded file paths into kindBody
  if (uploadedPaths.itemDetail) uiKindBody.itemDetail = uploadedPaths.itemDetail;
  if (uploadedPaths.previewImage) uiKindBody.previewImage = uploadedPaths.previewImage;
  if (uploadedPaths.engineeringImage) uiKindBody.engineeringImage = uploadedPaths.engineeringImage;
  if (uploadedPaths.xmlSchema) uiKindBody.xmlSchema = uploadedPaths.xmlSchema;
  if (uploadedPaths.fontFile) uiKindBody.fontFile = uploadedPaths.fontFile;

  const kindBody = injectRelationsIntoKindBody(kind, uiKindBody);

      // KindÎ≥Ñ Ïó∞Í¥ÄÍ¥ÄÍ≥Ñ ÌïÑÎìú ÏàòÏßë (top-levelÎ°ú Ï†ÑÏÜ°)
      const relations = collectRelations(kind);

      const payload = {
        registerId,
        kind,
        prItem: {
          name: document.getElementById('name').value.trim(),
          definition: document.getElementById('definition').value.trim() || null,
          remarks: document.getElementById('remarks').value.trim() || null,
          itemStatus: document.getElementById('itemStatus').value.trim() || null,
          alias: splitCsv(document.getElementById('alias').value),
          camelCase: document.getElementById('camelCase').value.trim() || null,
          definitionSource: document.getElementById('definitionSource').value.trim() || null,
          reference: document.getElementById('reference').value.trim() || null,
          similarityToSource: document.getElementById('similarityToSource').value.trim() || null,
          justification: document.getElementById('justification').value.trim() || null,
          proposedChange: document.getElementById('proposedChange').value.trim() || null,
        },
        xmlID: document.getElementById('xmlID').value.trim() || null,
        description: buildDescription(),
        itemSchema: document.getElementById('itemSchemaSel').value || null,
        colourToken: selectedValues(document.getElementById('colourTokenSel')),
        // KindÎ≥Ñ Ïó∞Í¥ÄÍ¥ÄÍ≥Ñ ÌïÑÎìú (top-level)
        symbol: relations.symbol || null,
        displayMode: relations.displayMode || [],
        viewingGroup: relations.viewingGroup || [],
        msg: relations.msg || null,
        icon: relations.icon || null,
        value: relations.value || null,
        palette: relations.palette || [],
        kindBody: kindBody,
        // References Ï≤òÎ¶¨
        referenceSourceId: (() => {
          const sel = document.getElementById('refSourceSelect');
          const val = sel.value;
          if (!val || val === '__new__') return null;
          return val;
        })(),
        newReferenceSource: (() => {
          const sel = document.getElementById('refSourceSelect');
          if (sel.value !== '__new__') return null;
          const name = document.getElementById('newRefSourceName').value.trim();
          const desc = document.getElementById('newRefSourceDesc').value.trim();
          if (!name) return null;
          return { name, description: desc || null };
        })(),
        references: collectReferences(),
        managementInfos: [
          {
            proposalType: document.getElementById('mi_proposalType').value.trim() || 'Addition',
            submittingOrganisation: document.getElementById('mi_submittingOrganisation').value.trim() || '',
            proposedChange: document.getElementById('mi_proposedChange').value.trim() || '',
            dateProposed: new Date().toISOString(),
            proposalStatus: document.getElementById('mi_proposalStatus').value.trim() || 'Draft',
            controlBodyNotes: buildControlBodyNotes(),
          }
        ]
      };

      const res = await fetch('/api/pr/items', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(payload)
      });

      const j = await res.json();
      if (!res.ok) {
        showToast('Failed: ' + (j.detail || JSON.stringify(j)), 'error');
        return;
      }

      showToast('Created successfully!', 'success');
      setTimeout(() => {
        window.location.href = '/ui/pr/' + j._id;
      }, 1000);
    } catch (err) {
      showToast(String(err.message || err), 'error');
    }
  });
</script>
{% endblock %}
