{% extends "base.html" %}

{% block title %}New PR Item{% endblock %}

{% block content %}
<h1>Create PR Item</h1>

<div>
  <a href="/ui/pr">Back to list</a>
</div>

<hr />

<form id="form">
  <h2>Target Register</h2>
  <label>Register:
    <select id="registerId" required>
      <option value="">(select)</option>
    </select>
  </label>

  <h2>Kind</h2>
  <label>kind:
    <select id="kind" required>
      <option value="S100_PR_Symbol">S100_PR_Symbol</option>
      <option value="S100_PR_LineStyle">S100_PR_LineStyle</option>
      <option value="S100_PR_AreaFill">S100_PR_AreaFill</option>
      <option value="S100_PR_Pixmap">S100_PR_Pixmap</option>
      <option value="S100_PR_ItemSchema">S100_PR_ItemSchema</option>
      <option value="S100_PR_DisplayMode">S100_PR_DisplayMode</option>
      <option value="S100_PR_ViewingGroupLayer">S100_PR_ViewingGroupLayer</option>
      <option value="S100_PR_ViewingGroup">S100_PR_ViewingGroup</option>
      <option value="S100_PR_AlertHighlight">S100_PR_AlertHighlight</option>
      <option value="S100_PR_AlertMessage">S100_PR_AlertMessage</option>
      <option value="S100_PR_ColourToken">S100_PR_ColourToken</option>
      <option value="S100_PR_ColourPalette">S100_PR_ColourPalette</option>
      <option value="S100_PR_Alert">S100_PR_Alert</option>
      <option value="S100_PR_PaletteItem">S100_PR_PaletteItem</option>
      <option value="S100_PR_Font">S100_PR_Font</option>
      <option value="S100_PR_ContextParameter">S100_PR_ContextParameter</option>
      <option value="S100_PR_DrawingPriority">S100_PR_DrawingPriority</option>
      <option value="S100_PR_DisplayPlane">S100_PR_DisplayPlane</option>
    </select>
  </label>

  <!-- ✅ 샘플 채우기 버튼 -->
  <button type="button" id="fillSample">Fill sample data (by kind)</button>
  <span id="fillMsg"></span>

  <h2>prItem (common)</h2>
  <div>
    <label>name: <input id="name" required /></label><br />
    <label>definition: <input id="definition" /></label><br />
    <label>remarks: <input id="remarks" /></label><br />
    <label>itemStatus: <input id="itemStatus" value="Draft" /></label><br />
    <label>alias (comma): <input id="alias" /></label><br />
    <label>camelCase: <input id="camelCase" /></label><br />
    <label>definitionSource: <input id="definitionSource" /></label><br />
    <label>reference: <input id="reference" /></label><br />
    <label>similarityToSource: <input id="similarityToSource" /></label><br />
    <label>justification: <input id="justification" /></label><br />
    <label>proposedChange: <input id="proposedChange" /></label><br />
  </div>

  <h2>Top-level PR fields</h2>
  <div>
    <label>xmlID: <input id="xmlID" /></label><br />
    <label>description JSON (array of {text,language}):</label><br />
    <textarea id="descriptionJson" rows="4" cols="80">[]</textarea><br />
  </div>

  <h2>Optional links (Visual kinds)</h2>
  <div>
    <label>itemSchema (ObjectId): <input id="itemSchema" /></label><br />
    <label>colourToken (ObjectId comma): <input id="colourToken" /></label><br />
  </div>

  <h2>kindBody JSON</h2>
  <p>
    This will be stored under the key == kind (e.g., item["S100_PR_Symbol"]).
  </p>
  <textarea id="kindBodyJson" rows="10" cols="80">{}</textarea>

  <h2>References</h2>
  <div>
    <label>referenceIds (ObjectId comma): <input id="referenceIds" /></label>
  </div>

  <h2>Initial ManagementInfo (required)</h2>
  <div>
    <label>proposalType: <input id="mi_proposalType" value="Addition" /></label><br />
    <label>submittingOrganisation: <input id="mi_submittingOrganisation" /></label><br />
    <label>proposedChange: <input id="mi_proposedChange" /></label><br />
    <label>proposalStatus: <input id="mi_proposalStatus" value="Draft" /></label><br />
    <label>controlBodyNotes (JSON array):</label><br />
    <textarea id="mi_controlBodyNotes" rows="3" cols="80">[]</textarea><br />
  </div>

  <hr />
  <button type="submit">Create</button>
  <span id="msg"></span>
</form>
{% endblock %}
{% block extra_scripts %}
<script>
  function splitCsv(s) {
    const v = (s || '').trim();
    if (!v) return [];
    return v.split(',').map(x => x.trim()).filter(Boolean);
  }

  async function loadRegisters() {
    const sel = document.getElementById('registerId');
    const res = await fetch('/api/registers?limit=200');
    const j = await res.json();
    (j.items || []).forEach(r => {
      const opt = document.createElement('option');
      opt.value = r._id;
      opt.textContent = `${r.name} (${r._id})`;
      sel.appendChild(opt);
    });
  }

  function parseJson(id, fallback) {
    const raw = document.getElementById(id).value.trim();
    if (!raw) return fallback;
    try {
      return JSON.parse(raw);
    } catch (e) {
      throw new Error(`${id} is not valid JSON`);
    }
  }

  // ---- sample fill helpers ----
  function nowSuffix() {
    const t = Date.now().toString();
    return t.slice(-6);
  }
  function setValue(id, value) {
    const el = document.getElementById(id);
    if (!el) return;
    el.value = value == null ? '' : String(value);
  }
  function setJson(id, obj) {
    setValue(id, JSON.stringify(obj, null, 2));
  }
  function isVisualKind(kind) {
    return ['S100_PR_Symbol','S100_PR_LineStyle','S100_PR_AreaFill','S100_PR_Pixmap'].includes(kind);
  }

  function buildSample(kind) {
    const sfx = nowSuffix();
    const common = {
      name: `${kind.replace('S100_PR_', '')}_${sfx}`,
      definition: `Sample definition for ${kind}`,
      remarks: `sample remarks (${kind})`,
      itemStatus: 'Draft',
      alias: [`alias_${sfx}`, `alias2_${sfx}`],
      camelCase: `${kind.replace('S100_PR_', '').toLowerCase()}${sfx}`,
      definitionSource: 'S-100 PR',
      reference: 'internal-prototype',
      similarityToSource: '1.0',
      justification: 'MVP sample fill',
      proposedChange: 'Initial creation (sample fill)'
    };

    const description = [
      { text: `Sample description for ${kind}`, language: 'en' },
      { text: `${kind} 샘플 설명`, language: 'ko' }
    ];

    const kindBodyByKind = {
      S100_PR_Symbol: {
        itemDetail: `storage/pr/symbol/${sfx}/detail.bin`,
        previewImage: `storage/pr/symbol/${sfx}/preview.png`,
        engineeringImage: `storage/pr/symbol/${sfx}/engineering.png`,
        previewType: 'png',
        engineeringImageType: 'png'
      },
      S100_PR_LineStyle: {
        itemDetail: `storage/pr/linestyle/${sfx}/detail.bin`,
        previewImage: `storage/pr/linestyle/${sfx}/preview.png`,
        engineeringImage: `storage/pr/linestyle/${sfx}/engineering.png`,
        previewType: 'png',
        engineeringImageType: 'png',
        symbol: []
      },
      S100_PR_AreaFill: {
        itemDetail: `storage/pr/areafill/${sfx}/detail.bin`,
        previewImage: `storage/pr/areafill/${sfx}/preview.png`,
        engineeringImage: `storage/pr/areafill/${sfx}/engineering.png`,
        previewType: 'png',
        engineeringImageType: 'png',
        symbol: []
      },
      S100_PR_Pixmap: {
        itemDetail: `storage/pr/pixmap/${sfx}/detail.bin`,
        previewImage: `storage/pr/pixmap/${sfx}/preview.png`,
        engineeringImage: `storage/pr/pixmap/${sfx}/engineering.png`,
        previewType: 'png',
        engineeringImageType: 'png'
      },
      S100_PR_ItemSchema: {
        schemaKind: 'S100_PR_SymbolSchema',
        xmlSchema: `storage/pr/schema/${sfx}/symbol_schema.xsd`
      },
      S100_PR_DisplayMode: {},
      S100_PR_ViewingGroupLayer: { displayMode: [] },
      S100_PR_ViewingGroup: { foundationMode: true, viewingGroup: [] },
      S100_PR_AlertHighlight: { optional: false, style: 'AlarmHighlight', viewingGroup: [], msg: [] },
      S100_PR_AlertMessage: {
        text: [{ text: 'Sample alert message', language: 'en' }, { text: '샘플 경고 메시지', language: 'ko' }],
        icon: null
      },
      S100_PR_ColourToken: { token: `CT_${sfx}`, value: [] },
      S100_PR_ColourPalette: {},
      S100_PR_Alert: {
        routeMonitor: [{ priority: { priority: 'warning', default: true, optional: false } }],
        routePlan: [{ priority: { priority: 'caution', default: false, optional: true } }]
      },
      S100_PR_PaletteItem: {
        transparency: 0.5,
        colour: { cieValue: { x: 0.1, y: 0.2, z: 0.3 }, sRGBValue: { red: 255, green: 128, blue: 0 } },
        palette: []
      },
      S100_PR_Font: { fontFile: `storage/pr/font/${sfx}/NotoSans-Regular.ttf`, fontType: 'ttf' },
      S100_PR_ContextParameter: { parameterType: 'string', defaultValue: 'default' },
      S100_PR_DrawingPriority: { priority: 10 },
      S100_PR_DisplayPlane: { order: 1 }
    };

    const kindBody = kindBodyByKind[kind] ?? {};
    const visualLinks = isVisualKind(kind)
      ? { itemSchema: '000000000000000000000000', colourToken: [] }
      : { itemSchema: '', colourToken: [] };

    return { prItem: common, xmlID: `${kind}:${sfx}`, description, kindBody, visualLinks };
  }

  function fillSample() {
    const kind = document.getElementById('kind').value.trim();
    const sample = buildSample(kind);

    setValue('name', sample.prItem.name);
    setValue('definition', sample.prItem.definition);
    setValue('remarks', sample.prItem.remarks);
    setValue('itemStatus', sample.prItem.itemStatus);
    setValue('alias', sample.prItem.alias.join(','));
    setValue('camelCase', sample.prItem.camelCase);
    setValue('definitionSource', sample.prItem.definitionSource);
    setValue('reference', sample.prItem.reference);
    setValue('similarityToSource', sample.prItem.similarityToSource);
    setValue('justification', sample.prItem.justification);
    setValue('proposedChange', sample.prItem.proposedChange);

    setValue('xmlID', sample.xmlID);
    setJson('descriptionJson', sample.description);

    setValue('itemSchema', sample.visualLinks.itemSchema);
    setValue('colourToken', (sample.visualLinks.colourToken || []).join(','));
    setJson('kindBodyJson', sample.kindBody);

    setValue('mi_submittingOrganisation', 'DemoOrg');
    setValue('mi_proposedChange', `Create ${kind} (sample fill)`);

    const fillMsg = document.getElementById('fillMsg');
    if (fillMsg) fillMsg.textContent = ` filled for ${kind}`;
    setTimeout(() => { if (fillMsg) fillMsg.textContent = ''; }, 1200);
  }

  // ✅ 핵심: DOMContentLoaded 이후에 요소 잡고 리스너 등록
  document.addEventListener('DOMContentLoaded', () => {
    console.log('[pr_new] DOM loaded');

    const btn = document.getElementById('fillSample');
    if (!btn) {
      console.error('[pr_new] fillSample button not found. Check id="fillSample" in HTML.');
    } else {
      btn.addEventListener('click', () => {
        console.log('[pr_new] fillSample clicked');
        try {
          fillSample();
        } catch (e) {
          console.error(e);
          const fillMsg = document.getElementById('fillMsg');
          if (fillMsg) fillMsg.textContent = ' fill failed: ' + (e.message || e);
        }
      });
    }

    const kindSel = document.getElementById('kind');
    if (kindSel) {
      kindSel.addEventListener('change', () => {
        setValue('kindBodyJson', '{}');
        setValue('itemSchema', '');
        setValue('colourToken', '');
      });
    }

    const form = document.getElementById('form');
    if (form) {
      form.addEventListener('submit', async (e) => {
        e.preventDefault();
        const msg = document.getElementById('msg');
        msg.textContent = '';

        try {
          const payload = {
            registerId: document.getElementById('registerId').value.trim(),
            kind: document.getElementById('kind').value.trim(),
            prItem: {
              name: document.getElementById('name').value.trim(),
              definition: document.getElementById('definition').value.trim() || null,
              remarks: document.getElementById('remarks').value.trim() || null,
              itemStatus: document.getElementById('itemStatus').value.trim() || null,
              alias: splitCsv(document.getElementById('alias').value),
              camelCase: document.getElementById('camelCase').value.trim() || null,
              definitionSource: document.getElementById('definitionSource').value.trim() || null,
              reference: document.getElementById('reference').value.trim() || null,
              similarityToSource: document.getElementById('similarityToSource').value.trim() || null,
              justification: document.getElementById('justification').value.trim() || null,
              proposedChange: document.getElementById('proposedChange').value.trim() || null,
            },
            xmlID: document.getElementById('xmlID').value.trim() || null,
            description: parseJson('descriptionJson', []),
            itemSchema: document.getElementById('itemSchema').value.trim() || null,
            colourToken: splitCsv(document.getElementById('colourToken').value),
            kindBody: parseJson('kindBodyJson', {}),
            referenceIds: splitCsv(document.getElementById('referenceIds').value),
            managementInfos: [{
              proposalType: document.getElementById('mi_proposalType').value.trim() || 'Addition',
              submittingOrganisation: document.getElementById('mi_submittingOrganisation').value.trim() || '',
              proposedChange: document.getElementById('mi_proposedChange').value.trim() || '',
              dateProposed: new Date().toISOString(),
              proposalStatus: document.getElementById('mi_proposalStatus').value.trim() || 'Draft',
              controlBodyNotes: parseJson('mi_controlBodyNotes', []),
            }]
          };

          if (!payload.registerId) {
            msg.textContent = 'Register is required.';
            return;
          }

          const res = await fetch('/api/pr/items', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(payload)
          });

          const j = await res.json();
          if (!res.ok) {
            msg.textContent = 'Failed: ' + (j.detail || JSON.stringify(j));
            return;
          }

          window.location.href = '/ui/pr/' + j._id;
        } catch (err) {
          console.error(err);
          msg.textContent = String(err.message || err);
        }
      });
    }

    loadRegisters();
  });
</script>
{% endblock %}
