{% extends "base.html" %}

{% block title %}Data Dictionary Register{% endblock %}

{% block extra_styles %}
<style>
  * { margin:0; padding:0; box-sizing:border-box; }
  :root { --primary:#2563eb; --primary-hover:#1d4ed8; --bg:#f8fafc; --card-bg:#fff; --text:#1e293b; --text-muted:#64748b; --border:#e2e8f0; --success:#10b981; --warning:#f59e0b; --info:#06b6d4; --danger:#ef4444; --radius:8px; }
  body { font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,'Helvetica Neue',Arial,sans-serif; background:var(--bg); color:var(--text); line-height:1.6; }
  .container { max-width:1400px; margin:0 auto; padding:24px; }
  .page-header { margin-bottom:24px; display:flex; justify-content:space-between; align-items:center; flex-wrap:wrap; gap:16px; }
  .breadcrumb { display:flex; align-items:center; gap:8px; font-size:14px; color:var(--text-muted); margin-bottom:16px; }
  .breadcrumb a { color:var(--text-muted); text-decoration:none; transition:color .2s; }
  .breadcrumb a:hover { color:var(--primary); }
  .breadcrumb .current { color:var(--primary); font-weight:500; }
  .page-title { font-size:28px; font-weight:700; color:var(--text); }

  .stats-grid { display:grid; grid-template-columns:repeat(auto-fit,minmax(160px,1fr)); gap:16px; margin-bottom:24px; }
  .stat-card { background:var(--card-bg); border-radius:var(--radius); padding:20px; border:1px solid var(--border); cursor:pointer; transition:all .2s ease; position:relative; overflow:hidden; }
  .stat-card::before { content:''; position:absolute; left:0; top:0; bottom:0; width:4px; background:var(--stat-color,var(--primary)); }
  .stat-card:hover { transform:translateY(-2px); box-shadow:0 4px 12px rgba(0,0,0,.08); }
  .stat-card.active { border-color:var(--stat-color,var(--primary)); background:linear-gradient(135deg,rgba(37,99,235,.05) 0%,transparent 100%); }
  .stat-card .label { font-size:13px; color:var(--text-muted); font-weight:500; margin-bottom:4px; }
  .stat-card .value { font-size:24px; font-weight:700; color:var(--stat-color,var(--primary)); }

  .filter-section { background:var(--card-bg); border-radius:var(--radius); padding:20px; margin-bottom:24px; border:1px solid var(--border); }
  .filter-row { display:flex; flex-wrap:wrap; gap:16px; align-items:flex-end; }
  .filter-group { display:flex; flex-direction:column; gap:6px; min-width:150px; }
  .filter-group label { font-size:13px; font-weight:500; color:var(--text-muted); }
  .filter-group select,.filter-group input { padding:10px 14px; border:1px solid var(--border); border-radius:var(--radius); font-size:14px; background:var(--card-bg); color:var(--text); transition:all .2s; }
  .filter-group select:focus,.filter-group input:focus { outline:none; border-color:var(--primary); box-shadow:0 0 0 3px rgba(37,99,235,.1); }
  .search-wrapper { position:relative; flex:1; min-width:250px; }
  .search-wrapper svg { position:absolute; left:12px; top:50%; transform:translateY(-50%); color:var(--text-muted); }
  .search-wrapper input { padding-left:40px; width:100%; }

  .btn { display:inline-flex; align-items:center; gap:8px; padding:10px 16px; border-radius:var(--radius); font-size:14px; font-weight:500; cursor:pointer; transition:all .2s; border:1px solid transparent; }
  .btn svg { width:16px; height:16px; }
  .btn-primary { background:var(--primary); color:#fff; }
  .btn-primary:hover { background:var(--primary-hover); }
  .btn-outline { background:transparent; border-color:var(--border); color:var(--text); }
  .btn-outline:hover { background:var(--bg); border-color:var(--primary); color:var(--primary); }
  .btn-success { background:var(--success); color:#fff; }
  .btn-success:hover { background:#059669; }

  .table-section { background:var(--card-bg); border-radius:var(--radius); border:1px solid var(--border); overflow:hidden; }
  .table-header { padding:16px 20px; border-bottom:1px solid var(--border); display:flex; justify-content:space-between; align-items:center; gap:12px; }
  .table-info { color:var(--text-muted); font-size:14px; }
  .table-container { overflow:auto; }
  table { width:100%; border-collapse:collapse; }
  thead th { text-align:left; padding:14px 16px; font-size:13px; color:var(--text-muted); font-weight:600; background:var(--bg); border-bottom:1px solid var(--border); cursor:pointer; user-select:none; white-space:nowrap; }
  tbody td { padding:14px 16px; border-bottom:1px solid var(--border); vertical-align:middle; }
  tbody tr:hover { background:rgba(37,99,235,.04); }
  .sort-icon { margin-left:6px; font-size:12px; }
  .truncate { max-width:360px; overflow:hidden; text-overflow:ellipsis; white-space:nowrap; }
  .badge { display:inline-flex; align-items:center; padding:4px 10px; border-radius:999px; font-size:12px; font-weight:600; }
  .badge.draft { background:rgba(6,182,212,.15); color:var(--info); }
  .badge.valid { background:rgba(16,185,129,.15); color:var(--success); }
  .badge.deprecated { background:rgba(239,68,68,.15); color:var(--danger); }
  .table-footer { padding:14px 20px; display:flex; justify-content:space-between; align-items:center; gap:12px; }
  .rows-per-page { display:flex; align-items:center; gap:8px; color:var(--text-muted); font-size:14px; }
  .pagination { display:flex; gap:6px; align-items:center; flex-wrap:wrap; justify-content:flex-end; }
  .pagination button { min-width:34px; height:34px; border-radius:8px; border:1px solid var(--border); background:#fff; cursor:pointer; }
  .pagination button.active { border-color:var(--primary); color:var(--primary); font-weight:700; }
  .pagination button:disabled { opacity:.5; cursor:not-allowed; }
  .empty-state { padding:36px 16px; text-align:center; color:var(--text-muted); }
  @media (max-width:768px){ .container{padding:16px} .page-title{font-size:22px} .stats-grid{grid-template-columns:repeat(2,1fr)} .filter-row{flex-direction:column} .filter-group{width:100%} .search-wrapper{width:100%} .table-footer{flex-direction:column; align-items:stretch} .pagination{justify-content:center} }
</style>

<script>
  window.__DD_INITIAL__ = {
    total: {{ initial_total | default(0) }},
    items: {{ initial_items_json | safe }},
    stats: {{ initial_stats_json | safe }}
  };
</script>
{% endblock %}

{% block content %}
<div class="container">
  <header class="page-header">
    <div>
      <nav class="breadcrumb">
        <a href="/">Home</a>
        <span>/</span>
        <span class="current">Data Dictionary Register</span>
      </nav>
      <h1 class="page-title">Data Dictionary Register</h1>
    </div>
    <button class="btn btn-success" id="btnNew">
      <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
        <line x1="12" y1="5" x2="12" y2="19"></line>
        <line x1="5" y1="12" x2="19" y2="12"></line>
      </svg>
      New DDR Item
    </button>
  </header>

  <!-- Stats Cards -->
  <section class="stats-grid">
    <div class="stat-card active" data-kind="" style="--stat-color:#2563eb">
      <div class="label">All</div>
      <div class="value">{{ initial_total | default(0) }}</div>
    </div>

    <div class="stat-card" data-kind="feature" style="--stat-color:#2563eb">
      <div class="label">Feature</div>
      <div class="value">{{ initial_stats.feature | default(0) }}</div>
    </div>
    <div class="stat-card" data-kind="information" style="--stat-color:#06b6d4">
      <div class="label">Information</div>
      <div class="value">{{ initial_stats.information | default(0) }}</div>
    </div>
    <div class="stat-card" data-kind="simpleAttribute" style="--stat-color:#8b5cf6">
      <div class="label">Simple Attribute</div>
      <div class="value">{{ initial_stats.simpleAttribute | default(0) }}</div>
    </div>

    <div class="stat-card" data-kind="complexAttribute" style="--stat-color:#6366f1">
      <div class="label">Complex Attribute</div>
      <div class="value">{{ initial_stats.complexAttribute | default(0) }}</div>
    </div>
    <div class="stat-card" data-kind="enumeratedValue" style="--stat-color:#f59e0b">
      <div class="label">Enumerated Value</div>
      <div class="value">{{ initial_stats.enumeratedValue | default(0) }}</div>
    </div>
  </section>

  <!-- Filters -->
  <section class="filter-section">
    <div class="filter-row">
      <div class="filter-group">
        <label for="status-filter">Status</label>
        <select id="status-filter">
          <option value="" selected>All Status</option>
          <option value="Draft">Draft</option>
          <option value="Valid">Valid</option>
          <option value="Pending">Pending</option>
          <option value="Deprecated">Deprecated</option>
        </select>
      </div>

      <div class="filter-group">
        <label for="category-filter">Search By</label>
        <select id="category-filter">
          <option value="name">Name</option>
          <option value="itemIdentifier">Item ID</option>
        </select>
      </div>

      <div class="filter-group search-wrapper">
        <label for="search-input">Search</label>
        <div class="search-wrapper">
          <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <circle cx="11" cy="11" r="8"></circle>
            <line x1="21" y1="21" x2="16.65" y2="16.65"></line>
          </svg>
          <input type="text" id="search-input" placeholder="Search items.">
        </div>
      </div>

      <button class="btn btn-primary" onclick="applyFilters()">
        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
          <circle cx="11" cy="11" r="8"></circle>
          <line x1="21" y1="21" x2="16.65" y2="16.65"></line>
        </svg>
        Search
      </button>
      <button class="btn btn-outline" onclick="resetFilters()">Reset</button>
    </div>
  </section>

  <!-- Data Table -->
  <section class="table-section">
    <div class="table-header">
      <div class="table-info">
        Showing <strong><span id="showing-start">1</span>-<span id="showing-end">20</span></strong>
        of <strong><span id="total-items">{{ initial_total | default(0) }}</span></strong> items
      </div>
      <div class="table-actions">
        <button class="btn btn-outline" onclick="exportData()">
          <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
            <polyline points="7 10 12 15 17 10"></polyline>
            <line x1="12" y1="15" x2="12" y2="3"></line>
          </svg>
          Export
        </button>
      </div>
    </div>

    <div class="table-container">
      <table>
        <thead>
          <tr>
            <th onclick="sortTable('itemIdentifier')" class="sorted">Item ID <span class="sort-icon">&#8595;</span></th>
            <th onclick="sortTable('name')">Name <span class="sort-icon">&#8597;</span></th>
            <th onclick="sortTable('camelCase')">Camelcase <span class="sort-icon">&#8597;</span></th>
            <th onclick="sortTable('definition')">Definition <span class="sort-icon">&#8597;</span></th>
            <th onclick="sortTable('kind')">Kind <span class="sort-icon">&#8597;</span></th>
            <th onclick="sortTable('itemStatus')">Status <span class="sort-icon">&#8597;</span></th>
            <th onclick="sortTable('updatedAt')">Date <span class="sort-icon">&#8597;</span></th>
          </tr>
        </thead>
        <tbody id="table-body"></tbody>
      </table>
    </div>

    <div class="table-footer">
      <div class="rows-per-page">
        <span>Rows per page:</span>
        <select id="rows-per-page" onchange="changeRowsPerPage()">
          <option value="10">10</option>
          <option value="20" selected>20</option>
          <option value="50">50</option>
          <option value="100">100</option>
        </select>
      </div>
      <div class="pagination" id="pagination"></div>
    </div>
  </section>
</div>
{% endblock %}

{% block extra_scripts %}
<script>
  // State
  let currentPage = 1;
  let rowsPerPage = 20;
  let sortColumn = "itemIdentifier";
  let sortDirection = "desc";
  let activeKind = "";
  let totalItems = window.__DD_INITIAL__?.total ?? 0;
  let currentData = (window.__DD_INITIAL__?.items ?? []).map(normalizeItem);

  document.addEventListener("DOMContentLoaded", () => {
    const rpp = document.getElementById("rows-per-page");
    if (rpp && rpp.value) rowsPerPage = parseInt(rpp.value, 10) || 20;

    setupStatCardListeners();
    setupSearchEnterListener();
    renderTable();
  });

  // Helpers
  function escapeHtml(s) {
    const str = String(s ?? "");
    return str
      .replaceAll("&", "&amp;")
      .replaceAll("<", "&lt;")
      .replaceAll(">", "&gt;")
      .replaceAll('"', "&quot;")
      .replaceAll("'", "&#039;");
  }

  function getStatusClass(status) {
    const s = String(status || "").toLowerCase();
    if (s === "draft") return "draft";
    if (s === "valid") return "valid";
    if (s === "deprecated") return "deprecated";
    return "draft";
  }

  function normalizeItem(raw) {
    const id = raw._id ?? raw.id ?? raw.itemIdentifier;
    const c = raw.concept || {};
    return {
      id,
      itemIdentifier: c.itemIdentifier ?? '',
      name: c.name ?? '',
      camelCase: c.camelCase ?? c.camelcase ?? '',
      definition: c.definition ?? '',
      kind: raw.kind ?? '',
      status: c.itemStatus ?? '',
      date: raw.updatedAt ?? raw.createdAt ?? null,
    };
  }

  function formatDate(val) {
    if (!val) return "";
    const d = new Date(val);
    if (isNaN(d.getTime())) return String(val);
    const yyyy = d.getFullYear();
    const mm = String(d.getMonth() + 1).padStart(2, "0");
    const dd = String(d.getDate()).padStart(2, "0");
    return `${yyyy}-${mm}-${dd}`;
  }

  function getFiltersFromUI() {
    const status = document.getElementById("status-filter")?.value || "";
    const searchBy = document.getElementById("category-filter")?.value || "name";
    const q = document.getElementById("search-input")?.value?.trim() || "";
    return { status, searchBy, q };
  }

  function buildQueryParams() {
    const { status, searchBy, q } = getFiltersFromUI();
    const params = new URLSearchParams();

    params.set("page", String(currentPage));
    params.set("limit", String(rowsPerPage));
    params.set("sortBy", sortColumn);
    params.set("sortOrder", sortDirection);

    if (status) params.set("status", status);
    if (q) {
      params.set("q", q);
      params.set("searchBy", searchBy);
    }
    if (activeKind) params.set("kind", activeKind);

    return params.toString();
  }

  async function fetchItems() {
    const qs = buildQueryParams();
    const res = await fetch(`/api/dd/items?${qs}`, { headers: { "Accept": "application/json" } });
    if (!res.ok) throw new Error(`API error ${res.status}: ${await res.text()}`);
    const data = await res.json();

    const items = Array.isArray(data.items) ? data.items : [];
    totalItems = typeof data.total === "number" ? data.total : items.length;
    currentData = items.map(normalizeItem);
  }

  async function fetchAndRender() {
    const tbody = document.getElementById("table-body");
    if (tbody) {
      tbody.innerHTML = `
        <tr><td colspan="7">
          <div class="empty-state"><h3>Loading...</h3><p>Fetching items from API</p></div>
        </td></tr>
      `;
    }

    try {
      await fetchItems();
      renderTable();
    } catch (err) {
      console.error(err);
      totalItems = 0;
      currentData = [];
      renderTable(`Failed to load: ${String(err.message || err)}`);
    }
  }

  // UI actions
  function setupStatCardListeners() {
    const cards = document.querySelectorAll(".stat-card");
    cards.forEach(card => {
      card.addEventListener("click", function() {
        cards.forEach(c => c.classList.remove("active"));
        this.classList.add("active");
        activeKind = this.dataset.kind || "";
        currentPage = 1;
        fetchAndRender();
      });
    });
  }

  function setupSearchEnterListener() {
    const input = document.getElementById("search-input");
    if (!input) return;
    input.addEventListener("keypress", e => {
      if (e.key === "Enter") applyFilters();
    });
  }

  function applyFilters() {
    currentPage = 1;
    fetchAndRender();
  }

  function resetFilters() {
    const s = document.getElementById("status-filter");
    const c = document.getElementById("category-filter");
    const q = document.getElementById("search-input");

    if (s) s.value = "";
    if (c) c.value = "name";
    if (q) q.value = "";

    activeKind = "";
    document.querySelectorAll(".stat-card").forEach(card => card.classList.remove("active"));
    document.querySelector('.stat-card[data-kind=""]')?.classList.add("active");

    currentPage = 1;
    fetchAndRender();
  }

  function changeRowsPerPage() {
    const v = document.getElementById("rows-per-page")?.value;
    rowsPerPage = parseInt(v, 10) || 20;
    currentPage = 1;
    fetchAndRender();
  }

  function sortTable(column) {
    document.querySelectorAll("th").forEach(th => {
      th.classList.remove("sorted");
      const icon = th.querySelector(".sort-icon");
      if (icon) icon.innerHTML = "&#8597;";
    });

    if (sortColumn === column) {
      sortDirection = sortDirection === "asc" ? "desc" : "asc";
    } else {
      sortColumn = column;
      sortDirection = "asc";
    }

    const header = document.querySelector(`th[onclick="sortTable('${column}')"]`);
    if (header) {
      header.classList.add("sorted");
      const icon = header.querySelector(".sort-icon");
      if (icon) icon.innerHTML = sortDirection === "asc" ? "&#8593;" : "&#8595;";
    }

    currentPage = 1;
    fetchAndRender();
  }

  function changePage(page) {
    const totalPages = Math.max(1, Math.ceil(totalItems / rowsPerPage));
    if (page < 1 || page > totalPages) return;
    currentPage = page;
    fetchAndRender();
    document.querySelector(".table-section")?.scrollIntoView({ behavior: "smooth", block: "start" });
  }

  function updateInfo() {
    const start = totalItems === 0 ? 0 : (currentPage - 1) * rowsPerPage + 1;
    const end = Math.min(currentPage * rowsPerPage, totalItems);

    document.getElementById("showing-start").textContent = String(start);
    document.getElementById("showing-end").textContent = String(end);
    document.getElementById("total-items").textContent = String(totalItems);
  }

  function updatePagination() {
    const pagination = document.getElementById("pagination");
    if (!pagination) return;

    const totalPages = Math.max(1, Math.ceil(totalItems / rowsPerPage));
    if (totalPages <= 1) { pagination.innerHTML = ""; return; }

    let html = `
      <button onclick="changePage(${currentPage - 1})" ${currentPage === 1 ? "disabled" : ""}>&lt;</button>
    `;

    const maxVisiblePages = 5;
    let startPage = Math.max(1, currentPage - Math.floor(maxVisiblePages / 2));
    let endPage = Math.min(totalPages, startPage + maxVisiblePages - 1);
    if (endPage - startPage + 1 < maxVisiblePages) startPage = Math.max(1, endPage - maxVisiblePages + 1);

    if (startPage > 1) {
      html += `<button onclick="changePage(1)">1</button>`;
      if (startPage > 2) html += `<span class="ellipsis">...</span>`;
    }

    for (let i = startPage; i <= endPage; i++) {
      html += `<button onclick="changePage(${i})" class="${i === currentPage ? "active" : ""}">${i}</button>`;
    }

    if (endPage < totalPages) {
      if (endPage < totalPages - 1) html += `<span class="ellipsis">...</span>`;
      html += `<button onclick="changePage(${totalPages})">${totalPages}</button>`;
    }

    html += `
      <button onclick="changePage(${currentPage + 1})" ${currentPage === totalPages ? "disabled" : ""}>&gt;</button>
    `;

    pagination.innerHTML = html;
  }

  function renderTable(errorMsg) {
    const tbody = document.getElementById("table-body");
    if (!tbody) return;

    if (errorMsg) {
      tbody.innerHTML = `<tr><td colspan="7"><div class="empty-state"><h3>${escapeHtml(errorMsg)}</h3></div></td></tr>`;
      updateInfo();
      updatePagination();
      return;
    }

    if (!currentData || currentData.length === 0) {
      tbody.innerHTML = `<tr><td colspan="7"><div class="empty-state"><h3>No items</h3></div></td></tr>`;
      updateInfo();
      updatePagination();
      return;
    }

    tbody.innerHTML = currentData.map(item => `
      <tr data-item-id="${escapeHtml(item.id)}"
          onclick="window.location.href='/ui/dd/${escapeHtml(item.id)}'"
          style="cursor:pointer;">
        <td><span class="item-id">${escapeHtml(item.itemIdentifier)}</span></td>
        <td>
          <a class="item-name" href="/ui/dd/${escapeHtml(item.id)}" style="text-decoration:none;">
            ${escapeHtml(item.name)}
          </a>
        </td>
        <td class="truncate"><span class="camelcase">${escapeHtml(item.camelCase)}</span></td>
        <td class="truncate" title="${escapeHtml(item.definition)}">${escapeHtml(item.definition)}</td>
        <td>${escapeHtml(item.kind)}</td>
        <td><span class="badge ${getStatusClass(item.status)}">${escapeHtml(item.status)}</span></td>
        <td><span class="date">${escapeHtml(formatDate(item.date))}</span></td>
      </tr>
    `).join("");

    updateInfo();
    updatePagination();
  }

  
  document.getElementById('btnNew').addEventListener('click', () => {
    window.location.href = '/ui/dd/new';
  });

  function exportData() {
    alert("Export feature coming soon (CSV/Excel etc.).");
  }
</script>
{% endblock %}
