{% extends "base.html" %}

{% block title %}Data Dictionary - New{% endblock %}

{% block extra_styles %}
<style>
    *{margin:0;padding:0;box-sizing:border-box}
    :root{--primary:#2563eb;--primary-hover:#1d4ed8;--bg:#f8fafc;--card:#fff;--text:#1e293b;--muted:#64748b;--border:#e2e8f0;--radius:12px;--danger:#ef4444;--success:#10b981}
    body{font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,Arial,sans-serif;background:var(--bg);color:var(--text);line-height:1.6}
    .container{max-width:1100px;margin:0 auto;padding:24px}
    .breadcrumb{display:flex;align-items:center;gap:8px;font-size:14px;color:var(--muted);margin-bottom:14px}
    .breadcrumb a{color:var(--muted);text-decoration:none}
    .breadcrumb a:hover{color:var(--primary)}
    .top{display:flex;justify-content:space-between;align-items:flex-start;gap:12px;flex-wrap:wrap;margin-bottom:16px}
    .title h1{font-size:28px;font-weight:900}
    .title .sub{font-size:14px;color:var(--muted)}
    .banner{border:1px solid rgba(37,99,235,.25);background:rgba(37,99,235,.08);color:#1e40af;border-radius:12px;padding:10px 12px;margin-bottom:12px;font-weight:700}
    .card{background:var(--card);border:1px solid var(--border);border-radius:var(--radius);overflow:hidden;margin-bottom:12px}
    .card-h{padding:12px 16px;border-bottom:1px solid var(--border);background:#fafbff;font-weight:900;display:flex;justify-content:space-between;align-items:center;gap:10px}
    .card-b{padding:14px 16px}
    .grid{display:grid;grid-template-columns:1fr 1fr;gap:12px}
    @media(max-width:900px){.grid{grid-template-columns:1fr}}
    label{font-size:13px;color:var(--muted);font-weight:800}
    .req{color:var(--danger)}
    input,select,textarea{width:100%;padding:10px 12px;border:1px solid var(--border);border-radius:10px;font-size:14px;background:#fff;color:var(--text)}
    textarea{min-height:96px;resize:vertical}
    input:focus,select:focus,textarea:focus{outline:none;border-color:rgba(37,99,235,.7);box-shadow:0 0 0 3px rgba(37,99,235,.12)}
    .hint{font-size:12px;color:var(--muted);margin-top:6px}
    .actions{display:flex;gap:10px;flex-wrap:wrap;justify-content:flex-end;margin-top:10px}
    .btn{display:inline-flex;align-items:center;justify-content:center;gap:8px;padding:10px 14px;border-radius:10px;border:1px solid var(--border);background:#fff;color:var(--text);font-weight:900;cursor:pointer;text-decoration:none}
    .btn.primary{background:var(--primary);border-color:var(--primary);color:#fff}
    .btn.primary:hover{background:var(--primary-hover)}
    .btn.ghost:hover{border-color:rgba(37,99,235,.35);color:var(--primary)}

    /* refs */
    .dyn{border:1px solid var(--border);border-radius:12px;overflow:hidden}
    .dyn-h{display:flex;justify-content:space-between;align-items:center;padding:10px 12px;background:var(--bg);border-bottom:1px solid var(--border)}
    .dyn-title{font-size:12px;color:var(--muted);font-weight:900;text-transform:uppercase;letter-spacing:.4px}
    .dyn-b{max-height:320px;overflow:auto}
    .dyn-empty{padding:16px 12px;color:var(--muted);font-size:13px;text-align:center}
    .dyn-item{display:flex;gap:10px;align-items:flex-start;padding:10px 12px;border-bottom:1px solid var(--border)}
    .dyn-item:last-child{border-bottom:none}
    .num{width:22px;height:22px;border-radius:999px;background:var(--primary);color:#fff;display:flex;align-items:center;justify-content:center;font-weight:900;font-size:12px;flex:0 0 auto;margin-top:2px}
    .remove{border:none;background:transparent;color:var(--danger);font-weight:900;cursor:pointer;padding:6px 8px;border-radius:8px}
    .remove:hover{background:rgba(239,68,68,.08)}

    .toast{position:fixed;bottom:22px;right:22px;background:#0f172a;color:#fff;padding:12px 14px;border-radius:12px;opacity:0;transform:translateY(12px);transition:.2s;z-index:9999;font-weight:800}
    .toast.show{opacity:1;transform:translateY(0)}
    .toast.success{background:var(--success)}
    .toast.error{background:var(--danger)}

    /* Convert mode: concept card readonly styling */
    #conceptCard.convert-mode input,
    #conceptCard.convert-mode select,
    #conceptCard.convert-mode textarea {
      background: #f1f5f9;
      color: #64748b;
      cursor: not-allowed;
    }
    #conceptCard .convert-notice {
      display: none;
      padding: 8px 12px;
      background: rgba(37,99,235,.08);
      border: 1px solid rgba(37,99,235,.2);
      border-radius: 8px;
      font-size: 13px;
      color: #1e40af;
      margin-bottom: 12px;
    }
    #conceptCard.convert-mode .convert-notice {
      display: block;
    }
</style>
{% endblock %}

{% block content %}
<div class="container">
    <nav class="breadcrumb">
      <a href="/">Home</a><span>/</span>
      <a href="/ui/dd">Data Dictionary Register</a><span>/</span>
      <span>New</span>
    </nav>

    <div class="top">
      <div class="title">
        <h1 id="pageTitle">Create Item</h1>
        <div class="sub" id="pageSub">S-100 Part 2a 스타일: kind + concept + typed body</div>
      </div>
      <div class="actions">
        <a class="btn ghost" href="/ui/dd">Back</a>
        <button class="btn primary" form="createForm" type="submit" id="submitBtn">Create</button>
      </div>
    </div>

    <div class="banner" id="convertBanner" style="display:none;">Convert mode: Concept를 선택한 타입으로 변환합니다. (Convert는 typed body만 추가/변경합니다. Concept 수정/참조 수정은 변환 후 Edit에서 해주세요.)</div>

    <form id="createForm">
      <div class="card">
        <div class="card-h">Basic</div>
        <div class="card-b">
          <div class="grid">
            <div>
              <label>Register <span class="req">*</span></label>
              <select id="registerSelect" required></select>
              <div class="hint">레지스터가 없으면 <a href="/ui/registers/new" style="color:var(--primary);font-weight:900;text-decoration:none;">+ create register</a></div>
            </div>
            <div>
              <label>Kind <span class="req">*</span></label>
              <select id="kindSelect" required>
                <option value="S100_Concept">S100_Concept (Concept only)</option>
                <option value="S100_CD_Feature">S100_CD_Feature</option>
                <option value="S100_CD_Information">S100_CD_Information</option>
                <option value="S100_CD_EnumeratedValue">S100_CD_EnumeratedValue</option>
                <option value="S100_CD_SimpleAttribute">S100_CD_SimpleAttribute</option>
                <option value="S100_CD_ComplexAttribute">S100_CD_ComplexAttribute</option>
              </select>
            </div>

            <!-- Existing Concept Selector (visible when kind != S100_Concept) -->
            <div id="existingConceptWrap" style="display:none;grid-column:1/-1;">
              <label>Use Existing Concept</label>
              <select id="existingConceptSelect">
                <option value="">-- Create new concept manually --</option>
              </select>
              <div class="hint">DDR에 아직 바인딩되지 않은 Concept 목록입니다. 선택하면 아래 폼이 자동으로 채워집니다.</div>
            </div>
          </div>
        </div>
      </div>

      <div class="card" id="conceptCard">
        <div class="card-h">Concept</div>
        <div class="card-b">
          <div class="convert-notice">
            기존 Concept을 사용합니다. Concept 정보는 수정되지 않으며, Typed Body만 추가됩니다.
          </div>
          <div class="grid">
            <div>
              <label>Item Identifier</label>
              <input id="itemIdentifier" placeholder="(auto assigned)" disabled />
              <div class="hint">itemIdentifier는 시스템이 순차 자동할당(불변)됩니다.</div>
            </div>
            <div>
              <label>Item Status <span class="req">*</span></label>
              <select id="itemStatus" required>
                <option value="Draft">Draft</option>
                <option value="Pending">Pending</option>
                <option value="Valid">Valid</option>
                <option value="Deprecated">Deprecated</option>
                <option value="Retired">Retired</option>
              </select>
            </div>

            <div style="grid-column:1/-1;">
              <label>Name <span class="req">*</span></label>
              <input id="name" required placeholder="Enter name" />
            </div>

            <div style="grid-column:1/-1;">
              <label>CamelCase</label>
              <input id="camelCase" placeholder="Auto-generate from name" />
            </div>

            <div style="grid-column:1/-1;">
              <label>Alias</label>
              <input id="alias" placeholder="comma separated" />
            </div>

            <div style="grid-column:1/-1;">
              <label>Definition</label>
              <textarea id="definition" placeholder="definition (optional)"></textarea>
            </div>

            <div style="grid-column:1/-1;">
              <label>Remarks</label>
              <textarea id="remarks" placeholder="remarks (optional)"></textarea>
            </div>

            <div>
              <label>Definition Source</label>
              <input id="definitionSource" placeholder="e.g., S-101" />
            </div>
            <div>
              <label>Similarity To Source</label>
              <input id="similarityToSource" placeholder="optional" />
            </div>

            <div style="grid-column:1/-1;">
              <label>Reference</label>
              <input id="reference" placeholder="optional" />
            </div>

            <div style="grid-column:1/-1;">
              <label>Proposed Change</label>
              <textarea id="proposedChange" placeholder="optional"></textarea>
            </div>

            <div style="grid-column:1/-1;">
              <label>Justification</label>
              <textarea id="justification" placeholder="optional"></textarea>
            </div>
          </div>
        </div>
      </div>

      <div class="card" id="typedCard">
        <div class="card-h">Typed Body</div>
        <div class="card-b">
          <div class="grid">
            <div id="featureUseTypeWrap" style="display:none;">
              <label>featureUseType</label>
              <select id="featureUseType">
                <option value="geographic">geographic</option>
                <option value="meta" selected>meta</option>
                <option value="cartographic">cartographic</option>
                <option value="theme">theme</option>
              </select>
            </div>

            <div id="numericCodeWrap" style="display:none;">
              <label>numericCode</label>
              <input id="numericCode" placeholder="string (e.g., 10)" />
            </div>

            <div id="valueTypeWrap" style="display:none;">
              <label>valueType</label>
              <select id="valueType">
                <option value="boolean">boolean</option>
                <option value="enumeration">enumeration</option>
                <option value="integer">integer</option>
                <option value="real">real</option>
                <option value="date">date</option>
                <option value="text" selected>text</option>
                <option value="time">time</option>
                <option value="dateTime">dateTime</option>
                <option value="URI">URI</option>
                <option value="URL">URL</option>
                <option value="URN">URN</option>
                <option value="S100_CodeList">S100_CodeList</option>
                <option value="S100_TruncatedDate">S100_TruncatedDate</option>
              </select>
            </div>

            <div id="quantityWrap" style="display:none;">
              <label>quantitySpecification</label>
              <select id="quantitySpecification">
                <option value="">(none)</option>
                <option value="angularVelocity">angularVelocity</option>
                <option value="area">area</option>
                <option value="density">density</option>
                <option value="duration">duration</option>
                <option value="frequency">frequency</option>
                <option value="length">length</option>
                <option value="mass">mass</option>
                <option value="planeAngle">planeAngle</option>
                <option value="power">power</option>
                <option value="pressure">pressure</option>
                <option value="salinity">salinity</option>
                <option value="speed">speed</option>
                <option value="temperature">temperature</option>
                <option value="volume">volume</option>
                <option value="weight">weight</option>
                <option value="otherQuantity">otherQuantity</option>
              </select>
            </div>

            <!-- Feature/Information: distinctionIds (0..*) -->
            <div id="distinctionsWrap" style="display:none;grid-column:1/-1;">
              <label>Related Features/Information (distinctionIds, 0..*)</label>
              <div class="dyn">
                <div class="dyn-h">
                  <span class="dyn-title">Distinctions</span>
                  <button class="btn ghost" type="button" id="addDistinctionBtn">+ Add</button>
                </div>
                <div class="dyn-b" id="distinctionsBody">
                  <div class="dyn-empty">No distinctions</div>
                </div>
              </div>
              <div class="hint">개념적으로 유사한 Feature/Information 항목들을 연결합니다.</div>
            </div>

            <!-- EnumeratedValue: parentSimpleAttributeId (required) -->
            <div id="parentAttrWrap" style="display:none;grid-column:1/-1;">
              <label>Parent SimpleAttribute <span class="req">*</span></label>
              <select id="parentSimpleAttributeId">
                <option value="">Select SimpleAttribute...</option>
              </select>
              <div class="hint">EnumeratedValue는 반드시 하나의 SimpleAttribute에 종속되어야 합니다. (valueType이 enumeration 또는 S100_CodeList인 항목만 표시)</div>
            </div>

            <!-- SimpleAttribute: attributeConstraints (0..1) -->
            <div id="constraintsWrap" style="display:none;grid-column:1/-1;">
              <label>Attribute Constraints (optional)</label>
              <div style="display:grid;grid-template-columns:repeat(4,1fr);gap:10px;margin-top:8px;">
                <div>
                  <label style="font-size:12px;">stringLength</label>
                  <input id="ac_stringLength" type="number" placeholder="max chars" />
                </div>
                <div>
                  <label style="font-size:12px;">textPattern</label>
                  <input id="ac_textPattern" placeholder="regex" />
                </div>
                <div>
                  <label style="font-size:12px;">range</label>
                  <input id="ac_range" placeholder="e.g., 0..100" />
                </div>
                <div>
                  <label style="font-size:12px;">precision</label>
                  <input id="ac_precision" type="number" placeholder="decimal places" />
                </div>
              </div>
              <div class="hint">속성 값의 범위/패턴을 제한합니다.</div>
            </div>

            <!-- ComplexAttribute: subAttributes (1..*) -->
            <div id="subAttrsWrap" style="display:none;grid-column:1/-1;">
              <label>Sub Attributes <span class="req">*</span> (1..*)</label>
              <div class="dyn">
                <div class="dyn-h">
                  <span class="dyn-title">Sub Attributes</span>
                  <button class="btn ghost" type="button" id="addSubAttrBtn">+ Add</button>
                </div>
                <div class="dyn-b" id="subAttrsBody">
                  <div class="dyn-empty">No sub attributes (at least 1 required)</div>
                </div>
              </div>
              <div class="hint">SimpleAttribute 또는 ComplexAttribute를 하위 속성으로 추가합니다.</div>
            </div>

            <div class="hint" id="typedHint" style="grid-column:1/-1;">Kind에 따라 입력란이 달라집니다.</div>
          </div>
        </div>
      </div>

      <div class="card">
        <div class="card-h">Management Information <span style="color:var(--muted);font-weight:800;">(append)</span></div>
        <div class="card-b">
          <div class="grid">
            <div>
              <label>proposalType <span class="req">*</span></label>
              <input id="mi_proposalType" required placeholder="e.g., Clarification" />
            </div>
            <div>
              <label>submittingOrganisation <span class="req">*</span></label>
              <input id="mi_submittingOrganisation" required placeholder="Organisation" />
            </div>
            <div style="grid-column:1/-1;">
              <label>proposedChange <span class="req">*</span></label>
              <textarea id="mi_proposedChange" required placeholder="What changed / why"></textarea>
            </div>
            <div>
              <label>dateProposed <span class="req">*</span></label>
              <input id="mi_dateProposed" type="date" required />
            </div>
            <div>
              <label>dateAccepted</label>
              <input id="mi_dateAccepted" type="date" />
            </div>
            <div>
              <label>proposalStatus</label>
              <input id="mi_proposalStatus" placeholder="Draft" />
              <div class="hint">비워두면 itemStatus 값 사용</div>
            </div>
          </div>
        </div>
      </div>

      <div class="card" id="refsCard">
        <div class="card-h">References</div>
        <div class="card-b">
          <div class="grid">
            <div style="grid-column:1/-1;">
              <label>Reference Source (0..1)</label>
              <select id="refSourceSelect">
                <option value="">(none)</option>
                <option value="__new__">+ Create new…</option>
              </select>
              <div class="hint">Convert mode에서는 참조를 변경하지 않습니다.</div>
            </div>
            <div>
              <label>New Source Name</label>
              <input id="newRefSourceName" placeholder="e.g., S-101 Ed. X.Y" />
            </div>
            <div>
              <label>New Source Description</label>
              <input id="newRefSourceDesc" placeholder="optional" />
            </div>

            <div style="grid-column:1/-1;">
              <label>References (0..*)</label>
              <div class="dyn">
                <div class="dyn-h">
                  <span class="dyn-title">References</span>
                  <button class="btn ghost" type="button" id="addRefBtn">+ Add</button>
                </div>
                <div class="dyn-b" id="refsBody">
                  <div class="dyn-empty">No references</div>
                </div>
              </div>
              <div class="hint">각 Row는 저장 시 Reference 문서로 생성되고, 그 ID들이 Item에 연결됩니다.</div>
            </div>
          </div>
        </div>
      </div>

    </form>
  </div>

  <div class="toast" id="toast"></div>
{% endblock %}

{% block extra_scripts %}
<script>
    const fromConceptId = "{{ fromConceptId or '' }}".trim();

    function showToast(msg, type='success'){
      const t = document.getElementById('toast');
      t.className = 'toast ' + type;
      t.textContent = msg;
      t.classList.add('show');
      setTimeout(()=>t.classList.remove('show'), 2200);
    }

    function splitAlias(v){
      return (v||'').split(',').map(s=>s.trim()).filter(Boolean);
    }

    // auto camelCase
    const nameEl = document.getElementById('name');
    const camelEl = document.getElementById('camelCase');
    nameEl.addEventListener('input', ()=>{
      const name = nameEl.value || '';
      const cc = name.split(/\s+/).filter(Boolean).map(w=>w.charAt(0).toUpperCase()+w.slice(1)).join('');
      if (!camelEl.value) camelEl.value = cc;
    });

    function toggleTyped(){
      const kind = document.getElementById('kindSelect').value;
      const f = document.getElementById('featureUseTypeWrap');
      const n = document.getElementById('numericCodeWrap');
      const vt = document.getElementById('valueTypeWrap');
      const qs = document.getElementById('quantityWrap');

      // 새로운 연관관계 필드들
      const distinctions = document.getElementById('distinctionsWrap');
      const parentAttr = document.getElementById('parentAttrWrap');
      const constraints = document.getElementById('constraintsWrap');
      const subAttrs = document.getElementById('subAttrsWrap');

      // Existing concept selector
      const existingConceptWrap = document.getElementById('existingConceptWrap');
      const isNotConcept = kind !== 'S100_Concept';
      existingConceptWrap.style.display = isNotConcept ? '' : 'none';
      
      // Kind가 변경되면 기존 concept 목록 로드
      if (isNotConcept) {
        loadUnboundConcepts();
      } else {
        // S100_Concept 선택 시 폼 초기화
        document.getElementById('existingConceptSelect').value = '';
        selectedConceptId = '';
      }

      f.style.display = (kind === 'S100_CD_Feature') ? '' : 'none';
      n.style.display = (kind === 'S100_CD_EnumeratedValue') ? '' : 'none';
      vt.style.display = (kind === 'S100_CD_SimpleAttribute') ? '' : 'none';
      qs.style.display = (kind === 'S100_CD_SimpleAttribute') ? '' : 'none';

      // Feature/Information: distinctionIds
      distinctions.style.display = (kind === 'S100_CD_Feature' || kind === 'S100_CD_Information') ? '' : 'none';
      // kind가 바뀌면 distinction 목록 초기화
      if (kind === 'S100_CD_Feature' || kind === 'S100_CD_Information') {
        // 캐시 초기화 (kind 변경 시 새로 로드)
        loadedDistinctionKind = '';
        allFeatureInfoItems = [];
        document.getElementById('distinctionsBody').innerHTML = '<div class="dyn-empty">No distinctions</div>';
      }

      // EnumeratedValue: parentSimpleAttributeId
      parentAttr.style.display = (kind === 'S100_CD_EnumeratedValue') ? '' : 'none';
      if (kind === 'S100_CD_EnumeratedValue') {
        loadParentSimpleAttributes();
      }

      // SimpleAttribute: attributeConstraints
      constraints.style.display = (kind === 'S100_CD_SimpleAttribute') ? '' : 'none';

      // ComplexAttribute: subAttributes
      subAttrs.style.display = (kind === 'S100_CD_ComplexAttribute') ? '' : 'none';
      if (kind === 'S100_CD_ComplexAttribute') {
        loadAttributeOptions();
        // 기존 subAttr 목록 초기화
        document.getElementById('subAttrsBody').innerHTML = '<div class="dyn-empty">No sub attributes (at least 1 required)</div>';
      }

      const typedCard = document.getElementById('typedCard');
      typedCard.style.display = (kind === 'S100_Concept') ? 'none' : '';
    }

    document.getElementById('kindSelect').addEventListener('change', toggleTyped);

    // ---------- Existing Concept Selection ----------
    let unboundConcepts = [];
    let unboundConceptsLoaded = false;
    let selectedConceptId = '';

    async function loadUnboundConcepts(){
      if (unboundConceptsLoaded) return;
      
      const sel = document.getElementById('existingConceptSelect');
      sel.innerHTML = '<option value="">Loading...</option>';
      
      try {
        const res = await fetch('/api/dd/items?limit=200&kind=S100_Concept');
        const j = await res.json();
        unboundConcepts = j.items || [];
        unboundConceptsLoaded = true;
        
        sel.innerHTML = '<option value="">-- Create new concept manually --</option>';
        unboundConcepts.forEach(item => {
          const c = item.concept || {};
          const opt = document.createElement('option');
          opt.value = item._id;
          opt.textContent = `${c.name || '(unnamed)'} (ID: ${c.itemIdentifier || item._id})`;
          sel.appendChild(opt);
        });
      } catch (e) {
        console.error('Failed to load unbound concepts:', e);
        sel.innerHTML = '<option value="">-- Create new concept manually --</option>';
      }
    }

    function fillFormFromConcept(conceptItem){
      if (!conceptItem) return;
      
      const c = conceptItem.concept || {};
      
      // Concept 필드 채우기
      document.getElementById('name').value = c.name || '';
      document.getElementById('camelCase').value = c.camelCase || '';
      document.getElementById('alias').value = (c.alias || []).join(', ');
      document.getElementById('definition').value = c.definition || '';
      document.getElementById('remarks').value = c.remarks || '';
      document.getElementById('definitionSource').value = c.definitionSource || '';
      document.getElementById('similarityToSource').value = c.similarityToSource || '';
      document.getElementById('reference').value = c.reference || '';
      document.getElementById('proposedChange').value = c.proposedChange || '';
      document.getElementById('justification').value = c.justification || '';
      
      // Item Status
      const statusSel = document.getElementById('itemStatus');
      if (c.itemStatus && statusSel) {
        statusSel.value = c.itemStatus;
      }
      
      // Register 선택 (concept의 registerId와 같은 레지스터 선택)
      if (conceptItem.registerId) {
        const regSel = document.getElementById('registerSelect');
        regSel.value = conceptItem.registerId;
      }
      
      showToast('Concept 정보를 불러왔습니다. Typed Body만 입력하세요.', 'success');
    }

    function clearConceptForm(){
      document.getElementById('name').value = '';
      document.getElementById('camelCase').value = '';
      document.getElementById('alias').value = '';
      document.getElementById('definition').value = '';
      document.getElementById('remarks').value = '';
      document.getElementById('definitionSource').value = '';
      document.getElementById('similarityToSource').value = '';
      document.getElementById('reference').value = '';
      document.getElementById('proposedChange').value = '';
      document.getElementById('justification').value = '';
      document.getElementById('itemStatus').value = 'Draft';
    }

    document.getElementById('existingConceptSelect').addEventListener('change', function(){
      const conceptId = this.value;
      selectedConceptId = conceptId;
      
      const submitBtn = document.getElementById('submitBtn');
      const convertBanner = document.getElementById('convertBanner');
      const conceptCard = document.getElementById('conceptCard');
      const refsCard = document.getElementById('refsCard');
      
      if (!conceptId) {
        // "Create new concept manually" 선택 시 폼 초기화 및 UI 복원
        clearConceptForm();
        submitBtn.textContent = 'Create';
        convertBanner.style.display = 'none';
        conceptCard.classList.remove('convert-mode');
        refsCard.style.display = '';
        // Concept 필드들 다시 활성화
        setConceptFieldsReadonly(false);
        return;
      }
      
      // 기존 Concept 선택 시: Convert 모드로 전환
      submitBtn.textContent = 'Convert';
      convertBanner.style.display = '';
      conceptCard.classList.add('convert-mode');
      // References는 convert에서 변경하지 않으므로 숨김
      refsCard.style.display = 'none';
      // Concept 필드들 읽기 전용으로 설정
      setConceptFieldsReadonly(true);
      
      // 선택된 concept 찾기
      const conceptItem = unboundConcepts.find(item => item._id === conceptId);
      if (conceptItem) {
        fillFormFromConcept(conceptItem);
      }
    });

    function setConceptFieldsReadonly(readonly){
      const fields = [
        'name', 'camelCase', 'alias', 'definition', 'remarks',
        'definitionSource', 'similarityToSource', 'reference',
        'proposedChange', 'justification', 'itemStatus'
      ];
      fields.forEach(id => {
        const el = document.getElementById(id);
        if (el) {
          el.readOnly = readonly && el.tagName !== 'SELECT';
          el.disabled = readonly && el.tagName === 'SELECT';
        }
      });
    }

    async function loadRegisters(selectedId=''){
      const sel = document.getElementById('registerSelect');
      sel.innerHTML = '<option value="">Loading…</option>';
      const res = await fetch('/api/registers?limit=200');
      const j = await res.json();
      const items = j.items || [];
      sel.innerHTML = '<option value="">Select…</option>';
      items.forEach(r=>{
        const opt = document.createElement('option');
        opt.value = r._id;
        opt.textContent = r.name + ' (' + r._id + ')';
        sel.appendChild(opt);
      });
      if (selectedId) sel.value = selectedId;
    }

    // ---------- References helpers (create mode only) ----------
    function addRefRow(){
      const body = document.getElementById('refsBody');
      const empty = body.querySelector('.dyn-empty');
      if (empty) empty.remove();

      const idx = body.querySelectorAll('.dyn-item').length + 1;
      const row = document.createElement('div');
      row.className = 'dyn-item';
      row.innerHTML = `
        <div class="num">${idx}</div>
        <div style="flex:1;display:grid;grid-template-columns:1fr 1fr;gap:10px;">
          <div>
            <label style="display:block;margin-bottom:6px;">title <span class="req">*</span></label>
            <input data-title placeholder="title" />
          </div>
          <div>
            <label style="display:block;margin-bottom:6px;">locator</label>
            <input data-locator placeholder="locator" />
          </div>
        </div>
        <button type="button" class="remove" title="remove">✕</button>
      `;
      row.querySelector('.remove').addEventListener('click', ()=>{
        row.remove();
        // renumber
        body.querySelectorAll('.dyn-item').forEach((el,i)=>{ el.querySelector('.num').textContent = i+1; });
        if (body.querySelectorAll('.dyn-item').length === 0){
          body.innerHTML = '<div class="dyn-empty">No references</div>';
        }
      });
      body.appendChild(row);
    }

    document.getElementById('addRefBtn').addEventListener('click', addRefRow);

    // ---------- Distinctions (Feature/Information) ----------
    let allFeatureInfoItems = [];
    let loadedDistinctionKind = '';

    async function loadFeatureInfoItems(){
      const kind = document.getElementById('kindSelect').value;
      // kind가 바뀌면 캐시 초기화
      if (loadedDistinctionKind !== kind) {
        allFeatureInfoItems = [];
        loadedDistinctionKind = kind;
      }
      if (allFeatureInfoItems.length > 0) return; // 이미 로드됨

      const targetKind = kind; // Feature는 Feature만, Information은 Information만
      try {
        const res = await fetch(`/api/dd/items?limit=200&kind=${encodeURIComponent(targetKind)}`);
        const j = await res.json();
        allFeatureInfoItems = j.items || [];
      } catch (e) {
        console.error('Failed to load feature/info items:', e);
        allFeatureInfoItems = [];
      }
    }

    function addDistinctionRow(preselectedId = ''){
      const body = document.getElementById('distinctionsBody');
      const empty = body.querySelector('.dyn-empty');
      if (empty) empty.remove();

      const idx = body.querySelectorAll('.dyn-item').length + 1;
      const row = document.createElement('div');
      row.className = 'dyn-item';

      let optionsHtml = '<option value="">Select item...</option>';
      allFeatureInfoItems.forEach(item => {
        const c = item.concept || {};
        const selected = (item._id === preselectedId) ? 'selected' : '';
        optionsHtml += `<option value="${item._id}" ${selected}>${c.name || '(unnamed)'} (${c.itemIdentifier || item._id})</option>`;
      });

      row.innerHTML = `
        <div class="num">${idx}</div>
        <div style="flex:1;">
          <select data-distinction-id style="width:100%;">${optionsHtml}</select>
        </div>
        <button type="button" class="remove" title="remove">✕</button>
      `;
      row.querySelector('.remove').addEventListener('click', ()=>{
        row.remove();
        body.querySelectorAll('.dyn-item').forEach((el,i)=>{ el.querySelector('.num').textContent = i+1; });
        if (body.querySelectorAll('.dyn-item').length === 0){
          body.innerHTML = '<div class="dyn-empty">No distinctions</div>';
        }
      });
      body.appendChild(row);
    }

    document.getElementById('addDistinctionBtn').addEventListener('click', async ()=>{
      await loadFeatureInfoItems();
      addDistinctionRow();
    });

    function collectDistinctionIds(){
      const body = document.getElementById('distinctionsBody');
      const rows = Array.from(body.querySelectorAll('.dyn-item'));
      return rows.map(r => (r.querySelector('[data-distinction-id]')?.value || '').trim()).filter(Boolean);
    }

    // ---------- Parent SimpleAttribute (EnumeratedValue) ----------
    let parentSimpleAttributesLoaded = false;
    let parentSimpleAttributes = [];

    async function loadParentSimpleAttributes(){
      const sel = document.getElementById('parentSimpleAttributeId');
      
      // 이미 로드된 경우 캐시된 데이터 사용
      if (parentSimpleAttributesLoaded) {
        renderParentSimpleAttributeOptions(sel);
        return;
      }

      sel.innerHTML = '<option value="">Loading...</option>';
      
      try {
        // valueType이 enumeration 또는 S100_CodeList인 SimpleAttribute만 조회
        // API에서 valueType 필터를 지원하지 않으므로 클라이언트에서 필터링
        const res = await fetch('/api/dd/items?limit=200&kind=S100_CD_SimpleAttribute&sortBy=name&sortOrder=asc');
        const j = await res.json();
        parentSimpleAttributes = (j.items || []).filter(item => {
          const sa = item.S100_CD_SimpleAttribute || {};
          return sa.valueType === 'enumeration' || sa.valueType === 'S100_CodeList';
        });
        parentSimpleAttributesLoaded = true;
        renderParentSimpleAttributeOptions(sel);
      } catch (e) {
        console.error('Failed to load parent simple attributes:', e);
        sel.innerHTML = '<option value="">Failed to load</option>';
      }
    }

    function renderParentSimpleAttributeOptions(sel){
      sel.innerHTML = '<option value="">Select SimpleAttribute...</option>';
      parentSimpleAttributes.forEach(item => {
        const c = item.concept || {};
        const sa = item.S100_CD_SimpleAttribute || {};
        const opt = document.createElement('option');
        opt.value = item._id;
        opt.textContent = `${c.name || '(unnamed)'} (${c.itemIdentifier || item._id}) - ${sa.valueType}`;
        sel.appendChild(opt);
      });
    }

    // ---------- Sub Attributes (ComplexAttribute) ----------
    let allAttributeItems = [];
    let attributeOptionsLoaded = false;

    async function loadAttributeOptions(){
      if (attributeOptionsLoaded && allAttributeItems.length > 0) return;
      try {
        // 쉼표로 여러 kind 지원
        const res = await fetch('/api/dd/items?limit=200&kind=S100_CD_SimpleAttribute,S100_CD_ComplexAttribute');
        const j = await res.json();
        allAttributeItems = j.items || [];
        attributeOptionsLoaded = true;
      } catch (e) {
        console.error('Failed to load attribute options:', e);
        allAttributeItems = [];
      }
    }

    function addSubAttrRow(preselected = {}){
      const body = document.getElementById('subAttrsBody');
      const empty = body.querySelector('.dyn-empty');
      if (empty) empty.remove();

      const idx = body.querySelectorAll('.dyn-item').length + 1;
      const row = document.createElement('div');
      row.className = 'dyn-item';

      let optionsHtml = '<option value="">Select attribute...</option>';
      allAttributeItems.forEach(item => {
        const c = item.concept || {};
        const selected = (item._id === preselected.attributeId) ? 'selected' : '';
        optionsHtml += `<option value="${item._id}" ${selected}>${c.name || '(unnamed)'} (${item.kind})</option>`;
      });

      const mult = preselected.multiplicity || {};
      const lower = mult.lower || '0';
      const upper = mult.upper || '1';
      const infinite = mult.infinite === 'true';
      const sequential = preselected.sequential === 'true';

      row.innerHTML = `
        <div class="num">${idx}</div>
        <div style="flex:1;display:grid;grid-template-columns:2fr 1fr 1fr 80px;gap:10px;align-items:end;">
          <div>
            <label style="display:block;margin-bottom:4px;font-size:12px;">Attribute</label>
            <select data-attr-id style="width:100%;">${optionsHtml}</select>
          </div>
          <div>
            <label style="display:block;margin-bottom:4px;font-size:12px;">Multiplicity</label>
            <div style="display:flex;gap:4px;align-items:center;">
              <input data-lower type="number" min="0" value="${lower}" style="width:50px;" />
              <span>..</span>
              <input data-upper type="number" min="0" value="${upper}" style="width:50px;" ${infinite ? 'disabled' : ''} />
              <label style="font-size:11px;display:flex;align-items:center;gap:2px;">
                <input type="checkbox" data-infinite ${infinite ? 'checked' : ''} /> *
              </label>
            </div>
          </div>
          <div>
            <label style="display:block;margin-bottom:4px;font-size:12px;">Sequential</label>
            <select data-sequential>
              <option value="false" ${!sequential ? 'selected' : ''}>No</option>
              <option value="true" ${sequential ? 'selected' : ''}>Yes</option>
            </select>
          </div>
          <div style="text-align:right;">
            <button type="button" class="remove" title="remove">✕</button>
          </div>
        </div>
      `;

      // infinite 체크 시 upper 비활성화
      const infCheck = row.querySelector('[data-infinite]');
      const upperInput = row.querySelector('[data-upper]');
      infCheck.addEventListener('change', ()=>{
        upperInput.disabled = infCheck.checked;
        if (infCheck.checked) upperInput.value = '';
      });

      row.querySelector('.remove').addEventListener('click', ()=>{
        row.remove();
        body.querySelectorAll('.dyn-item').forEach((el,i)=>{ el.querySelector('.num').textContent = i+1; });
        if (body.querySelectorAll('.dyn-item').length === 0){
          body.innerHTML = '<div class="dyn-empty">No sub attributes (at least 1 required)</div>';
        }
      });
      body.appendChild(row);
    }

    document.getElementById('addSubAttrBtn').addEventListener('click', async ()=>{
      if (allAttributeItems.length === 0) await loadAttributeOptions();
      addSubAttrRow();
    });

    function collectSubAttributes(){
      const body = document.getElementById('subAttrsBody');
      const rows = Array.from(body.querySelectorAll('.dyn-item'));
      return rows.map(r => {
        const attrId = (r.querySelector('[data-attr-id]')?.value || '').trim();
        const lower = (r.querySelector('[data-lower]')?.value || '0').trim();
        const upper = (r.querySelector('[data-upper]')?.value || '1').trim();
        const infinite = r.querySelector('[data-infinite]')?.checked ? 'true' : 'false';
        const sequential = (r.querySelector('[data-sequential]')?.value || 'false').trim();
        if (!attrId) return null;
        return {
          attributeId: attrId,
          multiplicity: { lower, upper: infinite === 'true' ? '' : upper, infinite },
          sequential
        };
      }).filter(Boolean);
    }

    function collectAttributeConstraints(){
      const stringLength = (document.getElementById('ac_stringLength')?.value || '').trim() || null;
      const textPattern = (document.getElementById('ac_textPattern')?.value || '').trim() || null;
      const range = (document.getElementById('ac_range')?.value || '').trim() || null;
      const precision = (document.getElementById('ac_precision')?.value || '').trim() || null;

      if (!stringLength && !textPattern && !range && !precision) return null;

      // 모든 필드를 string으로 보냄 (모델이 str 타입 기대)
      return {
        stringLength,
        textPattern,
        range,
        precision
      };
    }

    async function loadReferenceSources(){
      const sel = document.getElementById('refSourceSelect');
      const res = await fetch('/api/reference-sources?limit=200&sortBy=name&sortOrder=asc');
      const j = await res.json();
      const items = j.items || [];
      sel.innerHTML = '<option value="">(none)</option><option value="__new__">+ Create new…</option>';
      items.forEach(s=>{
        const opt = document.createElement('option');
        opt.value = s._id;
        opt.textContent = s.name + ' (' + s._id + ')';
        sel.appendChild(opt);
      });
    }

    async function ensureReferenceSourceId(){
      const sel = document.getElementById('refSourceSelect');
      const v = (sel.value||'').trim();
      if (!v) return null;
      if (v !== '__new__') return v;

      const name = (document.getElementById('newRefSourceName').value||'').trim();
      const description = (document.getElementById('newRefSourceDesc').value||'').trim() || null;
      if (!name) { showToast('New Source Name is required.', 'error'); throw new Error('missing source name'); }

      const res = await fetch('/api/reference-sources', {
        method:'POST',
        headers:{'Content-Type':'application/json','Accept':'application/json'},
        body: JSON.stringify({ name, description })
      });
      if (!res.ok){
        const t = await res.text();
        showToast('Create reference source failed', 'error');
        throw new Error(t);
      }
      const created = await res.json();
      await loadReferenceSources();
      sel.value = created._id;
      return created._id;
    }

    async function ensureReferenceIds(){
      const body = document.getElementById('refsBody');
      const rows = Array.from(body.querySelectorAll('.dyn-item'));
      if (!rows.length) return [];
      const ids = [];
      for (const r of rows){
        const title = (r.querySelector('[data-title]')?.value || '').trim();
        const locator = (r.querySelector('[data-locator]')?.value || '').trim() || null;
        if (!title) continue;
        const res = await fetch('/api/references', {
          method:'POST',
          headers:{'Content-Type':'application/json','Accept':'application/json'},
          body: JSON.stringify({ title, locator })
        });
        if (!res.ok){
          const t = await res.text();
          showToast('Create reference failed', 'error');
          throw new Error(t);
        }
        const created = await res.json();
        ids.push(created._id);
      }
      return ids;
    }

    // ---------- Convert mode preload ----------
    async function preloadFromConcept(){
      if (!fromConceptId) return;

      document.getElementById('convertBanner').style.display = '';
      document.getElementById('pageTitle').textContent = 'Convert Concept';
      document.getElementById('submitBtn').textContent = 'Convert';

      // kind: remove concept option
      const ks = document.getElementById('kindSelect');
      ks.querySelectorAll('option').forEach(opt=>{ if (opt.value === 'S100_Concept') opt.remove(); });

      // refs disabled in convert
      document.getElementById('refsCard').style.display = 'none';

      const res = await fetch(`/api/dd/items/${fromConceptId}`);
      if (!res.ok){
        const t = await res.text();
        showToast('Failed to load concept: ' + t, 'error');
        return;
      }
      const item = await res.json();
      const c = item.concept || {};

      await loadRegisters(item.registerId);
      const regSel = document.getElementById('registerSelect');
      regSel.value = item.registerId;
      regSel.disabled = true;

      document.getElementById('itemIdentifier').value = c.itemIdentifier || '';
      document.getElementById('name').value = c.name || '';
      document.getElementById('camelCase').value = c.camelCase || '';
      document.getElementById('alias').value = Array.isArray(c.alias) ? c.alias.join(', ') : '';
      document.getElementById('definition').value = c.definition || '';
      document.getElementById('remarks').value = c.remarks || '';
      document.getElementById('itemStatus').value = c.itemStatus || 'Draft';
      document.getElementById('definitionSource').value = c.definitionSource || '';
      document.getElementById('reference').value = c.reference || '';
      document.getElementById('similarityToSource').value = c.similarityToSource || '';
      document.getElementById('proposedChange').value = c.proposedChange || '';
      document.getElementById('justification').value = c.justification || '';

      // concept inputs locked (convert only changes typed body)
      ['name','camelCase','alias','definition','remarks','itemStatus','definitionSource','reference','similarityToSource','proposedChange','justification']
        .forEach(id=>{ document.getElementById(id).disabled = true; });

      toggleTyped();
    }

    // ---------- Init ----------
    (async ()=>{
      const dp = document.getElementById('mi_dateProposed');
      dp.value = new Date().toISOString().slice(0,10);

      await loadReferenceSources();

      if (!fromConceptId){
        await loadRegisters();
      }

      await preloadFromConcept();
      toggleTyped();
    })();


    // ---------- Submit ----------
    document.getElementById('createForm').addEventListener('submit', async (e)=>{
      e.preventDefault();

      const kind = document.getElementById('kindSelect').value;
      const registerId = (document.getElementById('registerSelect').value||'').trim();
      
      // 기존 Concept을 선택했는지 확인 (fromConceptId 또는 selectedConceptId)
      const conceptIdToConvert = fromConceptId || selectedConceptId;
      
      if (!conceptIdToConvert && !registerId){ showToast('Select a register.', 'error'); return; }

      const status = document.getElementById('itemStatus').value || 'Draft';
      const concept = {
        name: (document.getElementById('name').value||'').trim(),
        definition: (document.getElementById('definition').value||'').trim() || null,
        remarks: (document.getElementById('remarks').value||'').trim() || null,
        itemStatus: status,
        alias: splitAlias(document.getElementById('alias').value),
        camelCase: (document.getElementById('camelCase').value||'').trim() || null,
        definitionSource: (document.getElementById('definitionSource').value||'').trim() || null,
        reference: (document.getElementById('reference').value||'').trim() || null,
        similarityToSource: (document.getElementById('similarityToSource').value||'').trim() || null,
        justification: (document.getElementById('justification').value||'').trim() || null,
        proposedChange: (document.getElementById('proposedChange').value||'').trim() || null,
      };

      if (!conceptIdToConvert && !concept.name){ showToast('Name is required.', 'error'); return; }

      // management info
      const mi = {
        proposalType: (document.getElementById('mi_proposalType').value||'').trim() || null,
        submittingOrganisation: (document.getElementById('mi_submittingOrganisation').value||'').trim() || null,
        proposedChange: (document.getElementById('mi_proposedChange').value||'').trim() || null,
        dateProposed: (document.getElementById('mi_dateProposed').value||'').trim() || null,
        dateAccepted: (document.getElementById('mi_dateAccepted').value||'').trim() || null,
        proposalStatus: (document.getElementById('mi_proposalStatus').value||'').trim() || status,
        controlBodyNotes: []
      };

      if (!mi.proposalType || !mi.submittingOrganisation || !mi.proposedChange || !mi.dateProposed){
        showToast('ManagementInfo required fields missing.', 'error');
        return;
      }

      // typed fields
      const typed = {
        featureUseType: (document.getElementById('featureUseType').value||'').trim() || null,
        numericCode: (document.getElementById('numericCode').value||'').trim() || null,
        valueType: (document.getElementById('valueType').value||'').trim() || null,
        quantitySpecification: (document.getElementById('quantitySpecification').value||'').trim() || null,
      };

      try{
        // 기존 Concept을 선택한 경우 convert API 사용
        if (conceptIdToConvert){
          // convert
          if (!kind || kind === 'S100_Concept'){ showToast('Select a target kind.', 'error'); return; }
          const payload = {
            kind,
            featureUseType: kind === 'S100_CD_Feature' ? typed.featureUseType : undefined,
            numericCode: kind === 'S100_CD_EnumeratedValue' ? typed.numericCode : undefined,
            valueType: kind === 'S100_CD_SimpleAttribute' ? typed.valueType : undefined,
            quantitySpecification: kind === 'S100_CD_SimpleAttribute' ? typed.quantitySpecification : undefined,
            managementInfo: mi
          };

          // 새로운 연관관계 필드들 (convert)
          if (kind === 'S100_CD_Feature' || kind === 'S100_CD_Information') {
            payload.distinctionIds = collectDistinctionIds();
          }
          if (kind === 'S100_CD_EnumeratedValue') {
            const parentId = (document.getElementById('parentSimpleAttributeId').value || '').trim();
            if (!parentId) { showToast('Parent SimpleAttribute is required.', 'error'); return; }
            payload.parentSimpleAttributeId = parentId;
          }
          if (kind === 'S100_CD_SimpleAttribute') {
            const ac = collectAttributeConstraints();
            if (ac) payload.attributeConstraints = ac;
          }
          if (kind === 'S100_CD_ComplexAttribute') {
            const subs = collectSubAttributes();
            if (subs.length === 0) { showToast('At least 1 sub attribute is required.', 'error'); return; }
            payload.subAttributes = subs;
          }

          const res = await fetch(`/api/dd/items/${conceptIdToConvert}/convert`, {
            method:'PATCH',
            headers:{'Content-Type':'application/json','Accept':'application/json'},
            body: JSON.stringify(payload)
          });
          if (!res.ok){
            const t = await res.text();
            showToast('Convert failed: ' + t, 'error');
            return;
          }
          const updated = await res.json();
          showToast('Converted!', 'success');
          setTimeout(()=>{ window.location.href = `/ui/dd/${updated._id}`; }, 450);
          return;
        }

        // create
        const referenceSourceId = await ensureReferenceSourceId();
        const referenceIds = await ensureReferenceIds();

        const payload = {
          registerId,
          kind,
          concept,
          managementInfos: [mi],
          referenceIds,
          referenceSourceId,
        };

        // only include typed keys when relevant
        if (kind === 'S100_CD_Feature') {
          payload.featureUseType = typed.featureUseType || 'meta';
          payload.distinctionIds = collectDistinctionIds();
        }
        if (kind === 'S100_CD_Information') {
          payload.distinctionIds = collectDistinctionIds();
        }
        if (kind === 'S100_CD_EnumeratedValue') {
          payload.numericCode = typed.numericCode || '';
          const parentId = (document.getElementById('parentSimpleAttributeId').value || '').trim();
          if (!parentId) { showToast('Parent SimpleAttribute is required.', 'error'); return; }
          payload.parentSimpleAttributeId = parentId;
        }
        if (kind === 'S100_CD_SimpleAttribute'){
          payload.valueType = typed.valueType || 'text';
          if (typed.quantitySpecification) payload.quantitySpecification = typed.quantitySpecification;
          const ac = collectAttributeConstraints();
          if (ac) payload.attributeConstraints = ac;
        }
        if (kind === 'S100_CD_ComplexAttribute') {
          const subs = collectSubAttributes();
          if (subs.length === 0) { showToast('At least 1 sub attribute is required.', 'error'); return; }
          payload.subAttributes = subs;
        }

        const res = await fetch('/api/dd/items', {
          method:'POST',
          headers:{'Content-Type':'application/json','Accept':'application/json'},
          body: JSON.stringify(payload)
        });
        if (!res.ok){
          const t = await res.text();
          showToast('Create failed: ' + t, 'error');
          return;
        }
        const created = await res.json();
        showToast('Created!', 'success');
        setTimeout(()=>{ window.location.href = `/ui/dd/${created._id}`; }, 450);

      }catch(err){
        console.error(err);
        showToast('Error: ' + (err?.message || err), 'error');
      }

    });
</script>
{% endblock %}
