<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Data Dictionary - New Item</title>
    <link rel="stylesheet" href="/static/style.css" />
</head>
<body class="page-dd-new">
    <div class="container">
        <!-- Header -->
        <header class="page-header">
            <nav class="breadcrumb">
                <a href="#">Home</a>
                <span>/</span>
                <a href="#">GI Registers</a>
                <span>/</span>
                <a href="data-registry.html">Data Dictionary Register</a>
                <span>/</span>
                <span class="current">New Item</span>
            </nav>
            <div class="page-title-wrapper">
                <div>
                    <h1 class="page-title">Create New Item</h1>
                    <p class="page-subtitle">Add a new entry to the Data Dictionary Register</p>
                </div>
            </div>
        </header>

        <!-- Progress Steps -->
        <div class="progress-steps">
            <div class="step active" data-step="1">
                <div class="step-number">1</div>
                <span class="step-label">Basic Info</span>
            </div>
            <div class="step-connector"></div>
            <div class="step" data-step="2">
                <div class="step-number">2</div>
                <span class="step-label">Details</span>
            </div>
            <div class="step-connector"></div>
            <div class="step" data-step="3">
                <div class="step-number">3</div>
                <span class="step-label">Relations</span>
            </div>
            <div class="step-connector"></div>
            <div class="step" data-step="4">
                <div class="step-number">4</div>
                <span class="step-label">Review</span>
            </div>
        </div>

        <form id="registryForm">
            <!-- Step 1: Basic Info -->
            <div class="form-step" data-step="1">
                <div class="card">
                    <div class="card-header">
                        <h2 class="card-title">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/>
                                <polyline points="14 2 14 8 20 8"/>
                                <line x1="16" y1="13" x2="8" y2="13"/>
                                <line x1="16" y1="17" x2="8" y2="17"/>
                            </svg>
                            Basic Information
                        </h2>
                    </div>
                    <div class="card-body">
                        <div class="form-grid">
                            <div class="form-group full-width">
                                <label class="form-label">
                                    Register <span class="required">*</span>
                                </label>
                                <select class="form-select" name="registerId" id="registerSelect" required>
                                    <option value="">Loading registers...</option>
                                </select>
                                <span class="form-hint">
                                    If you don't have a register, <a href="/ui/registers/new" style="color: var(--primary); font-weight: 600; text-decoration: none;">+ create a new register</a>
                                </span>
                            </div>

                            <div class="form-group">
                                <label class="form-label">
                                    Domain <span class="required">*</span>
                                </label>
                                <select class="form-select" name="domain" required>
                                    <option value="">Select Domain</option>
                                    <option value="IHO Hydro">IHO Hydro</option>
                                    <option value="Inland ENC">Inland ENC</option>
                                    <option value="S-100">S-100</option>
                                    <option value="Other">Other</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label class="form-label">
                                    Item Type <span class="required">*</span>
                                </label>
                                <select class="form-select" name="itemType" required>
                                    <option value="">Select Type</option>
                                    <option value="Feature Type">Feature Type</option>
                                    <option value="Information Type">Information Type</option>
                                    <option value="Attribute Type">Attribute Type</option>
                                    <option value="Complex Type">Complex Type</option>
                                    <option value="Enumeration Value">Enumeration Value</option>
                                    <option value="Codelist Value">Codelist Value</option>
                                </select>
                            </div>
                            
                            <div class="form-group">
                                <label class="form-label">
                                    Item Identifier <span class="required">*</span>
                                </label>
                                <input type="number" class="form-input" name="itemIdentifier" placeholder="e.g., 79" required>
                                <span class="form-hint">Integer identifier (unique within the register)</span>
                            </div>
<div class="form-group full-width">
                                <label class="form-label">
                                    Name <span class="required">*</span>
                                </label>
                                <input type="text" class="form-input" name="name" placeholder="Enter item name" required>
                                <span class="form-hint">The official name of the item in natural language</span>
                            </div>
                            <div class="form-group full-width">
                                <label class="form-label">
                                    CamelCase <span class="required">*</span>
                                </label>
                                <div class="input-group">
                                    <input type="text" class="form-input" name="camelCase" placeholder="e.g., TelemedicalAssistanceService" required>
                                    <span class="input-addon">Auto-generate</span>
                                </div>
                                <span class="form-hint">Machine-readable identifier without spaces</span>
                            </div>
                            <div class="form-group full-width">
                                <label class="form-label">
                                    Definition <span class="required">*</span>
                                </label>
                                <textarea class="form-textarea" name="definition" placeholder="Enter a clear and concise definition..." required></textarea>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Step 2: Details -->
            <div class="form-step" data-step="2" style="display: none;">
                <div class="card">
                    <div class="card-header">
                        <h2 class="card-title">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <circle cx="12" cy="12" r="10"/>
                                <line x1="12" y1="16" x2="12" y2="12"/>
                                <line x1="12" y1="8" x2="12.01" y2="8"/>
                            </svg>
                            Reference & Details
                        </h2>
                    </div>
                    <div class="card-body">
                        <div class="form-grid">
                            <div class="form-group full-width">
                                <label class="form-label">Reference</label>
                                <input type="text" class="form-input" name="reference" placeholder="Enter reference information">
                            </div>
                            <div class="form-group">
                                <label class="form-label">Reference Source</label>
                                <select class="form-select" name="referenceSource">
                                    <option value="Unspecified">Unspecified</option>
                                    <option value="S-100">S-100</option>
                                    <option value="S-101">S-101</option>
                                    <option value="S-102">S-102</option>
                                    <option value="Other">Other</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label class="form-label">Similarity to Source</label>
                                <select class="form-select" name="similarity">
                                    <option value="Unspecified">Unspecified</option>
                                    <option value="Identical">Identical</option>
                                    <option value="Restyled">Restyled</option>
                                    <option value="Context Added">Context Added</option>
                                    <option value="Generalization">Generalization</option>
                                    <option value="Specialization">Specialization</option>
                                </select>
                            </div>
                            <div class="form-group full-width">
                                <label class="form-label">Remarks</label>
                                <textarea class="form-textarea" name="remarks" placeholder="Additional notes or remarks..."></textarea>
                            </div>
                        </div>

                        <div class="divider"></div>

                        <h3 class="section-title">Standards Compliance</h3>
                        <div class="form-grid">
                            <div class="form-group">
                                <label class="form-label">INT1</label>
                                <select class="form-select" name="int1">
                                    <option value="">Select</option>
                                    <option value="Yes">Yes</option>
                                    <option value="No">No</option>
                                    <option value="N/A">N/A</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label class="form-label">S4</label>
                                <select class="form-select" name="s4">
                                    <option value="">Select</option>
                                    <option value="Yes">Yes</option>
                                    <option value="No">No</option>
                                    <option value="N/A">N/A</option>
                                </select>
                            </div>
                        </div>

                        <div class="divider"></div>

                        <h3 class="section-title">Attachments (Optional)</h3>
                        <div class="file-upload" onclick="document.getElementById('fileInput').click()">
                            <input type="file" id="fileInput" multiple>
                            <svg class="file-upload-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/>
                                <polyline points="17 8 12 3 7 8"/>
                                <line x1="12" y1="3" x2="12" y2="15"/>
                            </svg>
                            <p class="file-upload-text">Click to upload or drag and drop</p>
                            <p class="file-upload-hint">PDF, DOC, PNG, JPG up to 10MB each</p>
                        </div>
                        <div class="file-list" id="fileList"></div>
                    </div>
                </div>
            </div>

            <!-- Step 3: Relations -->
            <div class="form-step" data-step="3" style="display: none;">
                <div class="card">
                    <div class="card-header">
                        <h2 class="card-title">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <polyline points="16 18 22 12 16 6"/>
                                <polyline points="8 6 2 12 8 18"/>
                            </svg>
                            Relations & Associations
                        </h2>
                    </div>
                    <div class="card-body">
                        <!-- Recommended Attributes -->
                        <div class="form-group full-width">
                            <label class="form-label">Recommended Attributes</label>
                            <div class="dynamic-list" id="attributesList">
                                <div class="dynamic-list-header">
                                    <span class="dynamic-list-title">Attributes</span>
                                    <button type="button" class="btn btn-sm btn-ghost" onclick="addDynamicItem('attributesList', 'Attribute')">
                                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                            <line x1="12" y1="5" x2="12" y2="19"/>
                                            <line x1="5" y1="12" x2="19" y2="12"/>
                                        </svg>
                                        Add
                                    </button>
                                </div>
                                <div class="dynamic-list-body">
                                    <div class="dynamic-list-empty">No attributes added yet</div>
                                </div>
                            </div>
                        </div>

                        <div class="divider"></div>

                        <!-- Distinctions Features -->
                        <div class="form-group full-width">
                            <label class="form-label">Distinctions Features</label>
                            <div class="dynamic-list" id="featuresList">
                                <div class="dynamic-list-header">
                                    <span class="dynamic-list-title">Features</span>
                                    <button type="button" class="btn btn-sm btn-ghost" onclick="addDynamicItem('featuresList', 'Feature')">
                                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                            <line x1="12" y1="5" x2="12" y2="19"/>
                                            <line x1="5" y1="12" x2="19" y2="12"/>
                                        </svg>
                                        Add
                                    </button>
                                </div>
                                <div class="dynamic-list-body">
                                    <div class="dynamic-list-empty">No features added yet</div>
                                </div>
                            </div>
                        </div>

                        <div class="divider"></div>

                        <!-- Distinction Informations -->
                        <div class="form-group full-width">
                            <label class="form-label">Distinction Informations</label>
                            <div class="dynamic-list" id="informationsList">
                                <div class="dynamic-list-header">
                                    <span class="dynamic-list-title">Informations</span>
                                    <button type="button" class="btn btn-sm btn-ghost" onclick="addDynamicItem('informationsList', 'Information')">
                                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                            <line x1="12" y1="5" x2="12" y2="19"/>
                                            <line x1="5" y1="12" x2="19" y2="12"/>
                                        </svg>
                                        Add
                                    </button>
                                </div>
                                <div class="dynamic-list-body">
                                    <div class="dynamic-list-empty">No informations added yet</div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Step 4: Review & Management -->
            <div class="form-step" data-step="4" style="display: none;">
                <div class="card">
                    <div class="card-header">
                        <h2 class="card-title">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M9 11l3 3L22 4"/>
                                <path d="M21 12v7a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11"/>
                            </svg>
                            Management Details
                        </h2>
                    </div>
                    <div class="card-body">
                        <div class="form-grid">
                            <div class="form-group">
                                <label class="form-label">
                                    Proposal Type <span class="required">*</span>
                                </label>
                                <select class="form-select" name="proposalType" required>
                                    <option value="Addition">Addition</option>
                                    <option value="Modification">Modification</option>
                                    <option value="Deprecation">Deprecation</option>
                                    <option value="Deletion">Deletion</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label class="form-label">
                                    Submitting Organization <span class="required">*</span>
                                </label>
                                <input type="text" class="form-input" name="submittingOrg" placeholder="e.g., IHO (WWNWS)" required>
                            </div>
                            <div class="form-group">
                                <label class="form-label">Successor</label>
                                <input type="text" class="form-input" name="successor" placeholder="--">
                            </div>
                            <div class="form-group">
                                <label class="form-label">Predecessor</label>
                                <input type="text" class="form-input" name="predecessor" placeholder="--">
                            </div>
                            <div class="form-group">
                                <label class="form-label">
                                    Date Proposed <span class="required">*</span>
                                </label>
                                <input type="date" class="form-input" name="dateProposed" required>
                            </div>
                            <div class="form-group">
                                <label class="form-label">Date Accepted</label>
                                <input type="date" class="form-input" name="dateAccepted">
                            </div>
                            <div class="form-group full-width">
                                <label class="form-label">
                                    Proposed Change <span class="required">*</span>
                                </label>
                                <textarea class="form-textarea" name="proposedChange" placeholder="Describe the proposed change..." required></textarea>
                            </div>
                            <div class="form-group full-width">
                                <label class="form-label">
                                    Justification <span class="required">*</span>
                                </label>
                                <textarea class="form-textarea" name="justification" placeholder="Explain why this change is needed..." required></textarea>
                            </div>
                        </div>

                        <div class="divider"></div>

                        <h3 class="section-title">Status</h3>
                        <div class="form-group">
                            <label class="form-label">Initial Status</label>
                            <div class="radio-group">
                                <label class="radio-item">
                                    <input type="radio" name="status" value="Draft" checked>
                                    <span>Draft</span>
                                </label>
                                <label class="radio-item">
                                    <input type="radio" name="status" value="Pending">
                                    <span>Pending Review</span>
                                </label>
                                <label class="radio-item">
                                    <input type="radio" name="status" value="Valid">
                                    <span>Valid</span>
                                </label>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Review Summary -->
                <div class="card">
                    <div class="card-header">
                        <h2 class="card-title">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/>
                                <polyline points="14 2 14 8 20 8"/>
                            </svg>
                            Review Summary
                        </h2>
                    </div>
                    <div class="card-body" id="reviewSummary">
                        <p style="color: var(--text-muted); text-align: center; padding: 20px;">
                            Review summary will appear here after filling the form.
                        </p>
                    </div>
                </div>
            </div>

            <!-- Form Actions -->
            <div class="form-actions">
                <div class="form-actions-left">
                    <button type="button" class="btn btn-secondary" onclick="window.location.href='data-registry.html'">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <line x1="19" y1="12" x2="5" y2="12"/>
                            <polyline points="12 19 5 12 12 5"/>
                        </svg>
                        Cancel
                    </button>
                    <button type="button" class="btn btn-secondary" id="saveDraftBtn">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z"/>
                            <polyline points="17 21 17 13 7 13 7 21"/>
                            <polyline points="7 3 7 8 15 8"/>
                        </svg>
                        Save Draft
                    </button>
                </div>
                <div class="form-actions-right">
                    <button type="button" class="btn btn-secondary" id="prevBtn" style="display: none;">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <line x1="19" y1="12" x2="5" y2="12"/>
                            <polyline points="12 19 5 12 12 5"/>
                        </svg>
                        Previous
                    </button>
                    <button type="button" class="btn btn-primary" id="nextBtn">
                        Next
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <line x1="5" y1="12" x2="19" y2="12"/>
                            <polyline points="12 5 19 12 12 19"/>
                        </svg>
                    </button>
                    <button type="submit" class="btn btn-success" id="submitBtn" style="display: none;">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"/>
                            <polyline points="22 4 12 14.01 9 11.01"/>
                        </svg>
                        Submit
                    </button>
                </div>
            </div>
        </form>
    </div>

    <!-- Toast -->
    <div class="toast" id="toast">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"/>
            <polyline points="22 4 12 14.01 9 11.01"/>
        </svg>
        <span id="toastMessage">Success!</span>
    </div>

    <script>
        // Step Navigation
        let currentStep = 1;
        const totalSteps = 4;

        function updateStepUI() {
            // Update progress steps
            document.querySelectorAll('.step').forEach((step, index) => {
                const stepNum = index + 1;
                step.classList.remove('active', 'completed');
                if (stepNum === currentStep) {
                    step.classList.add('active');
                } else if (stepNum < currentStep) {
                    step.classList.add('completed');
                }
            });

            // Update connectors
            document.querySelectorAll('.step-connector').forEach((connector, index) => {
                connector.classList.toggle('active', index < currentStep - 1);
            });

            // Show/hide form steps
            document.querySelectorAll('.form-step').forEach(step => {
                step.style.display = parseInt(step.dataset.step) === currentStep ? 'block' : 'none';
            });

            // Update buttons
            document.getElementById('prevBtn').style.display = currentStep > 1 ? 'inline-flex' : 'none';
            document.getElementById('nextBtn').style.display = currentStep < totalSteps ? 'inline-flex' : 'none';
            document.getElementById('submitBtn').style.display = currentStep === totalSteps ? 'inline-flex' : 'none';

            // Update review summary on last step
            if (currentStep === totalSteps) {
                updateReviewSummary();
            }
        }

        function validateCurrentStep() {
            const currentFormStep = document.querySelector(`.form-step[data-step="${currentStep}"]`);
            const requiredFields = currentFormStep.querySelectorAll('[required]');
            let isValid = true;

            requiredFields.forEach(field => {
                if (!field.value.trim()) {
                    field.classList.add('error');
                    isValid = false;
                } else {
                    field.classList.remove('error');
                }
            });

            if (!isValid) {
                showToast('Please fill in all required fields', 'error');
            }

            return isValid;
        }

        document.getElementById('nextBtn').addEventListener('click', () => {
            if (validateCurrentStep() && currentStep < totalSteps) {
                currentStep++;
                updateStepUI();
                window.scrollTo({ top: 0, behavior: 'smooth' });
            }
        });

        document.getElementById('prevBtn').addEventListener('click', () => {
            if (currentStep > 1) {
                currentStep--;
                updateStepUI();
                window.scrollTo({ top: 0, behavior: 'smooth' });
            }
        });

        // Dynamic List Management
        function addDynamicItem(listId, type) {
            const list = document.getElementById(listId);
            const body = list.querySelector('.dynamic-list-body');
            const empty = body.querySelector('.dynamic-list-empty');
            
            if (empty) {
                empty.remove();
            }

            const items = body.querySelectorAll('.dynamic-item');
            const itemNumber = items.length + 1;

            const item = document.createElement('div');
            item.className = 'dynamic-item';
            item.innerHTML = `
                <span class="dynamic-item-number">${itemNumber}</span>
                <div class="dynamic-item-input">
                    <input type="text" class="form-input" placeholder="Enter ${type.toLowerCase()} name" name="${listId}[]">
                </div>
                <button type="button" class="dynamic-item-remove" onclick="removeDynamicItem(this, '${listId}')">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="18" height="18">
                        <line x1="18" y1="6" x2="6" y2="18"/>
                        <line x1="6" y1="6" x2="18" y2="18"/>
                    </svg>
                </button>
            `;

            body.appendChild(item);
        }

        function removeDynamicItem(button, listId) {
            const item = button.closest('.dynamic-item');
            const body = item.parentElement;
            item.remove();

            // Renumber items
            const items = body.querySelectorAll('.dynamic-item');
            if (items.length === 0) {
                body.innerHTML = '<div class="dynamic-list-empty">No items added yet</div>';
            } else {
                items.forEach((item, index) => {
                    item.querySelector('.dynamic-item-number').textContent = index + 1;
                });
            }
        }

        // File Upload
        const fileInput = document.getElementById('fileInput');
        const fileList = document.getElementById('fileList');
        let uploadedFiles = [];

        fileInput.addEventListener('change', function(e) {
            const files = Array.from(e.target.files);
            
            files.forEach(file => {
                if (file.size > 10 * 1024 * 1024) {
                    showToast(`${file.name} is too large (max 10MB)`, 'error');
                    return;
                }
                uploadedFiles.push(file);
            });

            renderFileList();
        });

        function renderFileList() {
            fileList.innerHTML = uploadedFiles.map((file, index) => `
                <div class="file-item">
                    <div class="file-item-icon">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="16" height="16">
                            <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/>
                            <polyline points="14 2 14 8 20 8"/>
                        </svg>
                    </div>
                    <div class="file-item-info">
                        <div class="file-item-name">${file.name}</div>
                        <div class="file-item-size">${formatFileSize(file.size)}</div>
                    </div>
                    <button type="button" class="file-item-remove" onclick="removeFile(${index})">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="16" height="16">
                            <line x1="18" y1="6" x2="6" y2="18"/>
                            <line x1="6" y1="6" x2="18" y2="18"/>
                        </svg>
                    </button>
                </div>
            `).join('');
        }

        function removeFile(index) {
            uploadedFiles.splice(index, 1);
            renderFileList();
        }

        function formatFileSize(bytes) {
            if (bytes === 0) return '0 Bytes';
            const k = 1024;
            const sizes = ['Bytes', 'KB', 'MB', 'GB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
        }

        // Auto-generate CamelCase
        const nameInput = document.querySelector('input[name="name"]');
        const camelCaseInput = document.querySelector('input[name="camelCase"]');

        nameInput.addEventListener('input', function() {
            const name = this.value;
            const camelCase = name
                .split(' ')
                .map(word => word.charAt(0).toUpperCase() + word.slice(1).toLowerCase())
                .join('');
            camelCaseInput.value = camelCase;
        });

        // Set today's date as default for dateProposed
        document.querySelector('input[name="dateProposed"]').valueAsDate = new Date();

        // Review Summary
        function updateReviewSummary() {
            const form = document.getElementById('registryForm');
            const formData = new FormData(form);
            
            const summary = document.getElementById('reviewSummary');
            
            const name = formData.get('name') || '-';
            const domain = formData.get('domain') || '-';
            const itemType = formData.get('itemType') || '-';
            const definition = formData.get('definition') || '-';
            const proposalType = formData.get('proposalType') || '-';
            const submittingOrg = formData.get('submittingOrg') || '-';

            summary.innerHTML = `
                <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 16px;">
                    <div style="padding: 16px; background: var(--bg); border-radius: var(--radius);">
                        <div style="font-size: 12px; color: var(--text-muted); margin-bottom: 4px;">Name</div>
                        <div style="font-weight: 500;">${name}</div>
                    </div>
                    <div style="padding: 16px; background: var(--bg); border-radius: var(--radius);">
                        <div style="font-size: 12px; color: var(--text-muted); margin-bottom: 4px;">Domain</div>
                        <div style="font-weight: 500;">${domain}</div>
                    </div>
                    <div style="padding: 16px; background: var(--bg); border-radius: var(--radius);">
                        <div style="font-size: 12px; color: var(--text-muted); margin-bottom: 4px;">Item Type</div>
                        <div style="font-weight: 500;">${itemType}</div>
                    </div>
                    <div style="padding: 16px; background: var(--bg); border-radius: var(--radius);">
                        <div style="font-size: 12px; color: var(--text-muted); margin-bottom: 4px;">Proposal Type</div>
                        <div style="font-weight: 500;">${proposalType}</div>
                    </div>
                    <div style="padding: 16px; background: var(--bg); border-radius: var(--radius); grid-column: 1 / -1;">
                        <div style="font-size: 12px; color: var(--text-muted); margin-bottom: 4px;">Definition</div>
                        <div style="font-weight: 500;">${definition.substring(0, 200)}${definition.length > 200 ? '...' : ''}</div>
                    </div>
                    <div style="padding: 16px; background: var(--bg); border-radius: var(--radius); grid-column: 1 / -1;">
                        <div style="font-size: 12px; color: var(--text-muted); margin-bottom: 4px;">Submitting Organization</div>
                        <div style="font-weight: 500;">${submittingOrg}</div>
                    </div>
                </div>
            `;
        }

        // Form Submission
        document.getElementById('registryForm').addEventListener('submit', function(e) {
            e.preventDefault();
            
            if (validateCurrentStep()) {
                // Collect all form data
                const formData = new FormData(this);
                const data = Object.fromEntries(formData.entries());
                
                // Collect dynamic list items
                data.attributes = Array.from(document.querySelectorAll('#attributesList input')).map(i => i.value).filter(v => v);
                data.features = Array.from(document.querySelectorAll('#featuresList input')).map(i => i.value).filter(v => v);
                data.informations = Array.from(document.querySelectorAll('#informationsList input')).map(i => i.value).filter(v => v);
                data.files = uploadedFiles.map(f => f.name);

                console.log('Submitted data:', data);
                
                showToast('Item created successfully!', 'success');
                
                // Redirect after delay
                setTimeout(() => {
                    window.location.href = 'data-registry.html';
                }, 1500);
            }
        });

        // Save Draft
        document.getElementById('saveDraftBtn').addEventListener('click', function() {
            const formData = new FormData(document.getElementById('registryForm'));
            const data = Object.fromEntries(formData.entries());
            
            localStorage.setItem('registryDraft', JSON.stringify(data));
            showToast('Draft saved successfully!', 'success');
        });

        
        // Submit (Create DD Item)
        document.getElementById('registryForm').addEventListener('submit', async function(e) {
            e.preventDefault();

            const form = document.getElementById('registryForm');

            const registerId = (document.getElementById('registerSelect')?.value || '').trim();
            if (!registerId) {
                showToast('Please select a register (or create one).', 'warning');
                return;
            }

            const itemTypeRaw = (form.querySelector('[name="itemType"]')?.value || '').trim();
            const kind = (() => {
                const v = itemTypeRaw.toLowerCase();
                if (v.includes('attribute')) return 'attribute';
                if (v.includes('feature')) return 'feature';
                if (v.includes('information')) return 'information';
                if (v.includes('concept')) return 'concept';
                if (v.includes('enumer')) return 'enumeratedValue';
                return 'other';
            })();

            const status = (form.querySelector('input[name="status"]:checked')?.value || 'Draft').trim();

            const domain = (form.querySelector('[name="domain"]')?.value || '').trim();
            const remarks = (form.querySelector('[name="remarks"]')?.value || '').trim();
            const mergedRemarks = domain ? (`[domain=${domain}] ` + remarks).trim() : (remarks || null);

            const payload = {
                registerId,
                kind,
                itemIdentifier: parseInt((form.querySelector('[name="itemIdentifier"]')?.value || '0'), 10),
                name: (form.querySelector('[name="name"]')?.value || '').trim(),
                definition: (form.querySelector('[name="definition"]')?.value || '').trim() || null,
                remarks: mergedRemarks,
                itemStatus: status,
                camelCase: (form.querySelector('[name="camelCase"]')?.value || '').trim() || null,
                definitionSource: (form.querySelector('[name="referenceSource"]')?.value || '').trim() || null,
                reference: (form.querySelector('[name="reference"]')?.value || '').trim() || null,
                similarityToSource: (form.querySelector('[name="similarity"]')?.value || '').trim() || null,
                justification: (form.querySelector('[name="justification"]')?.value || '').trim() || null,
                proposedChange: (form.querySelector('[name="proposedChange"]')?.value || '').trim() || null,
                alias: []
            };

            if (!payload.name) {
                showToast('Name is required.', 'warning');
                return;
            }
            if (!payload.itemIdentifier || Number.isNaN(payload.itemIdentifier)) {
                showToast('Item Identifier is required (integer).', 'warning');
                return;
            }

            const res = await fetch('/api/dd/items', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json', 'Accept': 'application/json' },
                body: JSON.stringify(payload)
            });

            if (!res.ok) {
                const text = await res.text();
                showToast(`Submit failed: ${res.status} ${text}`, 'error');
                return;
            }

            showToast('Created successfully!', 'success');
            setTimeout(() => { window.location.href = '/ui/dd'; }, 700);
        });

// Load Draft on page load
        window.addEventListener('load', async function() {
            // Load Registers for dropdown
            try {
                const sel = document.getElementById('registerSelect');
                const res = await fetch('/api/registers?limit=200&sortBy=name&sortOrder=asc', { headers: { 'Accept':'application/json' }});
                if (res.ok) {
                    const data = await res.json();
                    const items = Array.isArray(data.items) ? data.items : [];
                    if (items.length === 0) {
                        sel.innerHTML = '<option value="">No registers (create one)</option>';
                    } else {
                        sel.innerHTML = items.map(r => `<option value="${r._id}">${r.name}</option>`).join('');
                    }
                } else {
                    sel.innerHTML = '<option value="">Failed to load registers</option>';
                }
            } catch (e) {
                const sel = document.getElementById('registerSelect');
                sel.innerHTML = '<option value="">Failed to load registers</option>';
            }


            const draft = localStorage.getItem('registryDraft');
            if (draft) {
                const data = JSON.parse(draft);
                Object.keys(data).forEach(key => {
                    const field = document.querySelector(`[name="${key}"]`);
                    if (field) {
                        field.value = data[key];
                    }
                });
            }
        });

        // Toast
        function showToast(message, type = 'success') {
            const toast = document.getElementById('toast');
            const toastMessage = document.getElementById('toastMessage');
            
            toast.className = 'toast ' + type;
            toastMessage.textContent = message;
            toast.classList.add('show');
            
            setTimeout(() => {
                toast.classList.remove('show');
            }, 3000);
        }

        // Initialize
        updateStepUI();
    </script>
</body>
</html>
