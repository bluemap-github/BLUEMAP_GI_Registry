<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Registers</title>
  <link rel="stylesheet" href="/static/style.css" />
</head>
<body class="page-register-list">
  <div class="container">
    <div class="page-header">
      <div class="breadcrumb">
        <a href="/">Home</a>
        <span>›</span>
        <span class="current">Registers</span>
      </div>
      <div class="title-row">
        <div>
          <div class="page-title">Registers</div>
          <div class="muted" style="margin-top:4px;">레지스터 목록을 관리합니다.</div>
        </div>
        <div class="actions">
          <a class="btn" href="/ui/dd">DD List</a>
          <a class="btn btn-primary" href="/ui/registers/new">+ New Register</a>
        </div>
      </div>
    </div>

    <div class="card">
      <div class="topbar">
        <div class="field">
          <div class="label">Search (name)</div>
          <input class="input" id="q" placeholder="예: S-100 Data Dictionary" />
        </div>
        <div class="actions" style="margin-left:auto;">
          <button class="btn" id="refreshBtn">Refresh</button>
        </div>
      </div>

      <div class="muted" id="summary" style="margin: 6px 0 12px 0;"></div>

      <div style="overflow:auto;">
        <table>
          <thead>
            <tr>
              <th style="min-width:240px;">Name</th>
              <th style="min-width:180px;">Operating Language</th>
              <th style="min-width:170px;">Date of Last Change</th>
              <th>Content Summary</th>
              <th class="right" style="min-width:140px;">Actions</th>
            </tr>
          </thead>
          <tbody id="tbody">
            <tr><td colspan="5" class="empty">Loading...</td></tr>
          </tbody>
        </table>
      </div>
    </div>
  </div>

<script>
  const tbody = document.getElementById('tbody');
  const summary = document.getElementById('summary');
  const qEl = document.getElementById('q');

  function fmtLang(loc){
    if(!loc) return '<span class="muted">-</span>';
    const parts = [];
    if(loc.language) parts.push(loc.language);
    if(loc.country) parts.push(loc.country);
    if(loc.characterEncoding) parts.push(loc.characterEncoding);
    return `<span class="pill">${parts.join('-') || '-'}</span>`;
  }
  function fmtDate(d){
    if(!d) return '<span class="muted">-</span>';
    // API might return ISO string
    return String(d).slice(0,10);
  }

  async function fetchRegisters(){
    const q = qEl.value.trim();
    const qs = new URLSearchParams();
    qs.set('page','1');
    qs.set('limit','200');
    if(q) qs.set('q', q);
    qs.set('sortBy','name');
    qs.set('sortOrder','asc');

    const res = await fetch(`/api/registers?${qs.toString()}`, { headers: { 'Accept':'application/json' }});
    if(!res.ok){
      const text = await res.text();
      throw new Error(`API error ${res.status}: ${text}`);
    }
    return await res.json();
  }

  function render(data){
    const items = Array.isArray(data.items) ? data.items : [];
    summary.textContent = `총 ${data.total ?? items.length}건`;

    if(items.length === 0){
      tbody.innerHTML = `<tr><td colspan="5" class="empty">No registers. <a class="link" href="/ui/registers/new">Create one</a></td></tr>`;
      return;
    }
    tbody.innerHTML = items.map(r => {
      const name = r.name ?? '-';
      const lang = fmtLang(r.operatingLanguage);
      const last = fmtDate(r.dateOfLastChange);
      const sum = r.contentSummary ? String(r.contentSummary) : '<span class="muted">-</span>';
      return `
        <tr>
          <td><strong>${name}</strong><div class="muted" style="font-size:12px;margin-top:2px;">id: ${r._id}</div></td>
          <td>${lang}</td>
          <td>${last}</td>
          <td>${sum}</td>
          <td class="right">
            <a class="btn" href="/ui/dd/new" title="Create DD Item">New Item</a>
          </td>
        </tr>
      `;
    }).join('');
  }

  async function refresh(){
    try{
      tbody.innerHTML = `<tr><td colspan="5" class="empty">Loading...</td></tr>`;
      const data = await fetchRegisters();
      render(data);
    }catch(e){
      tbody.innerHTML = `<tr><td colspan="5" class="empty">Error: ${e.message}</td></tr>`;
    }
  }

  document.getElementById('refreshBtn').addEventListener('click', refresh);
  qEl.addEventListener('keydown', (e)=>{ if(e.key==='Enter') refresh(); });

  refresh();
</script>
</body>
</html>
