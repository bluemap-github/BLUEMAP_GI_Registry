{% extends "base.html" %}

{% block title %}Registers{% endblock %}

{% block extra_styles %}
<style>
  *{margin:0;padding:0;box-sizing:border-box;}
  :root{
    --primary:#2563eb; --primary-hover:#1d4ed8;
    --bg:#f8fafc; --card-bg:#ffffff; --text:#1e293b; --text-muted:#64748b;
    --border:#e2e8f0; --radius:8px; --danger:#ef4444;
  }
  body{font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,'Helvetica Neue',Arial,sans-serif;background:var(--bg);color:var(--text);line-height:1.6;}
  .container{max-width:1200px;margin:0 auto;padding:24px;}
  .page-header{margin-bottom:18px;}
  .breadcrumb{display:flex;align-items:center;gap:8px;font-size:14px;color:var(--text-muted);margin-bottom:14px;}
  .breadcrumb a{color:var(--text-muted);text-decoration:none;}
  .breadcrumb a:hover{color:var(--primary);}
  .breadcrumb .current{color:var(--primary);font-weight:600;}
  .title-row{display:flex;align-items:center;justify-content:space-between;gap:12px;}
  .page-title{font-size:28px;font-weight:800;}
  .actions{display:flex;gap:10px;flex-wrap:wrap;}
  .btn{display:inline-flex;align-items:center;gap:8px;padding:10px 14px;border-radius:10px;border:1px solid var(--border);background:#fff;color:var(--text);cursor:pointer;text-decoration:none;font-weight:600;font-size:14px;}
  .btn:hover{border-color:#cbd5e1;}
  .btn-primary{background:var(--primary);border-color:var(--primary);color:#fff;}
  .btn-primary:hover{background:var(--primary-hover);border-color:var(--primary-hover);}
  .card{background:var(--card-bg);border:1px solid var(--border);border-radius:12px;padding:18px;}
  .topbar{display:flex;gap:12px;flex-wrap:wrap;align-items:flex-end;margin-bottom:14px;}
  .field{display:flex;flex-direction:column;gap:6px;min-width:240px;}
  .label{font-size:13px;color:var(--text-muted);font-weight:600;}
  .input{padding:10px 12px;border:1px solid var(--border);border-radius:10px;outline:none;}
  .input:focus{border-color:var(--primary);box-shadow:0 0 0 3px rgba(37,99,235,.12);}
  table{width:100%;border-collapse:separate;border-spacing:0;}
  th,td{padding:12px 10px;border-bottom:1px solid var(--border);text-align:left;font-size:14px;vertical-align:top;}
  th{font-size:13px;color:var(--text-muted);font-weight:700;background:#f1f5f9;}
  tr:hover td{background:#fafafa;}
  .muted{color:var(--text-muted);}
  .pill{display:inline-flex;align-items:center;padding:4px 10px;border-radius:999px;border:1px solid var(--border);font-size:12px;color:var(--text-muted);background:#fff;}
  .right{text-align:right;}
  .empty{padding:28px;text-align:center;color:var(--text-muted);}
  .link{color:var(--primary);text-decoration:none;font-weight:700;}
  .link:hover{text-decoration:underline;}
</style>
{% endblock %}

{% block content %}
<div class="container">
  <div class="page-header">
    <div class="breadcrumb">
      <a href="/">Home</a>
      <span>/</span>
      <span class="current">Registers</span>
    </div>
    <div class="title-row">
      <div>
        <div class="page-title">Registers</div>
        <div class="muted" style="margin-top:4px;">Manage register list.</div>
      </div>
      <div class="actions">
        <a class="btn" href="/ui/dd">DD List</a>
        <a class="btn btn-primary" href="/ui/registers/new">+ New Register</a>
      </div>
    </div>
  </div>

  <div class="card">
    <div class="topbar">
      <div class="field">
        <div class="label">Search (name)</div>
        <input class="input" id="q" placeholder="e.g., S-100 Data Dictionary" />
      </div>
      <div class="actions" style="margin-left:auto;">
        <button class="btn" id="refreshBtn">Refresh</button>
      </div>
    </div>

    <div class="muted" id="summary" style="margin: 6px 0 12px 0;"></div>

    <div style="overflow:auto;">
      <table>
        <thead>
          <tr>
            <th style="min-width:240px;">Name</th>
            <th style="min-width:180px;">Operating Language</th>
            <th style="min-width:170px;">Date of Last Change</th>
            <th>Content Summary</th>
            <th class="right" style="min-width:140px;">Actions</th>
          </tr>
        </thead>
        <tbody id="tbody">
          <tr><td colspan="5" class="empty">Loading...</td></tr>
        </tbody>
      </table>
    </div>
  </div>
</div>
{% endblock %}

{% block extra_scripts %}
<script>
  const tbody = document.getElementById('tbody');
  const summary = document.getElementById('summary');
  const qEl = document.getElementById('q');

  function fmtLang(loc){
    if(!loc) return '<span class="muted">-</span>';
    const parts = [];
    if(loc.language) parts.push(loc.language);
    if(loc.country) parts.push(loc.country);
    if(loc.characterEncoding) parts.push(loc.characterEncoding);
    return `<span class="pill">${parts.join('-') || '-'}</span>`;
  }
  function fmtDate(d){
    if(!d) return '<span class="muted">-</span>';
    return String(d).slice(0,10);
  }

  async function fetchRegisters(){
    const q = qEl.value.trim();
    const qs = new URLSearchParams();
    qs.set('page','1');
    qs.set('limit','200');
    if(q) qs.set('q', q);
    qs.set('sortBy','name');
    qs.set('sortOrder','asc');

    const res = await fetch(`/api/registers?${qs.toString()}`, { headers: { 'Accept':'application/json' }});
    if(!res.ok){
      const text = await res.text();
      throw new Error(`API error ${res.status}: ${text}`);
    }
    return await res.json();
  }

  function render(data){
    const items = Array.isArray(data.items) ? data.items : [];
    summary.textContent = `Total ${data.total ?? items.length} items`;

    if(items.length === 0){
      tbody.innerHTML = `<tr><td colspan="5" class="empty">No registers. <a class="link" href="/ui/registers/new">Create one</a></td></tr>`;
      return;
    }
    tbody.innerHTML = items.map(r => {
      const name = r.name ?? '-';
      const lang = fmtLang(r.operatingLanguage);
      const last = fmtDate(r.dateOfLastChange);
      const sum = r.contentSummary ? String(r.contentSummary) : '<span class="muted">-</span>';
      return `
        <tr>
          <td><strong>${name}</strong><div class="muted" style="font-size:12px;margin-top:2px;">id: ${r._id}</div></td>
          <td>${lang}</td>
          <td>${last}</td>
          <td>${sum}</td>
          <td class="right">
            <a class="btn" href="/ui/dd/new" title="Create DD Item">New Item</a>
          </td>
        </tr>
      `;
    }).join('');
  }

  async function refresh(){
    try{
      tbody.innerHTML = `<tr><td colspan="5" class="empty">Loading...</td></tr>`;
      const data = await fetchRegisters();
      render(data);
    }catch(e){
      tbody.innerHTML = `<tr><td colspan="5" class="empty">Error: ${e.message}</td></tr>`;
    }
  }

  document.getElementById('refreshBtn').addEventListener('click', refresh);
  qEl.addEventListener('keydown', (e)=>{ if(e.key==='Enter') refresh(); });

  refresh();
</script>
{% endblock %}
