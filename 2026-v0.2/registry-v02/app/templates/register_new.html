<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>New Register</title>
  <link rel="stylesheet" href="{{ url_for('static', path='style.css') }}">
</head>
<body>
  <div class="container">
    <div class="breadcrumb">
      <a href="/">Home</a>
      <span>›</span>
      <a href="/ui/registers">Registers</a>
      <span>›</span>
      <span class="current">New</span>
    </div>

    <div class="header">
      <div>
        <div class="title">New Register</div>
        <div class="muted">S100_RE_Register 생성</div>
      </div>
      <a class="btn" href="/ui/registers">Back</a>
    </div>

    <div class="card">
      <form id="form">
        <div class="grid">
          <div class="field full">
            <div class="label">Name <span style="color:#ef4444">*</span></div>
            <input class="input" name="name" required placeholder="예: S-100 Data Dictionary (Demo)" />
            <div class="hint">레지스터 이름(유니크) 권장</div>
          </div>

          <div class="field">
            <div class="label">Operating Language - language</div>
            <input class="input" name="lang" placeholder="en" />
          </div>
          <div class="field">
            <div class="label">Operating Language - country</div>
            <input class="input" name="country" placeholder="GB" />
          </div>
          <div class="field full">
            <div class="label">Operating Language - characterEncoding</div>
            <input class="input" name="encoding" placeholder="utf-8" />
          </div>

          <div class="field full">
            <div class="label">Content Summary</div>
            <textarea class="textarea" name="contentSummary" placeholder="간단 설명"></textarea>
          </div>

          <div class="field full">
            <div class="label">Uniform Resource Identifier - linkage</div>
            <input class="input" name="linkage" placeholder="https://example.org/register/dd" />
          </div>
          <div class="field">
            <div class="label">URI - protocol</div>
            <input class="input" name="protocol" placeholder="https" />
          </div>
          <div class="field">
            <div class="label">URI - name</div>
            <input class="input" name="uriName" placeholder="DD Register" />
          </div>
        </div>

        <div class="row">
          <button type="button" class="btn" id="seedBtn">Quick Fill</button>
          <button type="submit" class="btn btn-primary">Create</button>
        </div>
      </form>
    </div>
  </div>

  <div class="toast" id="toast"></div>

<script>
  const form = document.getElementById('form');
  const toast = document.getElementById('toast');

  function showToast(msg){
    toast.textContent = msg;
    toast.classList.add('show');
    setTimeout(()=>toast.classList.remove('show'), 2600);
  }

  document.getElementById('seedBtn').addEventListener('click', ()=>{
    form.name.value = form.name.value || 'S-100 Data Dictionary (Demo)';
    form.lang.value = form.lang.value || 'en';
    form.country.value = form.country.value || 'GB';
    form.encoding.value = form.encoding.value || 'utf-8';
    form.contentSummary.value = form.contentSummary.value || 'Demo register for DD items';
    form.linkage.value = form.linkage.value || 'https://example.org/register/dd';
    form.protocol.value = form.protocol.value || 'https';
    form.uriName.value = form.uriName.value || 'DD Register';
    showToast('Filled sample values');
  });

  form.addEventListener('submit', async (e)=>{
    e.preventDefault();

    const payload = {
      name: form.name.value.trim(),
      operatingLanguage: (form.lang.value.trim() || form.country.value.trim() || form.encoding.value.trim()) ? {
        language: form.lang.value.trim() || 'en',
        country: form.country.value.trim() || null,
        characterEncoding: form.encoding.value.trim() || null
      } : null,
      contentSummary: form.contentSummary.value.trim() || null,
      uniformResourceIdentifier: form.linkage.value.trim() ? {
        linkage: form.linkage.value.trim(),
        protocol: form.protocol.value.trim() || null,
        name: form.uriName.value.trim() || null
      } : null
    };

    const res = await fetch('/api/registers', {
      method: 'POST',
      headers: {'Content-Type':'application/json', 'Accept':'application/json'},
      body: JSON.stringify(payload)
    });

    if(!res.ok){
      const text = await res.text();
      showToast(`Create failed: ${res.status} ${text}`);
      return;
    }

    showToast('Created! Redirecting...');
    setTimeout(()=>{ window.location.href = '/ui/registers'; }, 600);
  });
</script>
</body>
</html>
